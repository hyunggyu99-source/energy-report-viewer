<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Annual Building Systems Analysis</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <style>
    :root {
      --bg: #f5f7fa;
      --card: #ffffff;
      --text: #1a1a2e;
      --text-secondary: #6b7280;
      --primary: #2563eb;
      --primary-light: #dbeafe;
      --accent: #f59e0b;
      --border: #e5e7eb;
      --success: #10b981;
      --danger: #ef4444;
      --heating: #ef4444;
      --cooling: #3b82f6;
      --lighting: #f59e0b;
      --equipment: #6b7280;
      --fans: #ec4899;
      --pumps: #8b5cf6;
      --other: #14b8a6;
      --shadow: 0 1px 3px rgba(0,0,0,.1), 0 1px 2px rgba(0,0,0,.06);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -1px rgba(0,0,0,.06);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05);
      --radius: 12px;
      --radius-sm: 8px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* HEADER */
    .header {
      background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 100%);
      color: white;
      padding: 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-lg);
    }
    .header-inner {
      max-width: 1400px;
      margin: 0 auto;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }
    .header-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .header-title h1 {
      font-size: 1.25rem;
      font-weight: 700;
      letter-spacing: -0.02em;
    }
    .header-title .logo {
      width: 36px; height: 36px;
      background: rgba(255,255,255,.2);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    .header-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* BUTTONS & TOGGLES */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 14px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(255,255,255,.3);
      background: rgba(255,255,255,.1);
      color: white;
      font-size: .85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all .2s;
      white-space: nowrap;
    }
    .btn:hover { background: rgba(255,255,255,.25); }
    .btn.active { background: rgba(255,255,255,.35); border-color: white; }
    .btn-primary {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: var(--radius-sm);
      font-size: .9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all .2s;
    }
    .btn-primary:hover { background: #1d4ed8; transform: translateY(-1px); }
    .btn-outline {
      background: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
      padding: 10px 20px;
      border-radius: var(--radius-sm);
      font-size: .9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all .2s;
    }
    .btn-outline:hover { background: var(--primary-light); }

    .toggle-group {
      display: flex;
      background: rgba(0,0,0,.2);
      border-radius: 6px;
      overflow: hidden;
    }
    .toggle-group .btn {
      border: none;
      border-radius: 0;
      padding: 6px 12px;
      font-size: .8rem;
    }
    .toggle-group .btn.active {
      background: rgba(255,255,255,.3);
    }

    /* MAIN */
    .main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    /* DROP ZONE */
    .drop-zone-wrapper {
      margin-bottom: 24px;
    }
    .drop-zone {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 48px 24px;
      text-align: center;
      transition: all .3s;
      background: var(--card);
      cursor: pointer;
    }
    .drop-zone.dragover {
      border-color: var(--primary);
      background: var(--primary-light);
    }
    .drop-zone.has-files {
      padding: 16px 24px;
      border-style: solid;
    }
    .drop-zone-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: .6;
    }
    .drop-zone h3 { font-size: 1.1rem; margin-bottom: 4px; }
    .drop-zone p { color: var(--text-secondary); font-size: .9rem; }

    .file-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
      justify-content: center;
    }
    .file-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--primary-light);
      border: 1px solid var(--primary);
      border-radius: 20px;
      font-size: .82rem;
      font-weight: 500;
      color: var(--primary);
    }
    .file-chip .remove {
      cursor: pointer;
      font-size: 1.1rem;
      line-height: 1;
      opacity: .6;
    }
    .file-chip .remove:hover { opacity: 1; }
    .file-chip.active-chip {
      background: var(--primary);
      color: white;
    }

    /* TABS */
    .tab-bar {
      display: flex;
      gap: 4px;
      margin-bottom: 24px;
      border-bottom: 2px solid var(--border);
      overflow-x: auto;
    }
    .tab-btn {
      padding: 10px 20px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      font-size: .9rem;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all .2s;
      white-space: nowrap;
      margin-bottom: -2px;
    }
    .tab-btn:hover { color: var(--text); }
    .tab-btn.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      font-weight: 600;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* CARDS */
    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 24px;
      margin-bottom: 20px;
    }
    .card-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-title .icon { font-size: 1.2rem; }

    /* STAT GRID */
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 20px 16px 16px;
      box-shadow: var(--shadow);
      text-align: center;
      position: relative;
      overflow: hidden;
      border: 1px solid var(--border);
    }
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 4px;
    }
    .stat-card.total { background: linear-gradient(180deg, #f8fafc 0%, #fff 100%); }
    .stat-card.total::before { background: linear-gradient(90deg, #334155, #64748b); }
    .stat-card.heating { background: linear-gradient(180deg, #fff5f5 0%, #fff 100%); }
    .stat-card.heating::before { background: linear-gradient(90deg, #dc2626, #f87171); }
    .stat-card.cooling { background: linear-gradient(180deg, #eff6ff 0%, #fff 100%); }
    .stat-card.cooling::before { background: linear-gradient(90deg, #1d4ed8, #60a5fa); }
    .stat-card.eui { background: linear-gradient(180deg, #f5f3ff 0%, #fff 100%); }
    .stat-card.eui::before { background: linear-gradient(90deg, #7c3aed, #a78bfa); }
    .stat-card.area { background: linear-gradient(180deg, #ecfdf5 0%, #fff 100%); }
    .stat-card.area::before { background: linear-gradient(90deg, #059669, #34d399); }
    .stat-card .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--text);
      line-height: 1.2;
    }
    .stat-card .stat-label {
      font-size: .8rem;
      color: var(--text-secondary);
      margin-top: 4px;
    }
    .stat-card .stat-unit {
      font-size: .75rem;
      color: var(--text-secondary);
    }

    /* CHART */
    .chart-container {
      position: relative;
      height: 360px;
      width: 100%;
    }
    .chart-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    @media (max-width: 900px) {
      .chart-row { grid-template-columns: 1fr; }
    }

    /* TABLE */
    .table-wrap {
      overflow-x: auto;
    }
    table.data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: .85rem;
    }
    table.data-table th, table.data-table td {
      padding: 10px 12px;
      text-align: right;
      border-bottom: 1px solid var(--border);
    }
    table.data-table th {
      background: #f9fafb;
      font-weight: 600;
      color: var(--text-secondary);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    table.data-table th:first-child,
    table.data-table td:first-child {
      text-align: left;
      font-weight: 500;
      position: sticky;
      left: 0;
      background: inherit;
      z-index: 2;
    }
    table.data-table tr:hover td { background: #f0f4ff; }
    table.data-table .total-row { font-weight: 700; background: #f9fafb; }
    table.data-table .month-highlight th,
    table.data-table .month-highlight td { background: #eff6ff !important; }
    table.data-table th.month-col-highlight,
    table.data-table td.month-col-highlight {
      background: #dbeafe !important;
      box-shadow: inset 0 0 0 1px #93c5fd;
      transition: background .15s, box-shadow .15s;
    }
    table.data-table th.month-col-locked,
    table.data-table td.month-col-locked {
      background: #bfdbfe !important;
      box-shadow: inset 0 0 0 2px #3b82f6;
      font-weight: 700;
      transition: background .15s, box-shadow .15s;
    }
    table.data-table td.empty-cell { color: #d1d5db; }

    /* CUSTOM CHECKBOX LEGEND */
    .chart-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 14px;
      justify-content: center;
      padding: 8px 0 4px;
      font-size: .82rem;
    }
    .chart-legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      padding: 3px 8px;
      border-radius: 6px;
      transition: background .15s, opacity .15s;
      user-select: none;
    }
    .chart-legend-item:hover {
      background: #f1f5f9;
    }
    .chart-legend-item.hidden {
      opacity: .4;
    }
    .chart-legend-item .legend-checkbox {
      width: 16px; height: 16px;
      border-radius: 4px;
      border: 2px solid currentColor;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background .15s, border-color .15s;
    }
    .chart-legend-item .legend-checkbox svg {
      width: 10px; height: 10px;
      fill: none;
      stroke: white;
      stroke-width: 2.5;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    .chart-legend-item:not(.hidden) .legend-checkbox {
      background: currentColor;
    }
    .chart-legend-item.hidden .legend-checkbox {
      background: transparent;
    }
    .chart-legend-item.hidden .legend-checkbox svg {
      display: none;
    }
    .chart-legend-item .legend-label {
      color: var(--text);
      font-weight: 500;
      white-space: nowrap;
    }
    .chart-legend-item.hidden .legend-label {
      color: var(--text-secondary);
      text-decoration: line-through;
    }

    /* SCROLL TO TOP BUTTON */
    .scroll-top-btn {
      position: fixed;
      bottom: 32px;
      right: 32px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      border: none;
      font-size: 1.3rem;
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(59,130,246,.35);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transform: translateY(12px);
      transition: opacity .3s, transform .3s, background .2s;
      z-index: 999;
    }
    .scroll-top-btn.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }
    .scroll-top-btn:hover {
      background: #2563eb;
      box-shadow: 0 6px 20px rgba(59,130,246,.45);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* FLOATING SECTION NAV */
    .section-nav {
      position: fixed;
      bottom: 90px;
      right: 32px;
      z-index: 998;
      display: flex;
      flex-direction: column;
      gap: 4px;
      opacity: 0;
      pointer-events: none;
      transform: translateX(12px);
      transition: opacity .3s, transform .3s;
    }
    .section-nav.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(0);
    }
    .section-nav-toggle {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: white;
      border: 1px solid var(--border);
      box-shadow: 0 3px 12px rgba(0,0,0,.1);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      color: var(--text-secondary);
      transition: all .2s;
      align-self: flex-end;
    }
    .section-nav-toggle:hover {
      background: var(--primary-light);
      border-color: var(--primary);
      color: var(--primary);
    }
    .section-nav-panel {
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 6px 24px rgba(0,0,0,.12);
      padding: 8px 6px;
      max-height: 0;
      overflow: hidden;
      transition: max-height .3s ease, padding .3s ease, opacity .3s;
      opacity: 0;
    }
    .section-nav-panel.open {
      max-height: 300px;
      padding: 10px 8px;
      opacity: 1;
    }
    .section-nav-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 12px;
      border-radius: 8px;
      font-size: .8rem;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all .15s;
      white-space: nowrap;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }
    .section-nav-item:hover {
      background: var(--primary-light);
      color: var(--primary);
    }
    .section-nav-item.active {
      background: #dbeafe;
      color: var(--primary);
      font-weight: 600;
    }
    .section-nav-item .nav-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--border);
      flex-shrink: 0;
      transition: background .15s;
    }
    .section-nav-item.active .nav-dot,
    .section-nav-item:hover .nav-dot {
      background: var(--primary);
    }

    /* COMPARISON */
    .compare-selector {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      align-items: center;
    }
    .compare-selector select {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: .9rem;
      background: white;
      min-width: 200px;
    }
    .compare-label {
      font-weight: 600;
      font-size: .9rem;
      color: var(--text-secondary);
    }

    /* DATA EXPORT PANEL */
    .api-panel {
      background: #1e293b;
      border-radius: var(--radius);
      padding: 20px;
      color: #e2e8f0;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: .82rem;
      overflow-x: auto;
      position: relative;
    }
    .api-panel pre { white-space: pre-wrap; word-break: break-word; }
    .copy-btn {
      position: absolute;
      top: 12px; right: 12px;
      background: rgba(255,255,255,.1);
      border: 1px solid rgba(255,255,255,.2);
      color: white;
      padding: 4px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: .78rem;
    }
    .copy-btn:hover { background: rgba(255,255,255,.2); }

    /* EMPTY STATE */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }
    .empty-state .icon { font-size: 64px; margin-bottom: 16px; opacity: .4; }
    .empty-state h3 { font-size: 1.2rem; margin-bottom: 8px; color: var(--text); }

    /* BUILDING INFO */
    .building-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }
    .info-item {
      padding: 12px;
      background: #f9fafb;
      border-radius: var(--radius-sm);
    }
    .info-item .label { font-size: .75rem; color: var(--text-secondary); font-weight: 500; text-transform: uppercase; letter-spacing: .05em; }
    .info-item .value { font-size: .95rem; font-weight: 600; margin-top: 2px; }

    /* COLOR DOT */
    .dot {
      display: inline-block;
      width: 10px; height: 10px;
      border-radius: 50%;
      margin-right: 6px;
    }

    /* INSIGHTS */
    .insight-list { list-style: none; }
    .insight-list li {
      padding: 10px 12px;
      border-left: 3px solid var(--primary);
      margin-bottom: 8px;
      background: #f0f4ff;
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
      font-size: .88rem;
    }
    .insight-list li.warning { border-color: var(--accent); background: #fffbeb; }
    .insight-list li.danger { border-color: var(--danger); background: #fef2f2; }
    .insight-list li.success { border-color: var(--success); background: #ecfdf5; }

    /* ZONE EXPLORER */
    .zone-card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    .zone-card {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      cursor: pointer;
      transition: all .2s;
      position: relative;
    }
    .zone-card:hover { border-color: var(--primary); box-shadow: var(--shadow-md); transform: translateY(-2px); }
    .zone-card.active { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,.15); }
    .zone-card .zone-name { font-weight: 700; font-size: .95rem; margin-bottom: 6px; color: var(--text); }
    .zone-card .zone-meta { font-size: .78rem; color: var(--text-secondary); line-height: 1.5; }
    .zone-card .zone-badge {
      position: absolute; top: 10px; right: 10px;
      font-size: .7rem; padding: 2px 8px; border-radius: 10px; font-weight: 600;
    }
    .zone-badge.cond { background: #dbeafe; color: #1e40af; }
    .zone-badge.uncond { background: #f3f4f6; color: #6b7280; }
    .zone-card .zone-check {
      position: absolute; bottom: 10px; right: 10px;
      width: 22px; height: 22px; border-radius: 6px;
      border: 2px solid var(--border); background: white;
      display: flex; align-items: center; justify-content: center;
      transition: all .15s; cursor: pointer; z-index: 2;
    }
    .zone-card .zone-check svg { width: 14px; height: 14px; fill: none; stroke: white; stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round; display: none; }
    .zone-card.selected .zone-check { background: var(--primary); border-color: var(--primary); }
    .zone-card.selected .zone-check svg { display: block; }
    .zone-card.selected { border-color: var(--primary); background: #f0f7ff; }
    .zone-compare-bar {
      position: sticky; bottom: 0; left: 0; right: 0; z-index: 10;
      background: white; border-top: 2px solid var(--primary);
      box-shadow: 0 -4px 20px rgba(0,0,0,.1);
      padding: 12px 24px;
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
      flex-wrap: wrap; animation: slideUp .2s ease;
    }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .zone-compare-bar .selected-tags { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
    .zone-compare-bar .zone-tag {
      display: inline-flex; align-items: center; gap: 4px;
      background: #eff6ff; color: var(--primary); border: 1px solid #bfdbfe;
      padding: 3px 10px; border-radius: 20px; font-size: .78rem; font-weight: 600;
    }
    .zone-compare-bar .zone-tag .tag-remove {
      cursor: pointer; font-size: .9rem; line-height: 1; opacity: .6;
    }
    .zone-compare-bar .zone-tag .tag-remove:hover { opacity: 1; }
    .zone-compare-bar .zone-tag .tag-dot {
      width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
    }
    .zone-report-banner {
      display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
      padding: 10px 20px; margin-bottom: 12px;
      border-radius: var(--radius-sm);
      font-size: .82rem; font-weight: 600;
    }
    .zone-report-banner .report-dot {
      width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
    }
    .zone-report-banner .switch-link {
      font-weight: 500; cursor: pointer; text-decoration: underline;
      text-underline-offset: 2px;
    }
    .zone-report-banner .switch-link:hover { opacity: .8; }

    .zone-detail-section {
      background: var(--card);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
    }
    .zone-detail-section h3 {
      font-size: 1rem; font-weight: 700; margin-bottom: 12px;
      padding-bottom: 8px; border-bottom: 2px solid var(--primary-light);
    }
    .zone-detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
    }
    .zone-info-item {
      background: #f9fafb; border-radius: 8px; padding: 12px;
    }
    .zone-info-item .label { font-size: .75rem; color: var(--text-secondary); font-weight: 500; margin-bottom: 2px; }
    .zone-info-item .value { font-size: 1.05rem; font-weight: 700; color: var(--text); }
    .zone-info-item .unit { font-size: .75rem; color: var(--text-secondary); font-weight: 400; margin-left: 2px; }
    .zone-info-item .explain { font-size: .72rem; color: var(--text-secondary); margin-top: 4px; line-height: 1.3; }
    .zone-bar { height: 8px; border-radius: 4px; background: var(--border); margin-top: 6px; overflow: hidden; }
    .zone-bar-fill { height: 100%; border-radius: 4px; }

    /* API SUB-TABS */
    .api-subtab {
      padding: 8px 18px;
      border: 1px solid var(--border);
      background: white;
      border-radius: 20px;
      font-size: .82rem;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all .2s;
      font-weight: 500;
    }
    .api-subtab:hover { border-color: var(--primary); color: var(--primary); }
    .api-subtab.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    .warmup-badge {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 14px; border-radius: 20px; font-size: .82rem; font-weight: 600;
    }
    .warmup-badge.pass { background: #d1fae5; color: #065f46; }
    .warmup-badge.fail { background: #fee2e2; color: #991b1b; }

    /* DATA CONTEXT */
    #dataContextCard p { margin-bottom: 6px; }
    #dataContextCard b { color: var(--text); }

    /* FOOTER */
    .footer {
      text-align: center;
      padding: 24px;
      color: var(--text-secondary);
      font-size: .8rem;
      border-top: 1px solid var(--border);
      margin-top: 40px;
    }

    /* Print */
    @media print {
      .header { position: static; }
      .drop-zone-wrapper, .header-controls { display: none; }
      .card { break-inside: avoid; }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header-inner { padding: 10px 16px; }
      .main { padding: 16px; }
      .stat-grid { grid-template-columns: repeat(2, 1fr); }
      .chart-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <div class="header-title">
      <div class="logo">&#9889;</div>
      <h1 id="appTitle">Annual Building Systems Analysis</h1>
    </div>
    <div class="header-controls">
      <div class="toggle-group" id="langToggle">
        <button class="btn active" data-lang="en" onclick="setLang('en')">EN</button>
        <button class="btn" data-lang="ko" onclick="setLang('ko')">KO</button>
      </div>
      <div class="toggle-group" id="unitToggle">
        <button class="btn active" data-unit="ip" onclick="setUnit('ip')">IP</button>
        <button class="btn" data-unit="si" onclick="setUnit('si')">SI</button>
      </div>
      <button class="btn" id="exportJsonBtn" onclick="exportJSON()" style="display:none">
        &#128190; JSON
      </button>
      <button class="btn" id="exportCsvBtn" onclick="exportCSV()" style="display:none">
        &#128196; CSV
      </button>
    </div>
  </div>
</div>

<div class="main">
  <!-- DROP ZONE -->
  <div class="drop-zone-wrapper">
    <div class="drop-zone" id="dropZone">
      <div class="drop-zone-icon">&#128194;</div>
      <h3 id="dropTitle">Drop Annual Building Systems HTM Report Here</h3>
      <p id="dropSubtitle">or click to browse &mdash; supports multiple files for comparison (not for HVAC reports)</p>
      <input type="file" id="fileInput" accept=".htm,.html" multiple hidden>
      <div class="file-chips" id="fileChips"></div>
    </div>
  </div>

  <!-- CONTENT (hidden until files loaded) -->
  <div id="appContent" style="display:none">
    <!-- TAB BAR -->
    <div class="tab-bar" id="tabBar">
      <button class="tab-btn active" data-tab="overview" onclick="switchTab('overview')" id="tabOverview">Overview</button>
      <button class="tab-btn" data-tab="monthly" onclick="cameFromCompare=false;switchTab('monthly')" id="tabMonthly">Monthly Analysis</button>
      <button class="tab-btn" data-tab="compare" onclick="switchTab('compare')" id="tabCompare">Comparison</button>
      <button class="tab-btn" data-tab="details" onclick="switchTab('details')" id="tabDetails">Building Details</button>
      <button class="tab-btn" data-tab="zones" onclick="cameFromZoneCompare=false;switchTab('zones')" id="tabZones">Zone Explorer</button>
      <button class="tab-btn" data-tab="insights" onclick="switchTab('insights')" id="tabInsights">Insights</button>
      <button class="tab-btn" data-tab="api" onclick="switchTab('api')" id="tabApi">Developer API</button>
    </div>

    <!-- TAB: OVERVIEW -->
    <div class="tab-content active" id="tab-overview">
      <div class="stat-grid" id="statGrid"></div>
      <div class="chart-row">
        <div class="card">
          <div class="card-title"><span class="icon">&#127793;</span> <span data-i18n="endUseBreakdown">End-Use Energy Breakdown</span></div>
          <div class="chart-container"><canvas id="endUsePieChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-title"><span class="icon">&#9889;</span> <span data-i18n="fuelBreakdown">Energy by Fuel Type</span></div>
          <div class="chart-container"><canvas id="fuelBarChart"></canvas></div>
          <p id="fuelBarHint" style="text-align:center;font-size:.75rem;color:var(--primary);margin:4px 0 0;opacity:.7">Click a fuel to see monthly details &rarr;</p>
        </div>
      </div>
      <div class="card">
        <div class="card-title"><span class="icon">&#128200;</span> <span data-i18n="monthlyTrend">Monthly Energy Trend</span></div>
        <div id="legendMonthlyTrend" class="chart-legend"></div>
        <div class="chart-container" style="height:300px"><canvas id="monthlyTrendChart"></canvas></div>
      </div>
    </div>

    <!-- TAB: MONTHLY -->
    <div class="tab-content" id="tab-monthly">
      <div class="card" style="padding:16px 24px;margin-bottom:16px">
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
          <button class="btn-outline" onclick="switchTab('overview')" style="font-size:.82rem;padding:5px 14px" id="monthlyBackBtn">&#8592; Overview</button>
          <button class="btn-outline" onclick="switchTab('compare')" style="font-size:.82rem;padding:5px 14px;display:none;border-color:#8b5cf6;color:#8b5cf6" id="monthlyBackCompareBtn">Compare &#8594;</button>
          <span style="font-weight:600;font-size:.9rem;color:var(--text-secondary)" data-i18n="fuelSelectLabel">Fuel Type</span>
          <select id="monthlyFuelSelect" onchange="renderMonthlyTab()" style="padding:8px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:.9rem;background:white;min-width:180px"></select>
        </div>
      </div>
      <div class="card" id="monthlyStackedCard">
        <div class="card-title"><span class="icon">&#128200;</span> <span data-i18n="monthlyStackedChart">Monthly Energy by End Use</span></div>
        <div id="legendMonthlyStacked" class="chart-legend"></div>
        <div class="chart-container" style="height:400px"><canvas id="monthlyStackedChart"></canvas></div>
      </div>
      <div class="card" id="monthlyPeakCard">
        <div class="card-title"><span class="icon">&#128202;</span> <span data-i18n="monthlyPeakChart">Monthly Peak Demand</span></div>
        <div id="legendMonthlyPeak" class="chart-legend"></div>
        <div class="chart-container" style="height:350px"><canvas id="monthlyPeakChart"></canvas></div>
      </div>
      <div class="card" id="monthlyTableCard">
        <div class="card-title"><span class="icon">&#128203;</span> <span data-i18n="monthlyTable">Monthly Data Table</span></div>
        <div class="table-wrap" id="monthlyTableWrap"></div>
      </div>
      <div class="card" id="dataContextCard" style="background:#f8fafc;border-left:4px solid var(--primary)">
        <div class="card-title"><span class="icon">&#128161;</span> <span data-i18n="dataContextTitle">Understanding This Data</span></div>
        <div id="dataContextContent" style="font-size:.88rem;color:var(--text-secondary);line-height:1.7"></div>
      </div>
    </div>

    <!-- TAB: COMPARE -->
    <div class="tab-content" id="tab-compare">
      <div class="api-subtabs" style="display:flex;gap:4px;margin-bottom:16px;flex-wrap:wrap">
        <button class="api-subtab active" onclick="switchCompareSub('energy')" id="cmpSubEnergy">Energy Comparison</button>
        <button class="api-subtab" onclick="switchCompareSub('zone')" id="cmpSubZone">Zone Comparison</button>
      </div>
      <div class="cmp-sub-content" id="cmpSub-energy">
        <div id="compareContent"></div>
      </div>
      <div class="cmp-sub-content" id="cmpSub-zone" style="display:none">
        <div id="zoneCompareContent"></div>
      </div>
    </div>

    <!-- TAB: DETAILS -->
    <div class="tab-content" id="tab-details">
      <div class="card" id="buildingInfoCard">
        <div class="card-title"><span class="icon">&#127970;</span> <span data-i18n="buildingInfo">Building Information</span></div>
        <div class="building-info" id="buildingInfo"></div>
      </div>
      <div class="card" id="endUseDetailCard">
        <div class="card-title"><span class="icon">&#128295;</span> <span data-i18n="endUseDetail">Detailed End Use by Fuel</span></div>
        <div class="table-wrap" id="endUseDetailTable"></div>
      </div>
      <div class="card" id="zoneSummaryCard">
        <div class="card-title"><span class="icon">&#127968;</span> <span data-i18n="zoneSummary">Zone Summary</span></div>
        <div class="table-wrap" id="zoneSummaryTable"></div>
      </div>
      <div class="card" id="comfortSummaryCard">
        <div class="card-title"><span class="icon">&#128295;</span> <span data-i18n="comfortSummary">Comfort & Setpoint Summary</span></div>
        <div class="table-wrap" id="comfortSummaryDiv"></div>
      </div>
    </div>

    <!-- TAB: ZONE EXPLORER -->
    <div class="tab-content" id="tab-zones">
      <div class="card" style="padding:16px 24px;margin-bottom:16px">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
          <div>
            <div class="card-title" style="margin-bottom:4px"><span class="icon">&#127970;</span> <span id="zoneExplorerTitle">Zone Explorer</span></div>
            <p style="font-size:.85rem;color:var(--text-secondary);margin:0" id="zoneExplorerDesc">Click on a zone to see its detailed information.</p>
          </div>
          <div style="position:relative;min-width:220px">
            <input type="text" id="zoneSearchInput" oninput="filterZones()" placeholder="Search zones..." style="width:100%;padding:8px 12px 8px 34px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:.85rem;background:white;outline:none;transition:border .2s">
            <span style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text-secondary);font-size:.9rem">&#128269;</span>
          </div>
        </div>
      </div>
      <div id="zoneReportBanner" style="display:none"></div>
      <div id="zoneTutorial" style="display:none"></div>
      <div id="zoneCardGrid" class="zone-card-grid"></div>
      <div id="zoneDetailPanel" style="display:none"></div>
      <div id="zoneComparePanel" style="display:none"></div>
      <div id="zoneCompareBar" class="zone-compare-bar" style="display:none">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <span style="font-weight:700;font-size:.85rem;white-space:nowrap" id="zoneCompareBarLabel">Compare:</span>
          <div class="selected-tags" id="zoneSelectedTags"></div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn-outline" onclick="clearZoneSelection()" style="font-size:.82rem;padding:5px 14px" id="zoneClearBtn">Clear</button>
          <button class="btn-primary" onclick="showZoneComparison()" style="font-size:.82rem;padding:5px 14px" id="zoneCompareBtn">Compare</button>
        </div>
      </div>
    </div>

    <!-- TAB: INSIGHTS -->
    <div class="tab-content" id="tab-insights">
      <div class="card">
        <div class="card-title"><span class="icon">&#128161;</span> <span data-i18n="autoInsights">Automated Insights</span></div>
        <ul class="insight-list" id="insightList"></ul>
      </div>
    </div>

    <!-- TAB: API -->
    <div class="tab-content" id="tab-api">
      <div class="card" style="padding:12px 24px;margin-bottom:16px">
        <div class="card-title" style="margin-bottom:4px"><span class="icon">&#128187;</span> <span data-i18n="devApi">Developer Data (Digital Twin Ready)</span></div>
        <p style="font-size:.85rem;color:var(--text-secondary)" data-i18n="devApiDesc">Structured JSON data extracted from the report, ready for API integration, digital twin platforms, or further analysis.</p>
      </div>
      <!-- Sub-tab navigation -->
      <div class="api-subtabs" style="display:flex;gap:4px;margin-bottom:16px;flex-wrap:wrap">
        <button class="api-subtab active" onclick="switchApiSub('energy')" id="apiSubEnergy">Energy Report</button>
        <button class="api-subtab" onclick="switchApiSub('peakLoad')" id="apiSubPeakLoad">Peak Load Analysis</button>
        <button class="api-subtab" onclick="switchApiSub('hvac')" id="apiSubHvac">HVAC Sizing</button>
        <button class="api-subtab" onclick="switchApiSub('simInfo')" id="apiSubSimInfo">Simulation Info</button>
      </div>
      <!-- Sub: Energy Report (existing) -->
      <div class="api-sub-content" id="apiSub-energy">
        <div class="card">
          <div class="card-title"><span class="icon">&#9889;</span> Energy Report Data <span style="font-size:.75rem;color:var(--text-secondary);font-weight:400">building-energy-report/v1</span></div>
          <p style="margin-bottom:12px;font-size:.85rem;color:var(--text-secondary)">Annual/monthly energy consumption, end-use breakdown, peak demand, comfort data.</p>
          <div style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn-primary" onclick="exportJSON()"><span data-i18n="downloadJson">Download JSON</span></button>
            <button class="btn-outline" onclick="exportCSV()"><span data-i18n="downloadCsv">Download CSV</span></button>
            <button class="btn-outline" onclick="copyApiData('apiDataPre')"><span data-i18n="copyClipboard">Copy to Clipboard</span></button>
          </div>
          <div class="api-panel">
            <button class="copy-btn" onclick="copyApiData('apiDataPre')">Copy</button>
            <pre id="apiDataPre"></pre>
          </div>
        </div>
      </div>
      <!-- Sub: Peak Load Analysis -->
      <div class="api-sub-content" id="apiSub-peakLoad" style="display:none">
        <div class="card">
          <div class="card-title"><span class="icon">&#128293;</span> AirLoop Peak Load Analysis <span style="font-size:.75rem;color:var(--text-secondary);font-weight:400">peak-load-analysis/v1</span></div>
          <p style="margin-bottom:12px;font-size:.85rem;color:var(--text-secondary)">Cooling/Heating peak load component breakdown by AirLoop system. Shows what causes peak loads (envelope, people, infiltration, etc.).</p>
          <div style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn-primary" onclick="exportPeakLoadJSON()">Download JSON</button>
            <button class="btn-outline" onclick="copyApiData('peakLoadPre')">Copy to Clipboard</button>
          </div>
          <div class="api-panel">
            <button class="copy-btn" onclick="copyApiData('peakLoadPre')">Copy</button>
            <pre id="peakLoadPre"></pre>
          </div>
        </div>
      </div>
      <!-- Sub: HVAC Sizing -->
      <div class="api-sub-content" id="apiSub-hvac" style="display:none">
        <div class="card">
          <div class="card-title"><span class="icon">&#128295;</span> HVAC Sizing Data <span style="font-size:.75rem;color:var(--text-secondary);font-weight:400">hvac-sizing/v1</span></div>
          <p style="margin-bottom:12px;font-size:.85rem;color:var(--text-secondary)">Zone sizing, system sizing, and component sizing information for HVAC equipment selection and verification.</p>
          <div style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn-primary" onclick="exportHvacJSON()">Download JSON</button>
            <button class="btn-outline" onclick="copyApiData('hvacPre')">Copy to Clipboard</button>
          </div>
          <div class="api-panel">
            <button class="copy-btn" onclick="copyApiData('hvacPre')">Copy</button>
            <pre id="hvacPre"></pre>
          </div>
        </div>
      </div>
      <!-- Sub: Simulation Info -->
      <div class="api-sub-content" id="apiSub-simInfo" style="display:none">
        <div class="card">
          <div class="card-title"><span class="icon">&#128736;</span> Simulation Metadata <span style="font-size:.75rem;color:var(--text-secondary);font-weight:400">simulation-metadata/v1</span></div>
          <p style="margin-bottom:12px;font-size:.85rem;color:var(--text-secondary)">EnergyPlus version, location, simulation settings, and warmup convergence status.</p>
          <div style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn-primary" onclick="exportSimInfoJSON()">Download JSON</button>
            <button class="btn-outline" onclick="copyApiData('simInfoPre')">Copy to Clipboard</button>
          </div>
          <div id="warmupBadge" style="margin-bottom:12px"></div>
          <div class="api-panel">
            <button class="copy-btn" onclick="copyApiData('simInfoPre')">Copy</button>
            <pre id="simInfoPre"></pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- EMPTY STATE -->
  <div id="emptyState">
    <div class="empty-state">
      <div class="icon">&#128200;</div>
      <h3 id="emptyTitle">No Reports Loaded</h3>
      <p id="emptyDesc">Upload OpenStudio / EnergyPlus HTM report files to begin analysis</p>
    </div>
  </div>
</div>

<div class="footer">
  Annual Building Systems Report Analyzer &mdash; Digital Twin Ready &copy; 2026
</div>

<script>
// =========================================================
// GLOBAL STATE
// =========================================================
let currentLang = 'en';
let currentUnit = 'ip'; // 'ip' or 'si'
let reports = []; // parsed report objects
let activeReportIdx = 0;
let charts = {};
let cameFromCompare = false; // track navigation from compare → monthly
let cameFromZoneCompare = false; // track navigation from zone compare → zone explorer

// =========================================================
// I18N
// =========================================================
const i18n = {
  en: {
    appTitle: 'Annual Building Systems Analysis',
    dropTitle: 'Drop Annual Building Systems HTM Report Here',
    dropSubtitle: 'or click to browse \u2014 supports multiple files for comparison (not for HVAC reports)',
    tabOverview: 'Overview',
    tabMonthly: 'Monthly Analysis',
    tabCompare: 'Comparison',
    tabDetails: 'Building Details',
    tabZones: 'Zone Explorer',
    tabInsights: 'Insights',
    zoneExplorerTitle: 'Zone Explorer',
    zoneExplorerDesc: 'Click on a zone card to see detailed information about that space.',
    zoneConditioned: 'Conditioned',
    zoneUnconditioned: 'Unconditioned',
    zoneBasicInfo: 'Basic Information',
    zoneEnvelope: 'Envelope (Walls & Windows)',
    zoneInternalLoad: 'Internal Loads',
    zoneSizingInfo: 'HVAC Design Sizing',
    zoneInfiltrationInfo: 'Air Infiltration',
    zoneBack: '\u2190 Back to Zone List',
    tabApi: 'Developer API',
    endUseBreakdown: 'End-Use Energy Breakdown',
    fuelBreakdown: 'Energy by Fuel Type',
    monthlyTrend: 'Monthly Energy Trend',
    monthlyStackedChart: 'Monthly Energy by End Use',
    monthlyPeakChart: 'Monthly Peak Demand',
    monthlyTable: 'Monthly Data Table',
    buildingInfo: 'Building Information',
    endUseDetail: 'Detailed End Use by Fuel',
    zoneSummary: 'Zone Summary',
    comfortSummary: 'Comfort & Setpoint Summary',
    autoInsights: 'Automated Insights',
    devApi: 'Developer Data (Digital Twin Ready)',
    devApiDesc: 'Structured JSON data extracted from the report, ready for API integration, digital twin platforms, or further analysis.',
    downloadJson: 'Download JSON',
    downloadCsv: 'Download CSV',
    copyClipboard: 'Copy to Clipboard',
    emptyTitle: 'No Reports Loaded',
    emptyDesc: 'Upload Annual Building Systems (.htm) report files to begin analysis',
    fuelBarHint: 'Click a fuel to see monthly details &rarr;',
    fuelSelectLabel: 'Fuel Type',
    dataContextTitle: 'Understanding This Data',
    totalEnergy: 'Total Site Energy',
    heatingEnergy: 'Heating',
    coolingEnergy: 'Cooling',
    eui: 'EUI',
    buildingArea: 'Building Area',
    months: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
    endUses: { Heating:'Heating', Cooling:'Cooling', 'Interior Lighting':'Interior Lighting', 'Exterior Lighting':'Exterior Lighting', 'Interior Equipment':'Interior Equipment', 'Exterior Equipment':'Exterior Equipment', Fans:'Fans', Pumps:'Pumps', 'Heat Rejection':'Heat Rejection', Humidification:'Humidification', 'Heat Recovery':'Heat Recovery', 'Water Systems':'Water Systems', Refrigeration:'Refrigeration', Generators:'Generators', 'Total End Uses':'Total' },
    fuels: { Electricity:'Electricity', 'Natural Gas':'Natural Gas', 'District Cooling':'District Cooling', 'District Heating':'District Heating' },
    building: 'Building',
    location: 'Location',
    simDate: 'Simulation Date',
    program: 'Program',
    simHours: 'Simulation Hours',
    totalArea: 'Total Area',
    condArea: 'Conditioned Area',
    wwRatio: 'Window-Wall Ratio',
    heatingNotMet: 'Setpoint Not Met (Heating)',
    coolingNotMet: 'Setpoint Not Met (Cooling)',
    notComfortable: 'Not Comfortable (ASHRAE 55)',
    insightHeatingDominant: 'Heating accounts for {pct}% of total energy \u2014 consider improving insulation, windows, or heat recovery.',
    insightCoolingDominant: 'Cooling accounts for {pct}% of total energy \u2014 consider solar shading, high-performance glazing, or chiller optimization.',
    insightFanHigh: 'Fan energy ({pct}%) is significant \u2014 review duct design, static pressure setpoints, and fan efficiency.',
    insightSetpointHeat: 'Heating setpoint not met for {hours} hours \u2014 the heating system may be undersized.',
    insightSetpointCool: 'Cooling setpoint not met for {hours} hours \u2014 the cooling system may be undersized.',
    insightHighEUI: 'EUI is {eui} \u2014 this is relatively high. Consider energy efficiency improvements.',
    insightLowEUI: 'EUI is {eui} \u2014 good energy performance!',
    insightNoIssues: 'No major issues detected \u2014 building energy performance appears reasonable.',
    noComparison: 'Upload 2 or more files to enable comparison.',
    compareTitle: 'Report Comparison',
    compareMetric: 'Comparison Metric',
    cmpEnergy: 'Energy Comparison',
    cmpZone: 'Zone Comparison',
    cmpZoneSelect: 'Select Zone',
    cmpZoneDesc: 'Compare the same zone across different reports to see how design changes affect each space.',
    cmpNoZone: 'No common zones found. Zones must have the same name across reports to compare.',
    totalSiteEnergy: 'Total Site Energy',
    heatingOnly: 'Heating Only',
    coolingOnly: 'Cooling Only',
    allEndUse: 'All End Uses',
    peakDemand: 'Peak Demand',
  },
  ko: {
    appTitle: '\uC5F0\uAC04 \uAC74\uBB3C \uC5D0\uB108\uC9C0 \uBD84\uC11D (Annual Building Systems)',
    dropTitle: 'Annual Building Systems HTM \uBCF4\uACE0\uC11C\uB97C \uC5EC\uAE30\uC5D0 \uB193\uC73C\uC138\uC694',
    dropSubtitle: '\uB610\uB294 \uD074\uB9AD\uD558\uC5EC \uCC3E\uC544\uBCF4\uAE30 \u2014 \uC5EC\uB7EC \uD30C\uC77C \uBE44\uAD50 \uC9C0\uC6D0 (HVAC \uBCF4\uACE0\uC11C\uB294 \uBCC4\uB3C4)',
    tabOverview: '\uAC1C\uC694',
    tabMonthly: '\uC6D4\uBCC4 \uBD84\uC11D',
    tabCompare: '\uBE44\uAD50',
    tabDetails: '\uAC74\uBB3C \uC0C1\uC138',
    tabZones: '\uC874 \uD0D0\uC0C9\uAE30',
    tabInsights: '\uC778\uC0AC\uC774\uD2B8',
    zoneExplorerTitle: '\uC874 \uD0D0\uC0C9\uAE30',
    zoneExplorerDesc: '\uC874 \uCE74\uB4DC\uB97C \uD074\uB9AD\uD558\uBA74 \uD574\uB2F9 \uACF5\uAC04\uC758 \uC0C1\uC138 \uC815\uBCF4\uB97C \uBCFC \uC218 \uC788\uC2B5\uB2C8\uB2E4.',
    zoneConditioned: '\uACF5\uC870',
    zoneUnconditioned: '\uBE44\uACF5\uC870',
    zoneBasicInfo: '\uAE30\uBCF8 \uC815\uBCF4',
    zoneEnvelope: '\uC678\uD53C (\uBCBD\uCCB4 \uBC0F \uCC3D\uD638)',
    zoneInternalLoad: '\uB0B4\uBD80 \uBD80\uD558',
    zoneSizingInfo: 'HVAC \uC124\uACC4 \uC6A9\uB7C9',
    zoneInfiltrationInfo: '\uCE68\uAE30(\uC678\uAE30 \uC720\uC785)',
    zoneBack: '\u2190 \uC874 \uBAA9\uB85D\uC73C\uB85C',
    tabApi: '\uAC1C\uBC1C\uC790 API',
    endUseBreakdown: '\uC6A9\uB3C4\uBCC4 \uC5D0\uB108\uC9C0 \uBD84\uC11D',
    fuelBreakdown: '\uC5F0\uB8CC\uBCC4 \uC5D0\uB108\uC9C0',
    monthlyTrend: '\uC6D4\uBCC4 \uC5D0\uB108\uC9C0 \uCD94\uC774',
    monthlyStackedChart: '\uC6D4\uBCC4 \uC6A9\uB3C4\uBCC4 \uC5D0\uB108\uC9C0',
    monthlyPeakChart: '\uC6D4\uBCC4 \uD53C\uD06C \uC218\uC694',
    monthlyTable: '\uC6D4\uBCC4 \uB370\uC774\uD130 \uD14C\uC774\uBE14',
    buildingInfo: '\uAC74\uBB3C \uC815\uBCF4',
    endUseDetail: '\uC5F0\uB8CC\uBCC4 \uC0C1\uC138 \uC6A9\uB3C4',
    zoneSummary: '\uC874 \uC694\uC57D',
    comfortSummary: '\uC7D8\uC801\uC131 \uBC0F \uC124\uC815\uC810 \uC694\uC57D',
    autoInsights: '\uC790\uB3D9 \uC778\uC0AC\uC774\uD2B8',
    devApi: '\uAC1C\uBC1C\uC790 \uB370\uC774\uD130 (\uB514\uC9C0\uD138\uD2B8\uC708 \uC5F0\uB3D9)',
    devApiDesc: '\uBCF4\uACE0\uC11C\uC5D0\uC11C \uCD94\uCD9C\uD55C \uAD6C\uC870\uD654\uB41C JSON \uB370\uC774\uD130\uC785\uB2C8\uB2E4. API \uC5F0\uB3D9, \uB514\uC9C0\uD138\uD2B8\uC708 \uD50C\uB7AB\uD3FC, \uCD94\uAC00 \uBD84\uC11D\uC5D0 \uBC14\uB85C \uD65C\uC6A9\uD560 \uC218 \uC788\uC2B5\uB2C8\uB2E4.',
    downloadJson: 'JSON \uB2E4\uC6B4\uB85C\uB4DC',
    downloadCsv: 'CSV \uB2E4\uC6B4\uB85C\uB4DC',
    copyClipboard: '\uD074\uB9BD\uBCF4\uB4DC\uC5D0 \uBCF5\uC0AC',
    emptyTitle: '\uBCF4\uACE0\uC11C\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4',
    emptyDesc: 'Annual Building Systems (.htm) \uBCF4\uACE0\uC11C \uD30C\uC77C\uC744 \uC5C5\uB85C\uB4DC\uD558\uC5EC \uBD84\uC11D\uC744 \uC2DC\uC791\uD558\uC138\uC694',
    fuelBarHint: '\uC5F0\uB8CC\uB97C \uD074\uB9AD\uD558\uBA74 \uC6D4\uBCC4 \uBD84\uC11D\uC73C\uB85C \uC774\uB3D9\uD569\uB2C8\uB2E4 &rarr;',
    fuelSelectLabel: '\uC5F0\uB8CC \uC120\uD0DD',
    dataContextTitle: '\uC774 \uB370\uC774\uD130 \uC774\uD574\uD558\uAE30',
    totalEnergy: '\uCD1D \uC0AC\uC774\uD2B8 \uC5D0\uB108\uC9C0',
    heatingEnergy: '\uB09C\uBC29',
    coolingEnergy: '\uB0C9\uBC29',
    eui: 'EUI (\uC5D0\uB108\uC9C0 \uC0AC\uC6A9 \uAC15\uB3C4)',
    buildingArea: '\uAC74\uBB3C \uBA74\uC801',
    months: ['1\uC6D4','2\uC6D4','3\uC6D4','4\uC6D4','5\uC6D4','6\uC6D4','7\uC6D4','8\uC6D4','9\uC6D4','10\uC6D4','11\uC6D4','12\uC6D4'],
    endUses: { Heating:'\uB09C\uBC29', Cooling:'\uB0C9\uBC29', 'Interior Lighting':'\uC2E4\uB0B4\uC870\uBA85', 'Exterior Lighting':'\uC678\uBD80\uC870\uBA85', 'Interior Equipment':'\uC2E4\uB0B4\uC7A5\uBE44', 'Exterior Equipment':'\uC678\uBD80\uC7A5\uBE44', Fans:'\uD32C', Pumps:'\uD38C\uD504', 'Heat Rejection':'\uC5F4\uBC30\uCD9C', Humidification:'\uAC00\uC2B5', 'Heat Recovery':'\uC5F4\uD68C\uC218', 'Water Systems':'\uAE09\uC218\uC124\uBE44', Refrigeration:'\uB0C9\uB3D9', Generators:'\uBC1C\uC804\uAE30', 'Total End Uses':'\uD569\uACC4' },
    fuels: { Electricity:'\uC804\uAE30', 'Natural Gas':'\uB3C4\uC2DC\uAC00\uC2A4', 'District Cooling':'\uC9C0\uC5ED\uB0C9\uBC29', 'District Heating':'\uC9C0\uC5ED\uB09C\uBC29' },
    building: '\uAC74\uBB3C',
    location: '\uC704\uCE58',
    simDate: '\uC2DC\uBBAC\uB808\uC774\uC158 \uB0A0\uC9DC',
    program: '\uD504\uB85C\uADF8\uB7A8',
    simHours: '\uC2DC\uBBAC\uB808\uC774\uC158 \uC2DC\uAC04',
    totalArea: '\uCD1D \uBA74\uC801',
    condArea: '\uACF5\uC870 \uBA74\uC801',
    wwRatio: '\uCC3D\uBA74\uC801\uBE44',
    heatingNotMet: '\uB09C\uBC29 \uC124\uC815\uC810 \uBBF8\uB2EC \uC2DC\uAC04',
    coolingNotMet: '\uB0C9\uBC29 \uC124\uC815\uC810 \uBBF8\uB2EC \uC2DC\uAC04',
    notComfortable: '\uBD88\uC7D8\uC801 \uC2DC\uAC04 (ASHRAE 55)',
    insightHeatingDominant: '\uB09C\uBC29\uC774 \uC804\uCCB4 \uC5D0\uB108\uC9C0\uC758 {pct}%\uB97C \uCC28\uC9C0\uD569\uB2C8\uB2E4 \u2014 \uB2E8\uC5F4, \uCC3D\uD638, \uC5F4\uD68C\uC218 \uAC1C\uC120\uC744 \uACE0\uB824\uD558\uC138\uC694.',
    insightCoolingDominant: '\uB0C9\uBC29\uC774 \uC804\uCCB4 \uC5D0\uB108\uC9C0\uC758 {pct}%\uB97C \uCC28\uC9C0\uD569\uB2C8\uB2E4 \u2014 \uC77C\uC0AC\uCC28\uB2E8, \uACE0\uC131\uB2A5 \uC720\uB9AC, \uB0C9\uB3D9\uAE30 \uCD5C\uC801\uD654\uB97C \uACE0\uB824\uD558\uC138\uC694.',
    insightFanHigh: '\uD32C \uC5D0\uB108\uC9C0({pct}%)\uAC00 \uB192\uC2B5\uB2C8\uB2E4 \u2014 \uB355\uD2B8 \uC124\uACC4, \uC815\uC555 \uC124\uC815, \uD32C \uD6A8\uC728\uC744 \uC810\uAC80\uD558\uC138\uC694.',
    insightSetpointHeat: '\uB09C\uBC29 \uC124\uC815\uC810 \uBBF8\uB2EC \uC2DC\uAC04\uC774 {hours}\uC2DC\uAC04\uC785\uB2C8\uB2E4 \u2014 \uB09C\uBC29 \uC2DC\uC2A4\uD15C \uC6A9\uB7C9\uC774 \uBD80\uC871\uD560 \uC218 \uC788\uC2B5\uB2C8\uB2E4.',
    insightSetpointCool: '\uB0C9\uBC29 \uC124\uC815\uC810 \uBBF8\uB2EC \uC2DC\uAC04\uC774 {hours}\uC2DC\uAC04\uC785\uB2C8\uB2E4 \u2014 \uB0C9\uBC29 \uC2DC\uC2A4\uD15C \uC6A9\uB7C9\uC774 \uBD80\uC871\uD560 \uC218 \uC788\uC2B5\uB2C8\uB2E4.',
    insightHighEUI: 'EUI\uAC00 {eui}\uC785\uB2C8\uB2E4 \u2014 \uBE44\uAD50\uC801 \uB192\uC740 \uC218\uC900\uC774\uBBC0\uB85C \uC5D0\uB108\uC9C0 \uD6A8\uC728 \uAC1C\uC120\uC744 \uAC80\uD1A0\uD558\uC138\uC694.',
    insightLowEUI: 'EUI\uAC00 {eui}\uC785\uB2C8\uB2E4 \u2014 \uC591\uD638\uD55C \uC5D0\uB108\uC9C0 \uC131\uB2A5\uC785\uB2C8\uB2E4!',
    insightNoIssues: '\uC8FC\uC694 \uBB38\uC81C\uAC00 \uAC10\uC9C0\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4 \u2014 \uAC74\uBB3C \uC5D0\uB108\uC9C0 \uC131\uB2A5\uC774 \uC591\uD638\uD569\uB2C8\uB2E4.',
    noComparison: '\uBE44\uAD50\uB97C \uC704\uD574 2\uAC1C \uC774\uC0C1\uC758 \uD30C\uC77C\uC744 \uC5C5\uB85C\uB4DC\uD558\uC138\uC694.',
    compareTitle: '\uBCF4\uACE0\uC11C \uBE44\uAD50',
    compareMetric: '\uBE44\uAD50 \uD56D\uBAA9',
    cmpEnergy: '\uC5D0\uB108\uC9C0 \uBE44\uAD50',
    cmpZone: '\uC874\uBCC4 \uBE44\uAD50',
    cmpZoneSelect: '\uC874 \uC120\uD0DD',
    cmpZoneDesc: '\uAC19\uC740 \uC874\uC744 \uC5EC\uB7EC \uBCF4\uACE0\uC11C\uC5D0\uC11C \uBE44\uAD50\uD558\uC5EC \uC124\uACC4 \uBCC0\uACBD\uC774 \uAC01 \uACF5\uAC04\uC5D0 \uBBF8\uCE58\uB294 \uC601\uD5A5\uC744 \uD655\uC778\uD569\uB2C8\uB2E4.',
    cmpNoZone: '\uACF5\uD1B5 \uC874\uC774 \uC5C6\uC2B5\uB2C8\uB2E4. \uBE44\uAD50\uD558\uB824\uBA74 \uBCF4\uACE0\uC11C \uAC04 \uAC19\uC740 \uC774\uB984\uC758 \uC874\uC774 \uD544\uC694\uD569\uB2C8\uB2E4.',
    totalSiteEnergy: '\uCD1D \uC0AC\uC774\uD2B8 \uC5D0\uB108\uC9C0',
    heatingOnly: '\uB09C\uBC29\uB9CC',
    coolingOnly: '\uB0C9\uBC29\uB9CC',
    allEndUse: '\uC804\uCCB4 \uC6A9\uB3C4\uBCC4',
    peakDemand: '\uD53C\uD06C \uC218\uC694',
  }
};

function t(key) { return (i18n[currentLang] && i18n[currentLang][key]) || (i18n.en[key]) || key; }
function tEndUse(name) { const map = i18n[currentLang].endUses; return (map && map[name]) || name; }
function tFuel(name) { const map = i18n[currentLang].fuels; return (map && map[name]) || name; }

// =========================================================
// UNIT CONVERSION
// =========================================================
const UNITS = {
  ip: {
    energy: { label: 'kBtu', factor: 1 },
    elecConsumption: { label: 'kWh', factor: 1 },
    gasConsumption: { label: 'MBtu', factor: 1 },
    peakElec: { label: 'kW', factor: 1 },
    peakGas: { label: 'kBtu/hr', factor: 1 },
    area: { label: 'ft\u00B2', factor: 1 },
    eui: { label: 'kBtu/ft\u00B2', factor: 1 },
    volume: { label: 'ft\u00B3', factor: 1 },
  },
  si: {
    energy: { label: 'kWh', factor: 0.293071 },
    elecConsumption: { label: 'kWh', factor: 1 },
    gasConsumption: { label: 'kWh', factor: 293.071 },
    peakElec: { label: 'kW', factor: 1 },
    peakGas: { label: 'kW', factor: 0.293071 },
    area: { label: 'm\u00B2', factor: 0.092903 },
    eui: { label: 'kWh/m\u00B2', factor: 3.15459 },
    volume: { label: 'm\u00B3', factor: 0.0283168 },
  }
};

function convertVal(value, unitType) {
  if (value === null || value === undefined || isNaN(value)) return null;
  return value * UNITS[currentUnit][unitType].factor;
}
function unitLabel(unitType) {
  return UNITS[currentUnit][unitType].label;
}
function getReportLabel(r, idx) {
  // Create a short distinctive label from file name
  const raw = r.fileName.replace(/\.htm[l]?$/i, '');
  // If name is very long, try to show key parts
  if (raw.length > 35) {
    // Try to extract date portion for distinction
    const dateMatch = raw.match(/(\d{4}-\d{2}-\d{2})\s*(\d{2}-\d{2}-\d{2})?/);
    const prefix = raw.substring(0, 25).replace(/\s+$/, '');
    if (dateMatch) return prefix + '... ' + dateMatch[1];
    return prefix + ' (#' + (idx + 1) + ')';
  }
  return raw;
}

function getReportLabels() {
  // If all file names are the same, add index
  const names = reports.map((r, i) => getReportLabel(r, i));
  // Check for duplicates and add index
  const counts = {};
  names.forEach(n => counts[n] = (counts[n] || 0) + 1);
  const seen = {};
  return names.map((n, i) => {
    if (counts[n] > 1) {
      seen[n] = (seen[n] || 0) + 1;
      return n + ' (#' + seen[n] + ')';
    }
    return n;
  });
}

function fmtNum(v, decimals = 1) {
  if (v === null || v === undefined || isNaN(v)) return '\u2014';
  if (Math.abs(v) >= 1000) return v.toLocaleString(currentLang === 'ko' ? 'ko-KR' : 'en-US', { maximumFractionDigits: decimals });
  return v.toFixed(decimals);
}

// =========================================================
// PARSER - Extract data from OpenStudio HTM
// =========================================================
function parseHTM(htmlText, fileName) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(htmlText, 'text/html');
  const report = {
    fileName: fileName,
    metadata: {},
    annualEndUse: {},
    annualFuelUse: {},
    monthlyConsumption: {},
    monthlyPeakDemand: {},
    endUseByFuel: {},
    buildingArea: {},
    zoneSummary: [],
    comfortSummary: {},
    windowWallRatio: {},
    siteSourceEnergy: {},
    rawDetailedTables: {},
    airLoopLoadSummary: {},
    initSummary: { version: null, timestepsPerHour: null, location: {}, buildingInfo: {}, zoneSizing: [], systemSizing: [], componentSizing: [] },
    warmupConvergence: { allPassed: true, zones: [] },
    zoneDetail: [],
  };

  const bodyText = htmlText;
  const progMatch = bodyText.match(/Program Version:<b>([^<]+)<\/b>/);
  if (progMatch) report.metadata.program = progMatch[1].trim();

  const buildingMatch = bodyText.match(/Building: <b>([^<]+)<\/b>/);
  if (buildingMatch) report.metadata.building = buildingMatch[1].trim();

  const envMatch = bodyText.match(/Environment: <b>([^<]+)<\/b>/);
  if (envMatch) report.metadata.environment = envMatch[1].trim();

  const tsMatch = bodyText.match(/Simulation Timestamp: <b>([\s\S]*?)<\/b>/);
  if (tsMatch) report.metadata.simTimestamp = tsMatch[1].replace(/\s+/g, ' ').trim();

  const hoursMatch = bodyText.match(/Values gathered over\s+([\d.]+)\s+hours/);
  if (hoursMatch) report.metadata.simHours = parseFloat(hoursMatch[1]);

  const buttons = doc.querySelectorAll('button[data-toggle="collapse"]');
  buttons.forEach(btn => {
    const title = btn.textContent.trim().replace(/\s+/g, ' ');
    const targetId = btn.getAttribute('data-target');
    if (!targetId) return;
    const tableDiv = doc.querySelector(targetId);
    if (!tableDiv) return;
    const table = tableDiv.querySelector('table');
    if (!table) return;

    if (title.includes('End Use - view table')) {
      parseAnnualTable(table, report.annualEndUse);
    }
    else if (title.includes('Energy Use - view table')) {
      parseAnnualTable(table, report.annualFuelUse);
    }
    else if (title.includes('Consumption') && title.includes('view table')) {
      const fuelName = extractFuelName(title);
      report.monthlyConsumption[fuelName] = parseMonthlyTable(table);
    }
    else if (title.includes('Peak Demand') && title.includes('view table')) {
      const fuelName = extractFuelName(title);
      report.monthlyPeakDemand[fuelName] = parseMonthlyTable(table);
    }
  });

  parseDetailedTables(doc, htmlText, report);
  parseAirLoopLoadSummary(htmlText, doc, report);
  parseInitSummary(htmlText, doc, report);
  parseWarmupConvergence(htmlText, doc, report);
  parseAdditionalInitTables(htmlText, doc, report);
  buildZoneDetail(report);
  return report;
}

function parseAnnualTable(table, target) {
  const rows = table.querySelectorAll('tr');
  rows.forEach((row, i) => {
    if (i === 0) return;
    const cells = row.querySelectorAll('td');
    if (cells.length >= 2) {
      const name = cells[0].textContent.trim();
      const val = parseNumber(cells[1].textContent.trim());
      if (name) target[name] = val;
    }
  });
}

function parseMonthlyTable(table) {
  const result = {};
  const rows = table.querySelectorAll('tr');
  rows.forEach((row, i) => {
    if (i === 0) return;
    const cells = row.querySelectorAll('td');
    if (cells.length >= 13) {
      const endUse = cells[0].textContent.trim();
      const monthly = [];
      for (let m = 1; m <= 12; m++) {
        monthly.push(parseNumber(cells[m].textContent.trim()));
      }
      const total = cells.length > 13 ? parseNumber(cells[13].textContent.trim()) : null;
      result[endUse] = { monthly, total };
    }
  });
  return result;
}

function extractFuelName(title) {
  if (title.includes('Electricity')) return 'Electricity';
  if (title.includes('Natural Gas')) return 'Natural Gas';
  if (title.includes('District Cooling')) return 'District Cooling';
  if (title.includes('District Heating')) return 'District Heating';
  return title.split('(')[0].trim();
}

function parseDetailedTables(doc, htmlText, report) {
  const sseTable = findTableByComment(htmlText, doc, 'Site and Source Energy');
  if (sseTable) {
    const rows = sseTable.querySelectorAll('tr');
    rows.forEach((row, i) => {
      if (i === 0) return;
      const cells = row.querySelectorAll('td');
      if (cells.length >= 4) {
        const name = cells[0].textContent.trim();
        report.siteSourceEnergy[name] = {
          totalEnergy: parseNumber(cells[1].textContent),
          perTotalArea: parseNumber(cells[2].textContent),
          perCondArea: parseNumber(cells[3].textContent),
        };
      }
    });
  }

  const baTable = findTableByComment(htmlText, doc, 'Building Area');
  if (baTable) {
    const rows = baTable.querySelectorAll('tr');
    rows.forEach((row, i) => {
      if (i === 0) return;
      const cells = row.querySelectorAll('td');
      if (cells.length >= 2) {
        report.buildingArea[cells[0].textContent.trim()] = parseNumber(cells[1].textContent);
      }
    });
  }

  const euTable = findTableByComment(htmlText, doc, 'Entire Facility_End Uses');
  if (euTable) {
    const headerRow = euTable.querySelector('tr');
    const headers = [];
    if (headerRow) {
      headerRow.querySelectorAll('td').forEach(td => headers.push(td.textContent.trim()));
    }
    const rows = euTable.querySelectorAll('tr');
    rows.forEach((row, i) => {
      if (i === 0) return;
      const cells = row.querySelectorAll('td');
      if (cells.length >= 2) {
        const endUse = cells[0].textContent.trim().replace(/\u00a0/g, '');
        if (!endUse) return;
        const fuelData = {};
        for (let j = 1; j < cells.length && j < headers.length; j++) {
          const hdr = headers[j].replace(/\[.*\]/, '').trim();
          fuelData[hdr] = parseNumber(cells[j].textContent);
        }
        report.endUseByFuel[endUse] = fuelData;
      }
    });
  }

  const comfortTable = findTableByComment(htmlText, doc, 'Comfort and Setpoint Not Met Summary');
  if (comfortTable) {
    const rows = comfortTable.querySelectorAll('tr');
    rows.forEach((row, i) => {
      if (i === 0) return;
      const cells = row.querySelectorAll('td');
      if (cells.length >= 2) {
        report.comfortSummary[cells[0].textContent.trim()] = parseNumber(cells[1].textContent);
      }
    });
  }

  const wwrTable = findTableByComment(htmlText, doc, 'Window-Wall Ratio');
  if (wwrTable) {
    const headerRow = wwrTable.querySelector('tr');
    const headers = [];
    if (headerRow) headerRow.querySelectorAll('td').forEach(td => headers.push(td.textContent.trim()));
    const rows = wwrTable.querySelectorAll('tr');
    rows.forEach((row, i) => {
      if (i <= 0) return;
      const cells = row.querySelectorAll('td');
      if (cells.length >= 2) {
        const name = cells[0].textContent.trim();
        const data = {};
        for (let j = 1; j < cells.length && j < headers.length; j++) {
          data[headers[j]] = parseNumber(cells[j].textContent);
        }
        report.windowWallRatio[name] = data;
      }
    });
  }

  const zsTable = findTableByComment(htmlText, doc, 'Entire Facility_Zone Summary');
  if (zsTable) {
    const headerRow = zsTable.querySelector('tr');
    const headers = [];
    if (headerRow) headerRow.querySelectorAll('td').forEach(td => headers.push(td.textContent.trim()));
    const rows = zsTable.querySelectorAll('tr');
    rows.forEach((row, i) => {
      if (i === 0) return;
      const cells = row.querySelectorAll('td');
      if (cells.length >= 2) {
        const zone = {};
        for (let j = 0; j < cells.length && j < headers.length; j++) {
          zone[headers[j] || 'Zone'] = cells[j].textContent.trim();
        }
        report.zoneSummary.push(zone);
      }
    });
  }
}

function findTableByComment(htmlText, doc, commentSubstr) {
  const searchStr = commentSubstr;
  let pos = -1;
  const allComments = htmlText.match(/<!-- FullName:[^>]+-->/g) || [];
  for (const comment of allComments) {
    if (comment.includes(searchStr)) {
      pos = htmlText.indexOf(comment);
      break;
    }
  }
  if (pos === -1) return null;

  const afterComment = htmlText.substring(pos);
  const tableStart = afterComment.indexOf('<table');
  if (tableStart === -1) return null;
  const tableEnd = afterComment.indexOf('</table>', tableStart);
  if (tableEnd === -1) return null;
  const tableHtml = afterComment.substring(tableStart, tableEnd + 8);
  const tempDoc = new DOMParser().parseFromString(tableHtml, 'text/html');
  return tempDoc.querySelector('table');
}

function parseNumber(str) {
  if (!str) return 0;
  const clean = str.replace(/,/g, '').trim();
  if (clean === '' || clean === '-' || clean === '\u2014') return 0;
  const num = parseFloat(clean);
  return isNaN(num) ? 0 : num;
}

// =========================================================
// PARSER - AirLoop Component Load Summary
// =========================================================
function findAllTablesByComment(htmlText, doc, pattern) {
  const results = [];
  const allComments = htmlText.match(/<!-- FullName:[^>]+-->/g) || [];
  for (const comment of allComments) {
    if (comment.includes(pattern)) {
      const pos = htmlText.indexOf(comment);
      const afterComment = htmlText.substring(pos);
      const tableStart = afterComment.indexOf('<table');
      if (tableStart === -1) continue;
      const tableEnd = afterComment.indexOf('</table>', tableStart);
      if (tableEnd === -1) continue;
      const tableHtml = afterComment.substring(tableStart, tableEnd + 8);
      const tempDoc = new DOMParser().parseFromString(tableHtml, 'text/html');
      const table = tempDoc.querySelector('table');
      // Extract system/zone name from comment
      const nameMatch = comment.match(/FullName:([^_]+)_([^_]+)_/);
      const sysName = nameMatch ? nameMatch[2] : 'Unknown';
      results.push({ table, systemName: sysName, comment });
    }
  }
  return results;
}

function parseLoadComponentsTable(table) {
  const components = [];
  const rows = table.querySelectorAll('tr');
  rows.forEach((row, i) => {
    if (i === 0) return;
    const cells = row.querySelectorAll('td');
    if (cells.length >= 7) {
      const name = cells[0].textContent.trim();
      const total = parseNumber(cells[5]?.textContent);
      const pctGrandTotal = parseNumber(cells[6]?.textContent);
      components.push({
        name,
        sensibleInstant: parseNumber(cells[1]?.textContent),
        sensibleDelayed: parseNumber(cells[2]?.textContent),
        sensibleReturnAir: parseNumber(cells[3]?.textContent),
        latent: parseNumber(cells[4]?.textContent),
        total,
        pctGrandTotal,
        relatedArea: cells.length > 7 ? parseNumber(cells[7]?.textContent) : 0,
        totalPerArea: cells.length > 8 ? parseNumber(cells[8]?.textContent) : 0,
      });
    }
  });
  return components;
}

function parsePeakConditionsTable(table) {
  const conditions = {};
  const rows = table.querySelectorAll('tr');
  rows.forEach((row, i) => {
    if (i === 0) return;
    const cells = row.querySelectorAll('td');
    if (cells.length >= 2) {
      const key = cells[0].textContent.trim();
      const val = cells[1].textContent.trim();
      conditions[key] = isNaN(parseFloat(val)) ? val : parseNumber(val);
    }
  });
  return conditions;
}

function parseZonesIncludedTable(table) {
  const zones = [];
  const rows = table.querySelectorAll('tr');
  rows.forEach((row, i) => {
    if (i === 0) return;
    const cells = row.querySelectorAll('td');
    if (cells.length >= 2) zones.push(cells[1].textContent.trim());
  });
  return zones;
}

function parseAirLoopLoadSummary(htmlText, doc, report) {
  // Find all AirLoop systems
  const coolComps = findAllTablesByComment(htmlText, doc, 'AirLoop Component Load Summary');
  const sysNames = new Set();
  coolComps.forEach(r => sysNames.add(r.systemName));

  for (const sysName of sysNames) {
    const sys = { cooling: {}, heating: {} };

    // Cooling
    const ccTable = findTableByComment(htmlText, doc, 'AirLoop Component Load Summary_' + sysName + '_Estimated Cooling Peak Load Components');
    if (ccTable) sys.cooling.components = parseLoadComponentsTable(ccTable);
    const cpTable = findTableByComment(htmlText, doc, 'AirLoop Component Load Summary_' + sysName + '_Cooling Peak Conditions');
    if (cpTable) sys.cooling.peakConditions = parsePeakConditionsTable(cpTable);
    const ceTable = findTableByComment(htmlText, doc, 'AirLoop Component Load Summary_' + sysName + '_Engineering Checks for Cooling');
    if (ceTable) sys.cooling.engineeringChecks = parsePeakConditionsTable(ceTable);
    const czTable = findTableByComment(htmlText, doc, 'AirLoop Component Load Summary_' + sysName + '_Zones Included for Cooling');
    if (czTable) sys.cooling.zonesIncluded = parseZonesIncludedTable(czTable);

    // Heating
    const hcTable = findTableByComment(htmlText, doc, 'AirLoop Component Load Summary_' + sysName + '_Estimated Heating Peak Load Components');
    if (hcTable) sys.heating.components = parseLoadComponentsTable(hcTable);
    const hpTable = findTableByComment(htmlText, doc, 'AirLoop Component Load Summary_' + sysName + '_Heating Peak Conditions');
    if (hpTable) sys.heating.peakConditions = parsePeakConditionsTable(hpTable);
    const heTable = findTableByComment(htmlText, doc, 'AirLoop Component Load Summary_' + sysName + '_Engineering Checks for Heating');
    if (heTable) sys.heating.engineeringChecks = parsePeakConditionsTable(heTable);
    const hzTable = findTableByComment(htmlText, doc, 'AirLoop Component Load Summary_' + sysName + '_Zones Included for Heating');
    if (hzTable) sys.heating.zonesIncluded = parseZonesIncludedTable(hzTable);

    report.airLoopLoadSummary[sysName] = sys;
  }
}

// =========================================================
// PARSER - Initialization Summary
// =========================================================
function parseInitSummary(htmlText, doc, report) {
  // Version
  const vTable = findTableByComment(htmlText, doc, 'Initialization Summary_Entire Facility_Version');
  if (vTable) {
    const cells = vTable.querySelectorAll('tr:nth-child(2) td');
    if (cells.length >= 2) report.initSummary.version = cells[1].textContent.trim();
  }

  // Timesteps per Hour
  const tsTable = findTableByComment(htmlText, doc, 'Initialization Summary_Entire Facility_Timesteps per Hour');
  if (tsTable) {
    const cells = tsTable.querySelectorAll('tr:nth-child(2) td');
    if (cells.length >= 3) {
      report.initSummary.timestepsPerHour = parseNumber(cells[1].textContent);
      report.initSummary.minutesPerTimestep = parseNumber(cells[2].textContent);
    }
  }

  // Site:Location
  const locTable = findTableByComment(htmlText, doc, 'Initialization Summary_Entire Facility_Site:Location');
  if (locTable) {
    const cells = locTable.querySelectorAll('tr:nth-child(2) td');
    if (cells.length >= 7) {
      report.initSummary.location = {
        name: cells[1].textContent.trim(),
        latitude: parseNumber(cells[2].textContent),
        longitude: parseNumber(cells[3].textContent),
        timeZone: parseNumber(cells[4].textContent),
        elevation: parseNumber(cells[5].textContent),
      };
    }
  }

  // Building Information
  const biTable = findTableByComment(htmlText, doc, 'Initialization Summary_Entire Facility_Building Information');
  if (biTable) {
    const cells = biTable.querySelectorAll('tr:nth-child(2) td');
    if (cells.length >= 8) {
      report.initSummary.buildingInfo = {
        name: cells[1].textContent.trim(),
        northAxis: parseNumber(cells[2].textContent),
        terrain: cells[3].textContent.trim(),
        loadsConvergenceTolerance: parseNumber(cells[4].textContent),
        tempConvergenceTolerance: parseNumber(cells[5].textContent),
        solarDistribution: cells[6].textContent.trim(),
        maxWarmupDays: parseNumber(cells[7].textContent),
      };
    }
  }

  // Zone Sizing Information
  const zsTable = findTableByComment(htmlText, doc, 'Initialization Summary_Entire Facility_Zone Sizing Information');
  if (zsTable) {
    const rows = zsTable.querySelectorAll('tr');
    rows.forEach((row, i) => {
      if (i === 0) return;
      const c = row.querySelectorAll('td');
      if (c.length >= 13) {
        report.initSummary.zoneSizing.push({
          zoneName: c[1].textContent.trim(),
          loadType: c[2].textContent.trim(),
          calcDesLoad: parseNumber(c[3].textContent),
          userDesLoad: parseNumber(c[4].textContent),
          calcDesAirFlow: parseNumber(c[5].textContent),
          userDesAirFlow: parseNumber(c[6].textContent),
          designDayName: c[7].textContent.trim(),
          dateTimeOfPeak: c[8].textContent.trim(),
          tempAtPeak: parseNumber(c[9].textContent),
          humidityRatioAtPeak: parseNumber(c[10].textContent),
          floorArea: parseNumber(c[11].textContent),
          occupants: parseNumber(c[12].textContent),
        });
      }
    });
  }

  // System Sizing Information
  const ssTable = findTableByComment(htmlText, doc, 'Initialization Summary_Entire Facility_System Sizing Information');
  if (ssTable) {
    const rows = ssTable.querySelectorAll('tr');
    rows.forEach((row, i) => {
      if (i === 0) return;
      const c = row.querySelectorAll('td');
      if (c.length >= 9) {
        report.initSummary.systemSizing.push({
          systemName: c[1].textContent.trim(),
          loadType: c[2].textContent.trim(),
          peakLoadKind: c[3].textContent.trim(),
          userDesCapacity: parseNumber(c[4].textContent),
          calcDesAirFlow: parseNumber(c[5].textContent),
          userDesAirFlow: parseNumber(c[6].textContent),
          designDayName: c[7].textContent.trim(),
          dateTimeOfPeak: c[8].textContent.trim(),
        });
      }
    });
  }

  // Component Sizing Information
  const csTable = findTableByComment(htmlText, doc, 'Initialization Summary_Entire Facility_Component Sizing Information');
  if (csTable) {
    const rows = csTable.querySelectorAll('tr');
    rows.forEach((row, i) => {
      if (i === 0) return;
      const c = row.querySelectorAll('td');
      if (c.length >= 5) {
        report.initSummary.componentSizing.push({
          componentType: c[1].textContent.trim(),
          componentName: c[2].textContent.trim(),
          field: c[3].textContent.trim(),
          value: c[4].textContent.trim(),
        });
      }
    });
  }
}

// =========================================================
// PARSER - Warmup Convergence
// =========================================================
function parseWarmupConvergence(htmlText, doc, report) {
  const wTable = findTableByComment(htmlText, doc, 'Initialization Summary_Entire Facility_Warmup Convergence Information');
  if (!wTable) return;
  const rows = wTable.querySelectorAll('tr');
  rows.forEach((row, i) => {
    if (i === 0) return;
    const c = row.querySelectorAll('td');
    if (c.length >= 11) {
      const maxTempPass = c[5].textContent.trim() === 'Pass';
      const minTempPass = c[6].textContent.trim() === 'Pass';
      const heatLoadPass = c[9].textContent.trim() === 'Pass';
      const coolLoadPass = c[10].textContent.trim() === 'Pass';
      const allPass = maxTempPass && minTempPass && heatLoadPass && coolLoadPass;
      if (!allPass) report.warmupConvergence.allPassed = false;
      report.warmupConvergence.zones.push({
        zoneName: c[1].textContent.trim(),
        environment: c[2].textContent.trim(),
        avgTempDiff: parseNumber(c[3].textContent),
        maxTempPass,
        minTempPass,
        avgLoadDiff: parseNumber(c[7].textContent),
        heatingLoadPass: heatLoadPass,
        coolingLoadPass: coolLoadPass,
      });
    }
  });
}

// =========================================================
// PARSER - Zone Detail Builder (merge all zone data)
// =========================================================
function parseGenericInitTable(htmlText, doc, commentKey) {
  const table = findTableByComment(htmlText, doc, commentKey);
  if (!table) return [];
  const rows = table.querySelectorAll('tr');
  const headers = [];
  const firstRow = rows[0];
  if (firstRow) firstRow.querySelectorAll('td').forEach(td => headers.push(td.textContent.trim()));
  const data = [];
  for (let i = 1; i < rows.length; i++) {
    const cells = rows[i].querySelectorAll('td');
    const obj = {};
    for (let j = 0; j < cells.length && j < headers.length; j++) {
      obj[headers[j] || 'idx'] = cells[j].textContent.trim();
    }
    data.push(obj);
  }
  return data;
}

function buildZoneDetail(report) {
  // Use Zone Summary from Input Verification (existing zoneSummary) as base
  // Then enrich with Zone Information, Internal Gains, People, Lights, Equipment, Infiltration from initSummary

  // Build a map from zone name
  const zoneMap = {};

  // Summary row names to exclude
  const summaryNames = new Set(['Total', 'Conditioned Total', 'Unconditioned Total', 'Not Part of Total']);

  // 1) Existing zone summary (from Input Verification)
  report.zoneSummary.forEach(z => {
    const name = z[''] || z['Zone'] || Object.values(z)[0];
    if (!name || summaryNames.has(name)) return;
    zoneMap[name] = {
      name: name,
      area: parseNumber(z['Area [ft2]']),
      conditioned: z['Conditioned (Y/N)'],
      partOfTotal: z['Part of Total Floor Area (Y/N)'],
      volume: parseNumber(z['Volume [ft3]']),
      multipliers: parseNumber(z['Multipliers']),
      grossWallArea: parseNumber(z['Above Ground Gross Wall Area [ft2]']),
      undergroundWallArea: parseNumber(z['Underground Gross Wall Area [ft2]']),
      windowArea: parseNumber(z['Window Glass Area [ft2]']),
      openingArea: parseNumber(z['Opening Area [ft2]']),
      lightingDensity: parseNumber(z['Lighting [Btu/h-ft2]']),
      areaPerPerson: parseNumber(z['People [ft2 per person]']),
      plugDensity: parseNumber(z['Plug and Process [Btu/h-ft2]']),
      // Extra fields to be filled
      ceilingHeight: 0, extNetWallArea: 0,
      people: {}, lights: {}, equipment: {}, infiltration: {},
      sizing: { cooling: null, heating: null },
    };
  });

  // 2) Zone Information (detailed geometry from Init Summary)
  report._rawZoneInfo = report._rawZoneInfo || [];
  report._rawZoneInfo.forEach(zi => {
    const name = zi['Zone Name'];
    if (!name || !zoneMap[name]) return;
    zoneMap[name].ceilingHeight = parseNumber(zi['Ceiling Height {ft}']);
    zoneMap[name].volume = parseNumber(zi['Volume {ft3}']) || zoneMap[name].volume;
    zoneMap[name].extNetWallArea = parseNumber(zi['Exterior Net Wall Area {ft2}']);
  });

  // 3) Zone Internal Gains
  report._rawInternalGains = report._rawInternalGains || [];
  report._rawInternalGains.forEach(ig => {
    const name = ig['Zone Name'];
    if (!name || !zoneMap[name]) return;
    zoneMap[name].people.count = parseNumber(ig['# Occupants']);
    zoneMap[name].people.areaPerPerson = parseNumber(ig['Area per Occupant {ft2/person}']);
    zoneMap[name].lightingDensity = parseNumber(ig['Interior Lighting {Btu/h-ft2}']) || zoneMap[name].lightingDensity;
    zoneMap[name].plugDensity = parseNumber(ig['Electric Load {Btu/h-ft2}']) || zoneMap[name].plugDensity;
    zoneMap[name].totalLoadDensity = parseNumber(ig['Sum Loads per Area {Btu/h-ft2}']);
  });

  // 4) People Internal Gains Nominal
  report._rawPeople = report._rawPeople || [];
  report._rawPeople.forEach(p => {
    const name = p['Zone Name'];
    if (!name || !zoneMap[name]) return;
    zoneMap[name].people.scheduleName = p['Schedule Name'];
    zoneMap[name].people.count = parseNumber(p['Number of People {}']) || zoneMap[name].people.count;
    zoneMap[name].people.activityLevel = p['Activity level'];
  });

  // 5) Lights Internal Gains Nominal
  report._rawLights = report._rawLights || [];
  report._rawLights.forEach(l => {
    const name = l['Zone Name'];
    if (!name || !zoneMap[name]) return;
    zoneMap[name].lights.level = parseNumber(l['Lighting Level {Btu/h}']);
    zoneMap[name].lights.density = parseNumber(l['Lights/Floor Area {Btu/h-ft2}']);
    zoneMap[name].lights.scheduleName = l['Schedule Name'];
  });

  // 6) Equipment Internal Gains Nominal
  report._rawEquipment = report._rawEquipment || [];
  report._rawEquipment.forEach(e => {
    const name = e['Zone Name'];
    if (!name || !zoneMap[name]) return;
    zoneMap[name].equipment.level = parseNumber(e['Equipment Level {Btu/h}']);
    zoneMap[name].equipment.density = parseNumber(e['Equipment/Floor Area {Btu/h-ft2}']);
    zoneMap[name].equipment.scheduleName = e['Schedule Name'];
  });

  // 7) Infiltration
  report._rawInfiltration = report._rawInfiltration || [];
  report._rawInfiltration.forEach(inf => {
    const name = inf['Zone Name'];
    if (!name || !zoneMap[name]) return;
    zoneMap[name].infiltration.flowRate = parseNumber(inf['Design Volume Flow Rate {ft3/min}']);
    zoneMap[name].infiltration.ach = parseNumber(inf['ACH - Air Changes per Hour']);
    zoneMap[name].infiltration.scheduleName = inf['Schedule Name'];
  });

  // 8) Zone Sizing Info
  report.initSummary.zoneSizing.forEach(zs => {
    const name = zs.zoneName;
    if (!name || !zoneMap[name]) return;
    if (zs.loadType === 'Cooling') {
      zoneMap[name].sizing.cooling = {
        designLoad: zs.calcDesLoad,
        designAirFlow: zs.calcDesAirFlow,
        peakDate: zs.dateTimeOfPeak,
        peakTemp: zs.tempAtPeak,
      };
    } else if (zs.loadType === 'Heating') {
      zoneMap[name].sizing.heating = {
        designLoad: zs.userDesLoad,
        designAirFlow: zs.userDesAirFlow,
        peakDate: zs.dateTimeOfPeak,
        peakTemp: zs.tempAtPeak,
      };
    }
  });

  report.zoneDetail = Object.values(zoneMap);
}

// Parse additional Init Summary tables needed for zone detail
function parseAdditionalInitTables(htmlText, doc, report) {
  report._rawZoneInfo = parseGenericInitTable(htmlText, doc, 'Initialization Summary_Entire Facility_Zone Information');
  report._rawInternalGains = parseGenericInitTable(htmlText, doc, 'Initialization Summary_Entire Facility_Zone Internal Gains Nominal');
  report._rawPeople = parseGenericInitTable(htmlText, doc, 'Initialization Summary_Entire Facility_People Internal Gains Nominal');
  report._rawLights = parseGenericInitTable(htmlText, doc, 'Initialization Summary_Entire Facility_Lights Internal Gains Nominal');
  report._rawEquipment = parseGenericInitTable(htmlText, doc, 'Initialization Summary_Entire Facility_ElectricEquipment Internal Gains Nominal');
  report._rawInfiltration = parseGenericInitTable(htmlText, doc, 'Initialization Summary_Entire Facility_ZoneInfiltration Airflow Stats Nominal');
}

// =========================================================
// FILE HANDLING
// =========================================================
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');

dropZone.addEventListener('click', (e) => {
  // Don't trigger file dialog when clicking on file chips or their children
  if (e.target.closest('.file-chip') || e.target.closest('#fileChips')) return;
  fileInput.click();
});
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  handleFiles(e.dataTransfer.files);
});
fileInput.addEventListener('change', e => handleFiles(e.target.files));

function handleFiles(fileList) {
  Array.from(fileList).forEach(file => {
    if (!file.name.match(/\.htm[l]?$/i)) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      const report = parseHTM(e.target.result, file.name);
      const existing = reports.findIndex(r => r.fileName === file.name);
      if (existing >= 0) {
        reports[existing] = report;
      } else {
        reports.push(report);
        activeReportIdx = reports.length - 1;
      }
      renderAll();
    };
    reader.readAsText(file);
  });
}

// =========================================================
// RENDERING
// =========================================================
function renderAll() {
  if (reports.length === 0) {
    document.getElementById('appContent').style.display = 'none';
    document.getElementById('emptyState').style.display = 'block';
    document.getElementById('exportJsonBtn').style.display = 'none';
    document.getElementById('exportCsvBtn').style.display = 'none';
    const nav = document.getElementById('sectionNav');
    if (nav) nav.classList.remove('visible');
    return;
  }
  document.getElementById('appContent').style.display = 'block';
  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('exportJsonBtn').style.display = '';
  document.getElementById('exportCsvBtn').style.display = '';
  dropZone.classList.add('has-files');

  renderFileChips();
  renderOverview();
  renderMonthlyTab();
  renderCompareTab();
  renderDetailsTab();
  renderZoneExplorer();
  renderInsights();
  renderApiTab();
  applyI18n();
  setTimeout(renderSectionNav, 100);
}

function renderFileChips() {
  const container = document.getElementById('fileChips');
  container.innerHTML = '';
  const labels = getReportLabels();
  reports.forEach((r, i) => {
    const chip = document.createElement('div');
    const isActive = i === activeReportIdx;
    const color = REPORT_COLORS[i % REPORT_COLORS.length];
    const bg = isActive ? color : REPORT_BG_COLORS[i % REPORT_BG_COLORS.length];
    const border = isActive ? color : REPORT_BORDER_COLORS[i % REPORT_BORDER_COLORS.length];
    const textColor = isActive ? 'white' : color;
    chip.className = 'file-chip';
    chip.style.cssText = 'background:' + bg + ';border-color:' + border + ';color:' + textColor;
    chip.innerHTML = '<span style="cursor:pointer" onclick="setActiveReport(' + i + ')">' + labels[i] + '</span><span class="remove" onclick="removeReport(' + i + ')">&times;</span>';
    container.appendChild(chip);
  });
}

function setActiveReport(idx) {
  activeReportIdx = idx;
  renderAll();
}

function removeReport(idx) {
  event.stopPropagation(); // prevent drop zone click
  reports.splice(idx, 1);
  if (activeReportIdx >= reports.length) activeReportIdx = Math.max(0, reports.length - 1);
  if (reports.length === 0) {
    dropZone.classList.remove('has-files');
  }
  // Clean up zone selections referencing removed/shifted reports
  zoneSelections = zoneSelections.filter(s => {
    if (s.reportIdx === idx) return false;
    if (s.reportIdx > idx) s.reportIdx--;
    s.key = s.reportIdx + ':' + s.zoneIdx;
    return true;
  });
  renderAll();
}

// =========================================================
// OVERVIEW TAB
// =========================================================
function renderOverview() {
  const r = reports[activeReportIdx];
  if (!r) return;

  const totalSiteEnergy = r.siteSourceEnergy['Total Site Energy']?.totalEnergy || sumValues(r.annualEndUse);
  const heatingE = r.annualEndUse['Heating'] || 0;
  const coolingE = r.annualEndUse['Cooling'] || 0;
  const areaFt2 = r.buildingArea['Total Building Area'] || r.buildingArea['Net Conditioned Building Area'] || 0;
  const euiVal = areaFt2 > 0 ? totalSiteEnergy / areaFt2 : 0;

  const grid = document.getElementById('statGrid');
  grid.innerHTML = '';
  const stats = [
    { cls: 'total', icon: '&#9889;', label: t('totalEnergy'), value: convertVal(totalSiteEnergy, 'energy'), unit: unitLabel('energy') },
    { cls: 'heating', icon: '&#128293;', label: t('heatingEnergy'), value: convertVal(heatingE, 'energy'), unit: unitLabel('energy') },
    { cls: 'cooling', icon: '&#10052;', label: t('coolingEnergy'), value: convertVal(coolingE, 'energy'), unit: unitLabel('energy') },
    { cls: 'eui', icon: '&#128200;', label: t('eui'), value: convertVal(euiVal, 'eui'), unit: unitLabel('eui') },
    { cls: 'area', icon: '&#127970;', label: t('buildingArea'), value: convertVal(areaFt2, 'area'), unit: unitLabel('area') },
  ];
  stats.forEach(s => {
    const card = document.createElement('div');
    card.className = 'stat-card ' + s.cls;
    card.innerHTML = '<div class="stat-value">' + fmtNum(s.value) + '</div><div class="stat-unit">' + s.unit + '</div><div class="stat-label">' + s.icon + ' ' + s.label + '</div>';
    grid.appendChild(card);
  });

  renderEndUsePie(r);
  renderFuelBar(r);
  renderMonthlyTrend(r);
}

// Fuel type colors - used consistently across fuel bar chart, monthly trend, monthly tab
// Distinct colors for each loaded report (up to 8)
const REPORT_COLORS = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#f97316'];
const REPORT_BG_COLORS = ['#eff6ff', '#fef2f2', '#ecfdf5', '#fffbeb', '#f5f3ff', '#fdf2f8', '#ecfeff', '#fff7ed'];
const REPORT_BORDER_COLORS = ['#bfdbfe', '#fecaca', '#a7f3d0', '#fde68a', '#ddd6fe', '#fbcfe8', '#a5f3fc', '#fed7aa'];

const FUEL_COLORS = {
  Electricity: '#3b82f6',
  'Natural Gas': '#f97316',
  'District Cooling': '#06b6d4',
  'District Heating': '#ef4444',
  Steam: '#8b5cf6',
  Gasoline: '#a3a3a3',
  Diesel: '#78716c',
  Coal: '#44403c',
  'Fuel Oil No 1': '#92400e',
  'Fuel Oil No 2': '#b45309',
  Propane: '#65a30d',
  'Other Fuel 1': '#737373',
  'Other Fuel 2': '#a1a1aa'
};
const FUEL_COLOR_LIST = Object.values(FUEL_COLORS);

const END_USE_COLORS = {
  Heating: '#ef4444', Cooling: '#3b82f6', 'Interior Lighting': '#f59e0b',
  'Exterior Lighting': '#fbbf24', 'Interior Equipment': '#6b7280',
  'Exterior Equipment': '#9ca3af', Fans: '#ec4899', Pumps: '#8b5cf6',
  'Heat Rejection': '#14b8a6', Humidification: '#06b6d4', 'Heat Recovery': '#22c55e',
  'Water Systems': '#0ea5e9', Refrigeration: '#a855f7', Generators: '#64748b'
};

// Generate end-use color palette based on the selected fuel's color
// So that monthly charts use colors consistent with the fuel bar chart
function getEndUseColorForFuel(endUse, fuel) {
  const base = FUEL_COLORS[fuel] || '#94a3b8';
  // Each fuel gets a palette derived from its base color
  // The primary end-use (most important) gets the fuel's exact color
  // Others get complementary shades
  const palettes = {
    Electricity: {
      Cooling: '#3b82f6', Heating: '#1e40af', 'Interior Lighting': '#60a5fa',
      'Interior Equipment': '#93c5fd', Fans: '#2563eb', Pumps: '#1d4ed8',
      'Exterior Lighting': '#bfdbfe', 'Heat Rejection': '#dbeafe',
      Total: '#94a3b8', _default: '#a3bffa'
    },
    'Natural Gas': {
      Heating: '#f97316', Cooling: '#ea580c', 'Interior Equipment': '#fb923c',
      'Water Systems': '#fdba74', 'Interior Lighting': '#fed7aa',
      Total: '#94a3b8', _default: '#ffb380'
    },
    'District Cooling': {
      Cooling: '#06b6d4', Heating: '#0891b2', 'Interior Lighting': '#22d3ee',
      'Interior Equipment': '#67e8f9', Fans: '#0e7490', Pumps: '#155e75',
      Total: '#94a3b8', _default: '#a5f3fc'
    },
    'District Heating': {
      Heating: '#ef4444', Cooling: '#dc2626', 'Interior Lighting': '#f87171',
      'Interior Equipment': '#fca5a5', Fans: '#b91c1c', Pumps: '#991b1b',
      Total: '#94a3b8', _default: '#fecaca'
    }
  };
  const p = palettes[fuel];
  if (p) return p[endUse] || p._default || base;
  // Fallback: use END_USE_COLORS
  return END_USE_COLORS[endUse] || base;
}

function renderEndUsePie(r) {
  const labels = []; const data = []; const colors = [];
  for (const [key, val] of Object.entries(r.annualEndUse)) {
    if (val > 0 && key !== 'Total End Uses') {
      labels.push(tEndUse(key));
      data.push(convertVal(val, 'energy'));
      colors.push(END_USE_COLORS[key] || '#94a3b8');
    }
  }
  destroyChart('endUsePieChart');
  charts.endUsePieChart = new Chart(document.getElementById('endUsePieChart'), {
    type: 'doughnut',
    data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 2, borderColor: '#fff' }] },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right', labels: { font: { size: 12 }, padding: 12 } },
        tooltip: { callbacks: { label: ctx => ctx.label + ': ' + fmtNum(ctx.raw) + ' ' + unitLabel('energy') } },
        datalabels: {
          color: '#fff', font: { weight: 'bold', size: 11 },
          formatter: (v, ctx) => { const total = ctx.dataset.data.reduce((a,b) => a+b, 0); const pct = (v/total*100); return pct > 5 ? pct.toFixed(1)+'%' : ''; }
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}

function renderFuelBar(r) {
  const fuels = []; const fuelKeys = []; const vals = []; const colors = [];
  for (const [key, val] of Object.entries(r.annualFuelUse)) {
    if (val > 0) {
      fuelKeys.push(key);
      fuels.push(tFuel(key));
      vals.push(convertVal(val, 'energy'));
      colors.push(FUEL_COLORS[key] || FUEL_COLOR_LIST[fuelKeys.length % FUEL_COLOR_LIST.length]);
    }
  }
  destroyChart('fuelBarChart');
  const fuelCanvas = document.getElementById('fuelBarChart');
  charts.fuelBarChart = new Chart(fuelCanvas, {
    type: 'bar',
    data: { labels: fuels, datasets: [{ data: vals, backgroundColor: colors, borderRadius: 6 }] },
    options: {
      responsive: true, maintainAspectRatio: false, indexAxis: 'y',
      layout: { padding: { right: 70 } },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: { label: ctx => fmtNum(ctx.raw) + ' ' + unitLabel('energy') },
          footerFont: { style: 'italic', size: 11 },
          footer: () => currentLang === 'ko' ? '클릭하면 월별 분석으로 이동' : 'Click to view monthly detail'
        },
        datalabels: { anchor: 'end', align: 'end', clip: false, font: { weight: 'bold', size: 12 }, formatter: v => fmtNum(v) }
      },
      scales: {
        x: { title: { display: true, text: unitLabel('energy') }, grid: { color: '#f0f0f0' }, grace: '10%' },
        y: { grid: { display: false } }
      },
      onClick: (evt, elements) => {
        if (elements.length > 0) {
          const idx = elements[0].index;
          goToMonthlyFuel(fuelKeys[idx]);
        }
      }
    },
    plugins: [ChartDataLabels]
  });
  fuelCanvas.style.cursor = 'pointer';
}

function renderMonthlyTrend(r) {
  const months = t('months');
  const datasets = [];
  // Use the global FUEL_COLORS for consistency

  for (const [fuel, endUses] of Object.entries(r.monthlyConsumption)) {
    const monthTotals = new Array(12).fill(0);
    for (const [eu, data] of Object.entries(endUses)) {
      data.monthly.forEach((v, i) => { monthTotals[i] += v || 0; });
    }
    const unitType = fuel === 'Electricity' ? 'elecConsumption' : 'gasConsumption';
    const convertedTotals = monthTotals.map(v => {
      if (currentUnit === 'si') return convertVal(v, unitType);
      if (fuel === 'Electricity') return v * 3.412;
      return v * 1000;
    });

    datasets.push({
      label: tFuel(fuel),
      data: convertedTotals,
      borderColor: FUEL_COLORS[fuel] || '#94a3b8',
      backgroundColor: (FUEL_COLORS[fuel] || '#94a3b8') + '20',
      fill: true, tension: 0.4, borderWidth: 2, pointRadius: 4, pointHoverRadius: 6
    });
  }

  const yUnit = currentUnit === 'si' ? 'kWh' : 'kBtu';
  destroyChart('monthlyTrendChart');
  charts.monthlyTrendChart = new Chart(document.getElementById('monthlyTrendChart'), {
    type: 'line',
    data: { labels: months, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false }, datalabels: { display: false } },
      scales: {
        y: { title: { display: true, text: yUnit }, grid: { color: '#f0f0f0' } },
        x: { grid: { display: false } }
      },
      interaction: { mode: 'index', intersect: false }
    }
  });
  buildCustomLegend(charts.monthlyTrendChart, 'legendMonthlyTrend');
}

// =========================================================
// MONTHLY TAB
// =========================================================
// =========================================================
// MONTH CROSS-HIGHLIGHT
// =========================================================
let currentHighlightMonth = -1;
let highlightSource = null; // 'table', 'stacked', 'peak'
let lockedMonth = -1; // persistent month lock on click

function lockMonth(monthIdx, source) {
  if (lockedMonth === monthIdx) {
    // toggle off
    lockedMonth = -1;
    clearHighlightMonth();
    updateMonthFocusBanner();
    return;
  }
  lockedMonth = monthIdx;
  highlightMonth(monthIdx, source || 'stacked');
  updateMonthFocusBanner();
  /* Scroll: from the chart that was clicked, scroll to show the table */
  if (source === 'stacked' || source === 'peak') {
    const tableCard = document.getElementById('monthlyTableWrap')?.closest('.card');
    if (tableCard) tableCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
  } else if (source === 'table') {
    const stackedCard = document.getElementById('monthlyStackedChart')?.closest('.card');
    if (stackedCard) stackedCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

function updateMonthFocusBanner() {
  let banner = document.getElementById('monthFocusBanner');
  if (lockedMonth < 0) {
    if (banner) banner.style.display = 'none';
    return;
  }
  const months = t('months');
  const isKo = currentLang === 'ko';
  if (!banner) {
    banner = document.createElement('div');
    banner.id = 'monthFocusBanner';
    const firstCard = document.querySelector('#tab-monthly .card');
    if (firstCard) firstCard.parentNode.insertBefore(banner, firstCard);
  }
  banner.style.cssText = 'display:flex;align-items:center;gap:12px;padding:12px 20px;margin-bottom:12px;border-radius:12px;background:linear-gradient(135deg,#eff6ff,#dbeafe);border:1px solid #93c5fd;animation:fadeIn .3s';
  banner.innerHTML = '<span style="font-size:1.3rem">&#128197;</span>' +
    '<span style="font-weight:600;color:#1e40af;font-size:.95rem">' + months[lockedMonth] + '</span>' +
    '<span style="color:#3b82f6;font-size:.82rem">' + (isKo ? '선택됨 — 전체 데이터를 확인하세요' : 'Selected — see all data below') + '</span>' +
    '<button onclick="lockMonth(' + lockedMonth + ')" style="margin-left:auto;background:#3b82f6;color:white;border:none;border-radius:8px;padding:5px 14px;font-size:.82rem;cursor:pointer">' + (isKo ? '선택 해제' : 'Deselect') + '</button>';
}

function highlightMonth(monthIdx, source) {
  if (monthIdx === currentHighlightMonth && source === highlightSource) return;
  currentHighlightMonth = monthIdx;
  highlightSource = source || 'table';

  // Highlight table column
  const table = document.querySelector('#monthlyTableWrap table');
  if (table) {
    table.querySelectorAll('th, td').forEach(cell => {
      cell.classList.remove('month-col-highlight');
      cell.classList.remove('month-col-locked');
    });
    if (monthIdx >= 0) {
      const colIdx = monthIdx + 1; // +1 for the first "End Use" column
      const isLocked = lockedMonth === monthIdx;
      table.querySelectorAll('tr').forEach(row => {
        const cells = row.querySelectorAll('th, td');
        if (cells[colIdx]) {
          cells[colIdx].classList.add(isLocked ? 'month-col-locked' : 'month-col-highlight');
        }
      });
    }
  }

  // Trigger chart hover via Chart.js API (skip the source chart to avoid loop)
  const chartPairs = [
    { key: 'stacked', chart: charts.monthlyStackedChart },
    { key: 'peak', chart: charts.monthlyPeakChart }
  ];
  chartPairs.forEach(({ key, chart }) => {
    if (!chart || highlightSource === key) return;
    try {
      if (monthIdx >= 0) {
        // Build active elements for all datasets at this index
        const elems = chart.data.datasets.map((_, di) => ({ datasetIndex: di, index: monthIdx }));
        chart.setActiveElements(elems);
        chart.tooltip.setActiveElements(
          [{ datasetIndex: 0, index: monthIdx }],
          { x: chart.scales.x.getPixelForValue(monthIdx), y: chart.chartArea.top }
        );
      } else {
        chart.setActiveElements([]);
        chart.tooltip.setActiveElements([], { x: 0, y: 0 });
      }
      chart.update('none');
    } catch(e) {}
  });
}

function clearHighlightMonth() {
  /* If a month is locked, revert to the locked state instead of fully clearing */
  if (lockedMonth >= 0) {
    highlightMonth(lockedMonth, 'lock');
    return;
  }
  currentHighlightMonth = -1;
  highlightSource = null;
  const table = document.querySelector('#monthlyTableWrap table');
  if (table) table.querySelectorAll('th, td').forEach(cell => { cell.classList.remove('month-col-highlight'); cell.classList.remove('month-col-locked'); });
  [charts.monthlyStackedChart, charts.monthlyPeakChart].forEach(chart => {
    if (!chart) return;
    try {
      chart.setActiveElements([]);
      chart.tooltip.setActiveElements([], { x: 0, y: 0 });
      chart.update('none');
    } catch(e) {}
  });
}

// Chart.js plugin to draw a vertical highlight band for the active month
const monthHighlightPlugin = {
  id: 'monthHighlight',
  beforeDraw(chart) {
    if (currentHighlightMonth < 0) return;
    const { ctx, chartArea, scales: { x } } = chart;
    if (!x || !chartArea) return;
    const idx = currentHighlightMonth;
    const xPos = x.getPixelForValue(idx);
    const barWidth = x.getPixelForValue(1) - x.getPixelForValue(0);
    const halfW = barWidth / 2;
    ctx.save();
    const isLocked = lockedMonth === currentHighlightMonth;
    ctx.fillStyle = isLocked ? 'rgba(59, 130, 246, 0.18)' : 'rgba(59, 130, 246, 0.08)';
    ctx.fillRect(xPos - halfW, chartArea.top, barWidth, chartArea.bottom - chartArea.top);
    if (isLocked) {
      ctx.strokeStyle = 'rgba(59, 130, 246, 0.35)';
      ctx.lineWidth = 2;
      ctx.setLineDash([4, 3]);
      ctx.strokeRect(xPos - halfW, chartArea.top, barWidth, chartArea.bottom - chartArea.top);
    }
    ctx.restore();
  }
};

function renderMonthlyTab() {
  const r = reports[activeReportIdx];
  if (!r) return;
  /* reset month lock on fuel change */
  lockedMonth = -1;
  currentHighlightMonth = -1;
  const banner = document.getElementById('monthFocusBanner');
  if (banner) banner.style.display = 'none';

  /* Show/hide compare back button */
  const cmpBtn = document.getElementById('monthlyBackCompareBtn');
  if (cmpBtn) {
    cmpBtn.style.display = cameFromCompare ? 'inline-flex' : 'none';
    cmpBtn.innerHTML = t('tabCompare') + ' &#8594;';
  }

  const sel = document.getElementById('monthlyFuelSelect');
  const prevVal = sel.value;
  sel.innerHTML = '';
  // Combine all available fuels from both consumption and peak demand
  const allFuels = new Set([...Object.keys(r.monthlyConsumption), ...Object.keys(r.monthlyPeakDemand)]);
  for (const fuel of allFuels) {
    const opt = document.createElement('option');
    opt.value = fuel;
    opt.textContent = '\u25CF ' + tFuel(fuel);
    opt.style.color = FUEL_COLORS[fuel] || '#94a3b8';
    sel.appendChild(opt);
  }
  if (prevVal && [...sel.options].some(o => o.value === prevVal)) sel.value = prevVal;

  // Update selector border color to match selected fuel
  const fuel = sel.value;
  sel.style.borderColor = FUEL_COLORS[fuel] || 'var(--border)';
  sel.style.borderWidth = '2px';
  renderMonthlyStacked();
  renderMonthlyPeakChart();
  renderMonthlyTable();
  renderDataContext();
}

function renderMonthlyStacked() {
  const r = reports[activeReportIdx];
  const fuel = document.getElementById('monthlyFuelSelect').value;
  if (!fuel || !r.monthlyConsumption[fuel]) return;

  const months = t('months');
  const endUses = r.monthlyConsumption[fuel];
  const datasets = [];
  const unitType = fuel === 'Electricity' ? 'elecConsumption' : 'gasConsumption';

  for (const [eu, data] of Object.entries(endUses)) {
    const hasData = data.monthly.some(v => v > 0);
    if (!hasData) continue;
    datasets.push({
      label: tEndUse(eu),
      data: data.monthly.map(v => convertVal(v || 0, unitType)),
      backgroundColor: getEndUseColorForFuel(eu, fuel),
      borderRadius: 2,
    });
  }

  destroyChart('monthlyStackedChart');
  charts.monthlyStackedChart = new Chart(document.getElementById('monthlyStackedChart'), {
    type: 'bar',
    data: { labels: months, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false }, datalabels: { display: false } },
      scales: {
        x: { stacked: true, grid: { display: false } },
        y: { stacked: true, title: { display: true, text: unitLabel(unitType) }, grid: { color: '#f0f0f0' } }
      },
      interaction: { mode: 'index', intersect: false },
      onHover: (evt, elements, chart) => {
        evt.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
        if (elements.length > 0) highlightMonth(elements[0].index, 'stacked');
        else clearHighlightMonth();
      },
      onClick: (evt, elements) => {
        if (elements.length > 0) lockMonth(elements[0].index, 'stacked');
      }
    },
    plugins: [monthHighlightPlugin]
  });
  buildCustomLegend(charts.monthlyStackedChart, 'legendMonthlyStacked');
  document.getElementById('monthlyStackedChart').addEventListener('mouseleave', clearHighlightMonth);
}

function renderMonthlyPeakChart() {
  const r = reports[activeReportIdx];
  const fuel = document.getElementById('monthlyFuelSelect').value;
  if (!fuel || !r.monthlyPeakDemand[fuel]) {
    destroyChart('monthlyPeakChart');
    const canvas = document.getElementById('monthlyPeakChart');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.font = '14px Segoe UI, sans-serif';
    ctx.fillStyle = '#9ca3af';
    ctx.textAlign = 'center';
    ctx.fillText(currentLang === 'ko' ? '이 연료에 대한 피크 수요 데이터가 없습니다' : 'No peak demand data for this fuel type', canvas.width / 2, canvas.height / 2);
    return;
  }

  const months = t('months');
  const endUses = r.monthlyPeakDemand[fuel];
  const datasets = [];
  const unitType = fuel === 'Electricity' ? 'peakElec' : 'peakGas';

  for (const [eu, data] of Object.entries(endUses)) {
    const hasData = data.monthly.some(v => v > 0);
    if (!hasData) continue;
    const euColor = getEndUseColorForFuel(eu, fuel);
    datasets.push({
      label: tEndUse(eu),
      data: data.monthly.map(v => convertVal(v || 0, unitType)),
      borderColor: euColor,
      backgroundColor: euColor + '40',
      fill: false, tension: 0.3, borderWidth: 2, pointRadius: 4,
    });
  }

  destroyChart('monthlyPeakChart');
  charts.monthlyPeakChart = new Chart(document.getElementById('monthlyPeakChart'), {
    type: 'line',
    data: { labels: months, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false }, datalabels: { display: false } },
      scales: {
        y: { title: { display: true, text: unitLabel(unitType) }, grid: { color: '#f0f0f0' } },
        x: { grid: { display: false } }
      },
      interaction: { mode: 'index', intersect: false },
      onHover: (evt, elements, chart) => {
        evt.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
        if (elements.length > 0) highlightMonth(elements[0].index, 'peak');
        else clearHighlightMonth();
      },
      onClick: (evt, elements) => {
        if (elements.length > 0) lockMonth(elements[0].index, 'peak');
      }
    },
    plugins: [monthHighlightPlugin]
  });
  buildCustomLegend(charts.monthlyPeakChart, 'legendMonthlyPeak');
  document.getElementById('monthlyPeakChart').addEventListener('mouseleave', clearHighlightMonth);
}

function renderMonthlyTable() {
  const r = reports[activeReportIdx];
  const fuel = document.getElementById('monthlyFuelSelect').value;
  if (!fuel || !r.monthlyConsumption[fuel]) return;
  const endUses = r.monthlyConsumption[fuel];
  const months = t('months');
  const unitType = fuel === 'Electricity' ? 'elecConsumption' : 'gasConsumption';

  let html = '<table class="data-table"><tr><th>' + (currentLang === 'ko' ? '\uC6A9\uB3C4' : 'End Use') + '</th>';
  months.forEach((m, mi) => html += '<th data-month="' + mi + '" style="cursor:pointer" onmouseenter="highlightMonth(' + mi + ')" onmouseleave="clearHighlightMonth()" onclick="lockMonth(' + mi + ',\'table\')">' + m + '</th>');
  html += '<th>' + (currentLang === 'ko' ? '\uD569\uACC4' : 'Total') + '</th></tr>';

  for (const [eu, data] of Object.entries(endUses)) {
    const hasData = data.monthly.some(v => v > 0);
    if (!hasData && eu !== 'Total') continue; // hide zero rows
    const isTotal = eu === 'Total';
    html += '<tr' + (isTotal ? ' class="total-row"' : '') + '>';
    html += '<td>' + tEndUse(eu) + '</td>';
    data.monthly.forEach((v, mi) => {
      if (v > 0) html += '<td data-month="' + mi + '" style="cursor:pointer" onmouseenter="highlightMonth(' + mi + ')" onmouseleave="clearHighlightMonth()" onclick="lockMonth(' + mi + ',\'table\')">' + fmtNum(convertVal(v, unitType), 2) + '</td>';
      else html += '<td data-month="' + mi + '" class="empty-cell" style="cursor:pointer" onmouseenter="highlightMonth(' + mi + ')" onmouseleave="clearHighlightMonth()" onclick="lockMonth(' + mi + ',\'table\')">\u2014</td>';
    });
    const total = data.total || data.monthly.reduce((a,b) => a+(b||0), 0);
    html += '<td><strong>' + fmtNum(convertVal(total, unitType), 2) + '</strong></td>';
    html += '</tr>';
  }
  html += '</table>';
  document.getElementById('monthlyTableWrap').innerHTML = html;
}

// =========================================================
// DATA CONTEXT - Help non-experts understand the numbers
// =========================================================
function renderDataContext() {
  const r = reports[activeReportIdx];
  const fuel = document.getElementById('monthlyFuelSelect').value;
  if (!r || !fuel || !r.monthlyConsumption[fuel]) return;
  const container = document.getElementById('dataContextContent');
  const endUses = r.monthlyConsumption[fuel];
  const unitType = fuel === 'Electricity' ? 'elecConsumption' : 'gasConsumption';
  const area = r.buildingArea['Total Building Area'] || 0;
  const areaM2 = area * 0.092903;
  const isKo = currentLang === 'ko';

  let lines = [];

  // Calculate totals per end use
  const euTotals = {};
  let grandTotal = 0;
  for (const [eu, data] of Object.entries(endUses)) {
    if (eu === 'Total') continue;
    const total = data.total || data.monthly.reduce((a,b) => a+(b||0), 0);
    if (total > 0) {
      euTotals[eu] = total;
      grandTotal += total;
    }
  }

  if (grandTotal === 0) {
    container.innerHTML = isKo
      ? '<p>\uC774 \uC5F0\uB8CC \uC720\uD615\uC5D0 \uD574\uB2F9\uD558\uB294 \uC18C\uBE44 \uB370\uC774\uD130\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.</p>'
      : '<p>No consumption data for this fuel type.</p>';
    return;
  }

  // Practical context for electricity (kWh)
  if (fuel === 'Electricity') {
    const totalKwh = grandTotal; // already in kWh
    const monthlyAvg = totalKwh / 12;
    // Korean household avg: ~300 kWh/month
    const householdEquiv = (monthlyAvg / 300).toFixed(1);
    // Electricity cost rough estimate: ~120 won/kWh (Korea avg)
    const annualCostWon = totalKwh * 120;
    const annualCostUSD = totalKwh * 0.10;

    // Find peak month
    const monthTotals = new Array(12).fill(0);
    for (const data of Object.values(endUses)) {
      data.monthly.forEach((v,i) => monthTotals[i] += v || 0);
    }
    const peakMonthIdx = monthTotals.indexOf(Math.max(...monthTotals));
    const peakMonthName = t('months')[peakMonthIdx];
    const peakVal = monthTotals[peakMonthIdx];
    const lowMonthIdx = monthTotals.indexOf(Math.min(...monthTotals.filter(v => v > 0)));
    const lowMonthName = t('months')[lowMonthIdx];
    const lowVal = monthTotals[lowMonthIdx];
    const peakToLowRatio = lowVal > 0 ? (peakVal / lowVal).toFixed(1) : '-';

    if (isKo) {
      lines.push('<b>\uC5F0\uAC04 \uCD1D \uC804\uAE30 \uC0AC\uC6A9\uB7C9:</b> ' + fmtNum(totalKwh) + ' kWh \u2014 \uC6D4\uD3C9\uADE0 \uC57D ' + fmtNum(monthlyAvg) + ' kWh');
      lines.push('\uC774\uB294 \uC77C\uBC18 \uAC00\uC815(\uC6D4 300kWh \uAE30\uC900) \uC57D <b>' + householdEquiv + '\uAC00\uAD6C</b>\uAC00 \uC0AC\uC6A9\uD558\uB294 \uC804\uB825\uB7C9\uC5D0 \uD574\uB2F9\uD569\uB2C8\uB2E4.');
      lines.push('\uCD94\uC815 \uC5F0\uAC04 \uC804\uAE30\uC694\uAE08: \uC57D <b>' + fmtNum(annualCostWon/10000) + '\uB9CC\uC6D0</b> (\u20A9120/kWh \uAE30\uC900)');
      lines.push('<b>\uD53C\uD06C \uC6D4:</b> ' + peakMonthName + ' (' + fmtNum(peakVal) + ' kWh) &nbsp;|&nbsp; <b>\uCD5C\uC800 \uC6D4:</b> ' + lowMonthName + ' (' + fmtNum(lowVal) + ' kWh) &nbsp;|&nbsp; \uD53C\uD06C/\uCD5C\uC800 \uBE44\uC728: <b>' + peakToLowRatio + '\uBC30</b>');
    } else {
      lines.push('<b>Annual electricity:</b> ' + fmtNum(totalKwh) + ' kWh \u2014 monthly average ~' + fmtNum(monthlyAvg) + ' kWh');
      lines.push('Equivalent to about <b>' + householdEquiv + ' average households</b> (based on 300 kWh/month per household).');
      lines.push('Estimated annual cost: ~<b>$' + fmtNum(annualCostUSD) + '</b> (at $0.10/kWh) or ~<b>' + fmtNum(annualCostWon/10000) + ' \uB9CC\uC6D0</b> (at \u20A9120/kWh)');
      lines.push('<b>Peak month:</b> ' + peakMonthName + ' (' + fmtNum(peakVal) + ' kWh) &nbsp;|&nbsp; <b>Lowest:</b> ' + lowMonthName + ' (' + fmtNum(lowVal) + ' kWh) &nbsp;|&nbsp; Peak/Low ratio: <b>' + peakToLowRatio + 'x</b>');
    }

    // Per end-use context
    for (const [eu, total] of Object.entries(euTotals)) {
      const pct = (total / grandTotal * 100).toFixed(1);
      const perMonth = total / 12;
      if (isKo) {
        if (eu === 'Cooling') lines.push('<span style="color:var(--cooling)">\u25CF</span> <b>\uB0C9\uBC29:</b> \uC5F0\uAC04 ' + fmtNum(total) + ' kWh (' + pct + '%) \u2014 \uC5EC\uB984\uCCA0(6~8\uC6D4) \uC804\uAE30\uC694\uAE08\uC758 \uC8FC\uC694 \uC6D0\uC778\uC785\uB2C8\uB2E4.');
        else if (eu === 'Fans') lines.push('<span style="color:var(--fans)">\u25CF</span> <b>\uD32C:</b> \uC5F0\uAC04 ' + fmtNum(total) + ' kWh (' + pct + '%) \u2014 \uACF5\uC870\uAE30 \uC1A1\uD48D\uAE30 \uC804\uB825\uC73C\uB85C, \uC5F0\uC911 \uAC00\uB3D9\uB429\uB2C8\uB2E4.');
        else if (eu === 'Interior Lighting') lines.push('<span style="color:var(--lighting)">\u25CF</span> <b>\uC2E4\uB0B4\uC870\uBA85:</b> \uC5F0\uAC04 ' + fmtNum(total) + ' kWh (' + pct + '%) \u2014 \uC6D4 \uC57D ' + fmtNum(perMonth) + ' kWh\uB85C \uBE44\uAD50\uC801 \uC77C\uC815\uD569\uB2C8\uB2E4.');
        else if (eu === 'Interior Equipment') lines.push('<span style="color:var(--equipment)">\u25CF</span> <b>\uC2E4\uB0B4\uC7A5\uBE44:</b> \uC5F0\uAC04 ' + fmtNum(total) + ' kWh (' + pct + '%) \u2014 PC, \uBCF5\uD569\uAE30 \uB4F1 \uC0AC\uBB34\uAE30\uAE30 \uC804\uB825\uC785\uB2C8\uB2E4.');
        else if (eu === 'Pumps') lines.push('<span style="color:var(--pumps)">\u25CF</span> <b>\uD38C\uD504:</b> \uC5F0\uAC04 ' + fmtNum(total) + ' kWh (' + pct + '%) \u2014 \uB0C9\uB09C\uBC29 \uBC30\uAD00 \uC21C\uD658 \uD38C\uD504 \uC804\uB825\uC785\uB2C8\uB2E4.');
        else lines.push('<b>' + tEndUse(eu) + ':</b> \uC5F0\uAC04 ' + fmtNum(total) + ' kWh (' + pct + '%)');
      } else {
        if (eu === 'Cooling') lines.push('<span style="color:var(--cooling)">\u25CF</span> <b>Cooling:</b> ' + fmtNum(total) + ' kWh/yr (' + pct + '%) \u2014 drives summer electricity bills (Jun\u2013Aug).');
        else if (eu === 'Fans') lines.push('<span style="color:var(--fans)">\u25CF</span> <b>Fans:</b> ' + fmtNum(total) + ' kWh/yr (' + pct + '%) \u2014 HVAC air distribution, runs year-round.');
        else if (eu === 'Interior Lighting') lines.push('<span style="color:var(--lighting)">\u25CF</span> <b>Interior Lighting:</b> ' + fmtNum(total) + ' kWh/yr (' + pct + '%) \u2014 ~' + fmtNum(perMonth) + ' kWh/month, fairly constant.');
        else if (eu === 'Interior Equipment') lines.push('<span style="color:var(--equipment)">\u25CF</span> <b>Interior Equipment:</b> ' + fmtNum(total) + ' kWh/yr (' + pct + '%) \u2014 computers, copiers, appliances.');
        else if (eu === 'Pumps') lines.push('<span style="color:var(--pumps)">\u25CF</span> <b>Pumps:</b> ' + fmtNum(total) + ' kWh/yr (' + pct + '%) \u2014 hot/chilled water circulation.');
        else lines.push('<b>' + tEndUse(eu) + ':</b> ' + fmtNum(total) + ' kWh/yr (' + pct + '%)');
      }
    }

    if (areaM2 > 0) {
      const kwhPerM2 = totalKwh / areaM2;
      if (isKo) lines.push('\uB2E8\uC704\uBA74\uC801\uB2F9 \uC804\uAE30: <b>' + fmtNum(kwhPerM2) + ' kWh/m\u00B2\u00B7\uB144</b> (\uC77C\uBC18 \uC0AC\uBB34\uC2E4 \uAE30\uC900 80~150 kWh/m\u00B2)');
      else lines.push('Electricity intensity: <b>' + fmtNum(kwhPerM2) + ' kWh/m\u00B2\u00B7yr</b> (typical office: 80\u2013150 kWh/m\u00B2)');
    }
  }
  // Natural Gas
  else if (fuel === 'Natural Gas') {
    // MBtu values
    const totalMBtu = grandTotal;
    const totalKwh = totalMBtu * 293.071;
    const annualCostWon = totalKwh * 60; // ~60 won/kWh equiv for gas
    const monthTotals = new Array(12).fill(0);
    for (const data of Object.values(endUses)) {
      data.monthly.forEach((v,i) => monthTotals[i] += v || 0);
    }
    const peakMonthIdx = monthTotals.indexOf(Math.max(...monthTotals));
    const peakMonthName = t('months')[peakMonthIdx];
    const lowMonthIdx = monthTotals.indexOf(Math.min(...monthTotals.filter(v => v > 0)));
    const lowMonthName = t('months')[lowMonthIdx > -1 ? lowMonthIdx : 0];

    if (isKo) {
      lines.push('<b>\uC5F0\uAC04 \uCD1D \uAC00\uC2A4 \uC0AC\uC6A9\uB7C9:</b> ' + fmtNum(totalMBtu) + ' MBtu (\u2248' + fmtNum(totalKwh) + ' kWh \uD658\uC0B0)');
      lines.push('\uCD94\uC815 \uC5F0\uAC04 \uAC00\uC2A4\uC694\uAE08: \uC57D <b>' + fmtNum(annualCostWon/10000) + '\uB9CC\uC6D0</b>');
      lines.push('\uAC00\uC2A4\uB294 \uC8FC\uB85C <b>\uB09C\uBC29\uC6A9</b>\uC73C\uB85C \uC0AC\uC6A9\uB418\uBA70, \uACA8\uC6B8\uCCA0(12~2\uC6D4)\uC5D0 \uC9D1\uC911\uB429\uB2C8\uB2E4.');
      lines.push('<b>\uD53C\uD06C \uC6D4:</b> ' + peakMonthName + ' &nbsp;|&nbsp; <b>\uCD5C\uC800 \uC6D4:</b> ' + lowMonthName + ' \u2014 \uACA8\uC6B8\uACFC \uC5EC\uB984\uC758 \uCC28\uC774\uAC00 \uD06C\uBA70 \uB2E8\uC5F4 \uC131\uB2A5\uC774 \uC911\uC694\uD569\uB2C8\uB2E4.');
    } else {
      lines.push('<b>Annual gas:</b> ' + fmtNum(totalMBtu) + ' MBtu (\u2248' + fmtNum(totalKwh) + ' kWh equivalent)');
      lines.push('Gas is primarily used for <b>heating</b>, peaking in winter months (Dec\u2013Feb).');
      lines.push('<b>Peak month:</b> ' + peakMonthName + ' &nbsp;|&nbsp; <b>Lowest:</b> ' + lowMonthName + ' \u2014 large seasonal variation indicates insulation matters.');
    }
  }
  // District Heating / Cooling
  else {
    const totalMBtu = grandTotal;
    const totalKwh = totalMBtu * 293.071;
    const isHeating = fuel.includes('Heating');
    if (isKo) {
      lines.push('<b>\uC5F0\uAC04 \uCD1D ' + tFuel(fuel) + ':</b> ' + fmtNum(totalMBtu) + ' MBtu (\u2248' + fmtNum(totalKwh) + ' kWh)');
      if (isHeating) lines.push('\uC9C0\uC5ED\uB09C\uBC29\uC740 \uACA8\uC6B8\uCCA0\uC5D0 \uC9D1\uC911\uB418\uBA70, \uAC74\uBB3C \uC678\uD53C \uB2E8\uC5F4 \uC131\uB2A5\uC5D0 \uD06C\uAC8C \uC601\uD5A5\uBC1B\uC2B5\uB2C8\uB2E4.');
      else lines.push('\uC9C0\uC5ED\uB0C9\uBC29\uC740 \uC5EC\uB984\uCCA0\uC5D0 \uC9D1\uC911\uB418\uBA70, \uCC3D\uD638 \uC131\uB2A5\uACFC \uC77C\uC0AC\uCC28\uB2E8\uC774 \uC911\uC694\uD569\uB2C8\uB2E4.');
    } else {
      lines.push('<b>Annual ' + tFuel(fuel) + ':</b> ' + fmtNum(totalMBtu) + ' MBtu (\u2248' + fmtNum(totalKwh) + ' kWh)');
      if (isHeating) lines.push('District heating peaks in winter and is heavily influenced by envelope insulation.');
      else lines.push('District cooling peaks in summer and is influenced by glazing and solar shading.');
    }
  }

  container.innerHTML = lines.map(l => '<p style="margin-bottom:6px">' + l + '</p>').join('');
}

// =========================================================
// COMPARE TAB
// =========================================================
function renderCompareTab() {
  const container = document.getElementById('compareContent');
  if (reports.length < 2) {
    container.innerHTML = '<div class="empty-state"><div class="icon">&#128202;</div><h3>' + t('noComparison') + '</h3></div>';
    return;
  }

  container.innerHTML = '<div class="card" id="compareChartCard">' +
    '<div class="card-title"><span class="icon">&#128202;</span> <span>' + t('compareTitle') + '</span></div>' +
    '<div class="compare-selector">' +
    '<span class="compare-label">' + t('compareMetric') + ':</span>' +
    '<select id="compareMetricSelect" onchange="renderCompareCharts()">' +
    '<option value="totalSite">' + t('totalSiteEnergy') + '</option>' +
    '<option value="heating">' + t('heatingOnly') + '</option>' +
    '<option value="cooling">' + t('coolingOnly') + '</option>' +
    '<option value="allEndUse">' + t('allEndUse') + '</option>' +
    '<option value="monthlyTotal">' + t('monthlyTrend') + '</option>' +
    '</select></div>' +
    '<div id="legendCompareChart" class="chart-legend"></div>' +
    '<div class="chart-container" style="height:400px"><canvas id="compareChart"></canvas></div>' +
    '</div>' +
    '<div class="card" id="compareTableCard">' +
    '<div class="card-title"><span class="icon">&#128203;</span> <span>' + (currentLang === 'ko' ? '\uBE44\uAD50 \uD14C\uC774\uBE14' : 'Comparison Table') + '</span></div>' +
    '<div class="table-wrap" id="compareTableWrap"></div>' +
    '</div>';
  renderCompareCharts();
}

function renderCompareCharts() {
  const metric = document.getElementById('compareMetricSelect')?.value || 'totalSite';
  const months = t('months');
  const reportLabels = getReportLabels();

  if (metric === 'monthlyTotal') {
    const datasets = [];
    const palette = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];
    reports.forEach((r, i) => {
      const monthTotals = new Array(12).fill(0);
      for (const [fuel, endUses] of Object.entries(r.monthlyConsumption)) {
        for (const [eu, data] of Object.entries(endUses)) {
          data.monthly.forEach((v, mi) => {
            const converted = fuel === 'Electricity' ? (v||0) * 3.412 : (v||0) * 1000;
            monthTotals[mi] += currentUnit === 'si' ? converted * 0.293071 : converted;
          });
        }
      }
      datasets.push({
        label: reportLabels[i],
        data: monthTotals,
        borderColor: palette[i % palette.length],
        backgroundColor: palette[i % palette.length] + '20',
        fill: false, tension: 0.4, borderWidth: 3, pointRadius: 5
      });
    });

    destroyChart('compareChart');
    charts.compareChart = new Chart(document.getElementById('compareChart'), {
      type: 'line',
      data: { labels: months, datasets },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false }, datalabels: { display: false } },
        scales: {
          y: { title: { display: true, text: unitLabel('energy') }, grid: { color: '#f0f0f0' } },
          x: { grid: { display: false } }
        },
        interaction: { mode: 'index', intersect: false }
      }
    });
    buildCustomLegend(charts.compareChart, 'legendCompareChart');
    const hint = document.getElementById('compareChartHint');
    if (hint) hint.style.display = 'none';
  }
  else if (metric === 'allEndUse') {
    const endUseKeys = ['Heating', 'Cooling', 'Interior Lighting', 'Interior Equipment', 'Fans', 'Pumps'];
    const datasets = endUseKeys.map(eu => ({
      label: tEndUse(eu),
      data: reports.map(r => convertVal(r.annualEndUse[eu] || 0, 'energy')),
      backgroundColor: END_USE_COLORS[eu],
    }));

    destroyChart('compareChart');
    charts.compareChart = new Chart(document.getElementById('compareChart'), {
      type: 'bar',
      data: { labels: reportLabels, datasets },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: false }, datalabels: { display: false },
          tooltip: {
            footerFont: { style: 'italic', size: 11 },
            footer: () => currentLang === 'ko' ? '클릭하면 월별 분석으로 이동' : 'Click for monthly detail'
          }
        },
        scales: {
          x: { stacked: true, grid: { display: false } },
          y: { stacked: true, title: { display: true, text: unitLabel('energy') }, grid: { color: '#f0f0f0' } }
        },
        onHover: (evt, elements) => {
          evt.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
        },
        onClick: (evt, elements) => {
          if (elements.length > 0) {
            const idx = elements[0].index;
            activeReportIdx = idx;
            renderFileChips();
            cameFromCompare = true;
            switchTab('monthly');
          }
        }
      }
    });
    buildCustomLegend(charts.compareChart, 'legendCompareChart');
    let hint2 = document.getElementById('compareChartHint');
    if (!hint2) {
      hint2 = document.createElement('p');
      hint2.id = 'compareChartHint';
      hint2.style.cssText = 'text-align:center;font-size:.75rem;color:var(--primary);margin:6px 0 0;opacity:.7';
      const chartCanvas = document.getElementById('compareChart');
      if (chartCanvas) chartCanvas.closest('.chart-container').after(hint2);
    }
    hint2.textContent = currentLang === 'ko' ? '막대를 클릭하면 해당 보고서의 월별 분석으로 이동합니다 →' : 'Click a bar to view that report\'s monthly analysis →';
    hint2.style.display = 'block';
  }
  else {
    let data;
    if (metric === 'totalSite') {
      data = reports.map(r => convertVal(r.siteSourceEnergy['Total Site Energy']?.totalEnergy || sumValues(r.annualEndUse), 'energy'));
    } else if (metric === 'heating') {
      data = reports.map(r => convertVal(r.annualEndUse['Heating'] || 0, 'energy'));
    } else {
      data = reports.map(r => convertVal(r.annualEndUse['Cooling'] || 0, 'energy'));
    }
    destroyChart('compareChart');
    charts.compareChart = new Chart(document.getElementById('compareChart'), {
      type: 'bar',
      data: {
        labels: reportLabels,
        datasets: [{ data, backgroundColor: REPORT_COLORS.slice(0, reports.length), borderRadius: 8 }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        layout: { padding: { top: 30 } },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: { label: ctx => fmtNum(ctx.raw) + ' ' + unitLabel('energy') },
            footerFont: { style: 'italic', size: 11 },
            footer: () => currentLang === 'ko' ? '클릭하면 월별 분석으로 이동' : 'Click for monthly detail'
          },
          datalabels: { anchor: 'end', align: 'end', font: { weight: 'bold', size: 12 }, formatter: v => fmtNum(v) }
        },
        scales: {
          y: { title: { display: true, text: unitLabel('energy') }, grid: { color: '#f0f0f0' }, grace: '15%' },
          x: { grid: { display: false } }
        },
        onHover: (evt, elements) => {
          evt.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
        },
        onClick: (evt, elements) => {
          if (elements.length > 0) {
            const idx = elements[0].index;
            activeReportIdx = idx;
            renderFileChips();
            cameFromCompare = true;
            /* try to match metric to a fuel with that end-use */
            const cmpMetric = document.getElementById('compareMetricSelect')?.value || 'totalSite';
            if (cmpMetric === 'heating' || cmpMetric === 'cooling') {
              const targetEU = cmpMetric === 'heating' ? 'Heating' : 'Cooling';
              const r = reports[idx];
              const fuels = Object.keys(r.monthlyConsumption || {});
              const matchFuel = fuels.find(f => {
                const eus = r.monthlyConsumption[f];
                return eus[targetEU] && eus[targetEU].monthly.some(v => v > 0);
              });
              if (matchFuel) {
                switchTab('monthly');
                const sel = document.getElementById('monthlyFuelSelect');
                if (sel) { sel.value = matchFuel; renderMonthlyTab(); }
                return;
              }
            }
            switchTab('monthly');
          }
        }
      },
      plugins: [ChartDataLabels]
    });
    const lcl = document.getElementById('legendCompareChart');
    if (lcl) lcl.innerHTML = '';
    /* Add hint below chart for single-metric views */
    let cmpHint = document.getElementById('compareChartHint');
    if (!cmpHint) {
      cmpHint = document.createElement('p');
      cmpHint.id = 'compareChartHint';
      cmpHint.style.cssText = 'text-align:center;font-size:.75rem;color:var(--primary);margin:6px 0 0;opacity:.7';
      const chartCanvas = document.getElementById('compareChart');
      if (chartCanvas) chartCanvas.closest('.chart-container').after(cmpHint);
    }
    cmpHint.textContent = currentLang === 'ko' ? '막대를 클릭하면 해당 보고서의 월별 분석으로 이동합니다 →' : 'Click a bar to view that report\'s monthly analysis →';
    cmpHint.style.display = 'block';
  }

  renderCompareTable();
}

function renderCompareTable() {
  const wrap = document.getElementById('compareTableWrap');
  if (!wrap) return;

  const endUseKeys = ['Heating', 'Cooling', 'Interior Lighting', 'Interior Equipment', 'Fans', 'Pumps', 'Heat Rejection', 'Water Systems'];
  const cmpLabels = getReportLabels();
  let html = '<table class="data-table"><tr><th>' + (currentLang === 'ko' ? '\uD56D\uBAA9' : 'Metric') + '</th>';
  reports.forEach((r, i) => {
    html += '<th>' + cmpLabels[i] + '</th>';
  });
  html += '</tr>';

  html += '<tr class="total-row"><td>' + t('totalEnergy') + '</td>';
  reports.forEach(r => {
    const v = convertVal(r.siteSourceEnergy['Total Site Energy']?.totalEnergy || sumValues(r.annualEndUse), 'energy');
    html += '<td>' + fmtNum(v) + ' ' + unitLabel('energy') + '</td>';
  });
  html += '</tr>';

  html += '<tr><td>' + t('eui') + '</td>';
  reports.forEach(r => {
    const total = r.siteSourceEnergy['Total Site Energy']?.totalEnergy || sumValues(r.annualEndUse);
    const area = r.buildingArea['Total Building Area'] || 0;
    const eui = area > 0 ? total / area : 0;
    html += '<td>' + fmtNum(convertVal(eui, 'eui')) + ' ' + unitLabel('eui') + '</td>';
  });
  html += '</tr>';

  endUseKeys.forEach(eu => {
    const anyHasIt = reports.some(r => (r.annualEndUse[eu] || 0) > 0);
    if (!anyHasIt) return;
    html += '<tr><td>' + tEndUse(eu) + '</td>';
    reports.forEach(r => {
      const v = convertVal(r.annualEndUse[eu] || 0, 'energy');
      html += '<td>' + fmtNum(v) + '</td>';
    });
    html += '</tr>';
  });

  html += '</table>';
  wrap.innerHTML = html;
}

// =========================================================
// COMPARE - Sub-tab switching
// =========================================================
function switchCompareSub(name) {
  document.querySelectorAll('.cmp-sub-content').forEach(el => el.style.display = 'none');
  document.querySelectorAll('#tab-compare .api-subtab').forEach(el => el.classList.remove('active'));
  const panel = document.getElementById('cmpSub-' + name);
  if (panel) panel.style.display = 'block';
  const btn = document.getElementById('cmpSub' + name.charAt(0).toUpperCase() + name.slice(1));
  if (btn) btn.classList.add('active');
  if (name === 'zone') renderZoneCompare();
  setTimeout(renderSectionNav, 100);
}

// =========================================================
// ZONE COMPARISON
// =========================================================
function renderZoneCompare() {
  const container = document.getElementById('zoneCompareContent');
  if (reports.length < 2) {
    container.innerHTML = '<div class="empty-state"><div class="icon">&#128202;</div><h3>' + t('noComparison') + '</h3></div>';
    return;
  }

  // Find common zone names across all reports
  const zoneSets = reports.map(r => new Set((r.zoneDetail || []).map(z => z.name)));
  let commonZones = [...zoneSets[0]];
  for (let i = 1; i < zoneSets.length; i++) {
    commonZones = commonZones.filter(name => zoneSets[i].has(name));
  }
  commonZones.sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));

  if (commonZones.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="icon">&#128202;</div><h3>' + t('cmpNoZone') + '</h3></div>';
    return;
  }

  const isKo = currentLang === 'ko';
  let html = '<div class="card" style="padding:16px 24px;margin-bottom:16px">';
  html += '<p style="font-size:.85rem;color:var(--text-secondary);margin-bottom:12px">' + t('cmpZoneDesc') + '</p>';
  html += '<div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">';
  html += '<span style="font-weight:600;font-size:.9rem;color:var(--text-secondary)">' + t('cmpZoneSelect') + ':</span>';
  html += '<select id="zoneCompareSelect" onchange="renderZoneCompareDetail()" style="padding:8px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:.9rem;background:white;min-width:280px">';
  commonZones.forEach(zn => {
    html += '<option value="' + zn + '">' + zn + '</option>';
  });
  html += '</select>';
  html += '<span style="font-size:.8rem;color:var(--text-secondary)">(' + commonZones.length + (isKo ? '개 공통 존' : ' common zones') + ')</span>';
  html += '</div></div>';
  html += '<div id="zoneCompareDetailWrap"></div>';
  container.innerHTML = html;
  renderZoneCompareDetail();
}

function renderZoneCompareDetail() {
  const sel = document.getElementById('zoneCompareSelect');
  if (!sel) return;
  const zoneName = sel.value;
  const wrap = document.getElementById('zoneCompareDetailWrap');
  const isKo = currentLang === 'ko';

  // Get zone data from each report
  const zoneData = reports.map(r => {
    const z = (r.zoneDetail || []).find(z => z.name === zoneName);
    return { report: r, zone: z };
  }).filter(d => d.zone);

  if (zoneData.length < 2) {
    wrap.innerHTML = '<p style="padding:20px;color:var(--text-secondary)">Not enough data to compare.</p>';
    return;
  }

  const allLabels = getReportLabels();
  const fileNames = zoneData.map(d => {
    const idx = reports.indexOf(d.report);
    return allLabels[idx] || d.report.fileName.replace(/\.htm[l]?$/i, '');
  });

  // Build comparison table
  function row(label, getter, unit, explain) {
    let html = '<tr><td title="' + (explain || '') + '">' + label + (explain ? ' <span style="color:var(--text-secondary);font-size:.7rem">(?)</span>' : '') + '</td>';
    const values = zoneData.map(d => getter(d.zone));
    const maxV = Math.max(...values.filter(v => !isNaN(v)));
    const minV = Math.min(...values.filter(v => !isNaN(v)));
    values.forEach(v => {
      let cls = '';
      if (maxV !== minV && !isNaN(v)) {
        if (v === maxV) cls = ' style="color:#dc2626;font-weight:700"';
        else if (v === minV) cls = ' style="color:#2563eb;font-weight:700"';
      }
      html += '<td' + cls + '>' + (isNaN(v) ? '\u2014' : fmtNum(v, 2)) + (unit ? ' <span style="font-size:.75rem;color:var(--text-secondary)">' + unit + '</span>' : '') + '</td>';
    });
    // Diff column
    if (zoneData.length === 2 && !isNaN(values[0]) && !isNaN(values[1])) {
      const diff = values[1] - values[0];
      const pct = values[0] !== 0 ? ((diff / Math.abs(values[0])) * 100) : 0;
      const sign = diff > 0 ? '+' : '';
      const color = Math.abs(diff) < 0.001 ? 'var(--text-secondary)' : (diff > 0 ? '#dc2626' : '#2563eb');
      html += '<td style="color:' + color + ';font-weight:600">' + sign + fmtNum(diff, 2) + ' (' + sign + fmtNum(pct, 1) + '%)</td>';
    } else if (zoneData.length === 2) {
      html += '<td>\u2014</td>';
    }
    html += '</tr>';
    return html;
  }

  const aU = unitLabel('area');
  let html = '<div class="card" id="zoneCompareDetailCard">';
  html += '<div class="card-title"><span class="icon">&#128202;</span> ' + zoneName + ' \u2014 ' + (isKo ? '\uC874 \uBE44\uAD50' : 'Zone Comparison') + '</div>';

  // Legend
  if (zoneData.length === 2) {
    html += '<p style="font-size:.78rem;color:var(--text-secondary);margin-bottom:12px">';
    html += (isKo ? '\uBE68\uAC04\uC0C9 = \uB354 \uD070 \uAC12, \uD30C\uB780\uC0C9 = \uB354 \uC791\uC740 \uAC12, \uCC28\uC774 = \uBCF4\uACE0\uC11C2 - \uBCF4\uACE0\uC11C1' : 'Red = higher value, Blue = lower value, Diff = Report2 \u2212 Report1');
    html += '</p>';
  }

  html += '<div class="table-wrap"><table class="data-table"><tr><th>' + (isKo ? '\uD56D\uBAA9' : 'Property') + '</th>';
  zoneData.forEach((d, di) => {
    const rIdx = reports.indexOf(d.report);
    html += '<th style="cursor:pointer" onclick="goToZoneDetailFromCompare(' + rIdx + ',\'' + zoneName.replace(/'/g, "\\'") + '\')" title="' + (isKo ? '클릭하면 이 보고서의 존 상세로 이동' : 'Click to view zone detail in this report') + '">';
    html += fileNames[di];
    html += ' <span style="font-size:.7rem;color:var(--primary);font-weight:400">&#8594;</span>';
    html += '</th>';
  });
  if (zoneData.length === 2) html += '<th>' + (isKo ? '\uCC28\uC774' : 'Difference') + '</th>';
  html += '</tr>';

  // Basic
  html += '<tr class="total-row"><td colspan="' + (fileNames.length + 1 + (zoneData.length === 2 ? 1 : 0)) + '" style="text-align:left;font-weight:700">' + t('zoneBasicInfo') + '</td></tr>';
  html += row(isKo ? '\uBC14\uB2E5 \uBA74\uC801' : 'Floor Area', z => convertVal(z.area || 0, 'area'), aU);
  html += row(isKo ? '\uCCB4\uC801' : 'Volume', z => currentUnit === 'si' ? (z.volume || 0) * 0.0283168 : (z.volume || 0), currentUnit === 'si' ? 'm\u00B3' : 'ft\u00B3');
  html += row(isKo ? '\uCCA8\uC7A5 \uB192\uC774' : 'Ceiling Height', z => currentUnit === 'si' ? (z.ceilingHeight || 0) * 0.3048 : (z.ceilingHeight || 0), currentUnit === 'si' ? 'm' : 'ft');

  // Envelope
  html += '<tr class="total-row"><td colspan="' + (fileNames.length + 1 + (zoneData.length === 2 ? 1 : 0)) + '" style="text-align:left;font-weight:700">' + t('zoneEnvelope') + '</td></tr>';
  html += row(isKo ? '\uC678\uBCBD \uCD1D \uBA74\uC801' : 'Gross Wall Area', z => convertVal(z.grossWallArea || 0, 'area'), aU);
  html += row(isKo ? '\uCC3D\uD638 \uBA74\uC801' : 'Window Area', z => convertVal(z.windowArea || 0, 'area'), aU);
  html += row(isKo ? 'WWR (%)' : 'WWR (%)', z => z.grossWallArea > 0 ? (z.windowArea / z.grossWallArea * 100) : 0, '%');

  // Internal Loads
  html += '<tr class="total-row"><td colspan="' + (fileNames.length + 1 + (zoneData.length === 2 ? 1 : 0)) + '" style="text-align:left;font-weight:700">' + t('zoneInternalLoad') + '</td></tr>';
  html += row(isKo ? '\uC7AC\uC2E4 \uC778\uC6D0' : 'Occupants', z => z.people?.count || 0, isKo ? '\uBA85' : '');
  html += row(isKo ? '\uC870\uBA85 \uBC00\uB3C4' : 'Lighting Density', z => currentUnit === 'si' ? (z.lightingDensity || 0) * 0.293071 * 10.764 : (z.lightingDensity || 0), currentUnit === 'si' ? 'W/m\u00B2' : 'Btu/h\u00B7ft\u00B2');
  html += row(isKo ? '\uC7A5\uBE44 \uBC00\uB3C4' : 'Equipment Density', z => currentUnit === 'si' ? (z.plugDensity || 0) * 0.293071 * 10.764 : (z.plugDensity || 0), currentUnit === 'si' ? 'W/m\u00B2' : 'Btu/h\u00B7ft\u00B2');

  // HVAC Sizing
  html += '<tr class="total-row"><td colspan="' + (fileNames.length + 1 + (zoneData.length === 2 ? 1 : 0)) + '" style="text-align:left;font-weight:700">' + t('zoneSizingInfo') + '</td></tr>';
  html += row(isKo ? '\uB0C9\uBC29 \uC124\uACC4\uBD80\uD558' : 'Cooling Design Load', z => z.sizing?.cooling?.designLoad || 0, 'Btu/h', isKo ? '\uD06C\uBA74 \uB0C9\uBC29 \uC7A5\uBE44 \uD544\uC694' : 'Higher = more cooling needed');
  html += row(isKo ? '\uB0C9\uBC29 \uD48D\uB7C9' : 'Cooling Air Flow', z => z.sizing?.cooling?.designAirFlow || 0, 'ft\u00B3/min');
  html += row(isKo ? '\uB09C\uBC29 \uC124\uACC4\uBD80\uD558' : 'Heating Design Load', z => z.sizing?.heating?.designLoad || 0, 'Btu/h', isKo ? '\uD06C\uBA74 \uB09C\uBC29 \uC7A5\uBE44 \uD544\uC694' : 'Higher = more heating needed');
  html += row(isKo ? '\uB09C\uBC29 \uD48D\uB7C9' : 'Heating Air Flow', z => z.sizing?.heating?.designAirFlow || 0, 'ft\u00B3/min');

  // Infiltration
  html += '<tr class="total-row"><td colspan="' + (fileNames.length + 1 + (zoneData.length === 2 ? 1 : 0)) + '" style="text-align:left;font-weight:700">' + t('zoneInfiltrationInfo') + '</td></tr>';
  html += row(isKo ? '\uCE68\uAE30 \uD48D\uB7C9' : 'Infiltration Rate', z => z.infiltration?.flowRate || 0, 'ft\u00B3/min');
  html += row(isKo ? '\uD658\uAE30\uD69F\uC218 (ACH)' : 'ACH', z => z.infiltration?.ach || 0, 'ACH', isKo ? '\uB0AE\uC744\uC218\uB85D \uB2E8\uC5F4 \uC131\uB2A5 \uC88B\uC74C' : 'Lower = better insulation');

  html += '</table></div></div>';
  wrap.innerHTML = html;
  setTimeout(renderSectionNav, 50);
}

// =========================================================
// DETAILS TAB
// =========================================================
function renderDetailsTab() {
  const r = reports[activeReportIdx];
  if (!r) return;

  const info = document.getElementById('buildingInfo');
  const items = [
    { label: t('building'), value: r.metadata.building || '\u2014' },
    { label: t('location'), value: r.initSummary?.location?.name || r.metadata.environment || '\u2014' },
    { label: t('simDate'), value: r.metadata.simTimestamp || '\u2014' },
    { label: t('program'), value: r.metadata.program || '\u2014' },
    { label: t('simHours'), value: r.metadata.simHours ? fmtNum(r.metadata.simHours, 0) + ' hrs' : '\u2014' },
    { label: t('totalArea'), value: r.buildingArea['Total Building Area'] ? fmtNum(convertVal(r.buildingArea['Total Building Area'], 'area')) + ' ' + unitLabel('area') : '\u2014' },
    { label: t('condArea'), value: r.buildingArea['Net Conditioned Building Area'] ? fmtNum(convertVal(r.buildingArea['Net Conditioned Building Area'], 'area')) + ' ' + unitLabel('area') : '\u2014' },
    { label: t('wwRatio'), value: r.windowWallRatio['Gross Window-Wall Ratio [%]']?.Total ? fmtNum(r.windowWallRatio['Gross Window-Wall Ratio [%]'].Total) + '%' : '\u2014' },
  ];
  info.innerHTML = items.map(i => '<div class="info-item"><div class="label">' + i.label + '</div><div class="value">' + i.value + '</div></div>').join('');

  renderEndUseDetailTable(r);
  renderZoneSummary(r);
  renderComfortSummary(r);
}

function renderEndUseDetailTable(r) {
  const wrap = document.getElementById('endUseDetailTable');
  if (!r.endUseByFuel || Object.keys(r.endUseByFuel).length === 0) {
    wrap.innerHTML = '<p style="color:var(--text-secondary)">No detailed end use data available.</p>';
    return;
  }
  const fuelCols = new Set();
  for (const fuels of Object.values(r.endUseByFuel)) {
    for (const [f, v] of Object.entries(fuels)) {
      if (v > 0) fuelCols.add(f);
    }
  }
  const cols = [...fuelCols];

  let html = '<table class="data-table"><tr><th>' + (currentLang === 'ko' ? '\uC6A9\uB3C4' : 'End Use') + '</th>';
  cols.forEach(c => html += '<th>' + tFuel(c) + ' (' + unitLabel('energy') + ')</th>');
  html += '</tr>';

  for (const [eu, fuels] of Object.entries(r.endUseByFuel)) {
    const isTotal = eu === 'Total End Uses';
    html += '<tr' + (isTotal ? ' class="total-row"' : '') + '>';
    html += '<td>' + tEndUse(eu) + '</td>';
    cols.forEach(c => {
      const v = fuels[c] || 0;
      html += v > 0 ? '<td>' + fmtNum(convertVal(v, 'energy')) + '</td>' : '<td class="empty-cell">\u2014</td>';
    });
    html += '</tr>';
  }
  html += '</table>';
  wrap.innerHTML = html;
}

function renderZoneSummary(r) {
  const wrap = document.getElementById('zoneSummaryTable');
  if (!r.zoneSummary || r.zoneSummary.length === 0) {
    wrap.innerHTML = '<p style="color:var(--text-secondary)">No zone data available.</p>';
    return;
  }
  const keys = Object.keys(r.zoneSummary[0]);
  const nameKey = keys[0]; // first column is zone name
  // Summary rows should not be clickable
  const summaryNames = new Set(['Total', 'Conditioned Total', 'Unconditioned Total', 'Not Part of Total']);
  let html = '<table class="data-table"><tr>';
  keys.forEach(k => html += '<th>' + k + '</th>');
  html += '</tr>';
  r.zoneSummary.forEach(zone => {
    const zoneName = zone[nameKey] || '';
    const isSummary = summaryNames.has(zoneName);
    html += '<tr>';
    keys.forEach((k, ki) => {
      if (ki === 0 && !isSummary && zoneName) {
        html += '<td><a href="javascript:void(0)" onclick="goToZoneDetail(\'' + zoneName.replace(/'/g, "\\'") + '\')" style="color:var(--primary);text-decoration:none;font-weight:600;cursor:pointer" onmouseover="this.style.textDecoration=\'underline\'" onmouseout="this.style.textDecoration=\'none\'">' + zoneName + '</a></td>';
      } else {
        html += '<td>' + (zone[k] || '\u2014') + '</td>';
      }
    });
    html += '</tr>';
  });
  html += '</table>';
  wrap.innerHTML = html;
}

function goToZoneDetail(zoneName) {
  const r = reports[activeReportIdx];
  if (!r || !r.zoneDetail) return;
  const idx = r.zoneDetail.findIndex(z => z.name === zoneName);
  if (idx < 0) return;
  switchTab('zones');
  setTimeout(() => {
    showZoneDetail(idx);
    const panel = document.getElementById('zoneDetailPanel');
    if (panel) {
      const py = panel.getBoundingClientRect().top + window.scrollY - 80;
      window.scrollTo({ top: py, behavior: 'smooth' });
    }
  }, 100);
}

function goBackToZoneCompare() {
  cameFromZoneCompare = false;
  switchTab('compare');
  setTimeout(() => {
    switchCompareSub('zone');
  }, 50);
}

function goToZoneDetailFromCompare(reportIdx, zoneName) {
  activeReportIdx = reportIdx;
  renderFileChips();
  const r = reports[reportIdx];
  if (!r || !r.zoneDetail) return;
  const idx = r.zoneDetail.findIndex(z => z.name === zoneName);
  if (idx < 0) return;
  cameFromZoneCompare = true;
  switchTab('zones');
  setTimeout(() => {
    showZoneDetail(idx);
    const panel = document.getElementById('zoneDetailPanel');
    if (panel) {
      const py = panel.getBoundingClientRect().top + window.scrollY - 80;
      window.scrollTo({ top: py, behavior: 'smooth' });
    }
  }, 100);
}

function goToZoneSummaryTable() {
  switchTab('details');
  setTimeout(() => {
    const card = document.getElementById('zoneSummaryCard');
    if (card) {
      const cy = card.getBoundingClientRect().top + window.scrollY - 80;
      window.scrollTo({ top: cy, behavior: 'smooth' });
    }
  }, 100);
}

function renderComfortSummary(r) {
  const wrap = document.getElementById('comfortSummaryDiv');
  if (!r.comfortSummary || Object.keys(r.comfortSummary).length === 0) {
    wrap.innerHTML = '<p style="color:var(--text-secondary)">No comfort data available.</p>';
    return;
  }
  let html = '<table class="data-table"><tr><th>' + (currentLang === 'ko' ? '\uD56D\uBAA9' : 'Description') + '</th><th>' + (currentLang === 'ko' ? '\uC2DC\uAC04 (Hours)' : 'Facility [Hours]') + '</th></tr>';
  for (const [k, v] of Object.entries(r.comfortSummary)) {
    const cls = v > 500 ? ' style="color:var(--danger);font-weight:600"' : '';
    html += '<tr><td>' + k + '</td><td' + cls + '>' + fmtNum(v) + '</td></tr>';
  }
  html += '</table>';
  wrap.innerHTML = html;
}

// =========================================================
// INSIGHTS TAB
// =========================================================
// =========================================================
// ZONE EXPLORER TAB
// =========================================================
function backToZoneList() {
  cameFromZoneCompare = false;
  document.getElementById('zoneCardGrid').style.display = '';
  document.getElementById('zoneDetailPanel').style.display = 'none';
  document.getElementById('zoneComparePanel').style.display = 'none';
  filterZones(); // re-apply any active search
}

function filterZones() {
  const input = document.getElementById('zoneSearchInput');
  const query = (input?.value || '').toLowerCase();
  const cards = document.querySelectorAll('#zoneCardGrid .zone-card');
  cards.forEach(card => {
    const name = card.getAttribute('data-zone-name') || '';
    card.style.display = name.toLowerCase().includes(query) ? '' : 'none';
  });
}

// =========================================================
// ZONE COMPARISON SELECTION
// =========================================================
let zoneSelections = []; // [{key:'0:3', reportIdx:0, zoneIdx:3, name:'...', fileName:'...'}]

function toggleZoneSelect(reportIdx, zoneIdx, cardEl) {
  const key = reportIdx + ':' + zoneIdx;
  const existing = zoneSelections.findIndex(s => s.key === key);
  if (existing >= 0) {
    zoneSelections.splice(existing, 1);
    if (cardEl) cardEl.classList.remove('selected');
  } else {
    const r = reports[reportIdx];
    const z = r.zoneDetail[zoneIdx];
    const labels = getReportLabels();
    zoneSelections.push({
      key, reportIdx, zoneIdx,
      name: z.name,
      fileName: labels[reportIdx] || r.fileName
    });
    if (cardEl) cardEl.classList.add('selected');
  }
  updateZoneCompareBar();
}

function updateZoneCompareBar() {
  const bar = document.getElementById('zoneCompareBar');
  const tagsEl = document.getElementById('zoneSelectedTags');
  const isKo = currentLang === 'ko';
  if (zoneSelections.length === 0) {
    bar.style.display = 'none';
    return;
  }
  bar.style.display = 'flex';
  document.getElementById('zoneCompareBarLabel').textContent = (isKo ? '비교 선택:' : 'Compare:');
  document.getElementById('zoneClearBtn').textContent = isKo ? '초기화' : 'Clear';
  document.getElementById('zoneCompareBtn').textContent = (isKo ? '비교하기 (' + zoneSelections.length + ')' : 'Compare (' + zoneSelections.length + ')');
  document.getElementById('zoneCompareBtn').disabled = zoneSelections.length < 2;
  document.getElementById('zoneCompareBtn').style.opacity = zoneSelections.length < 2 ? '.5' : '1';

  let html = '';
  zoneSelections.forEach((s, i) => {
    const rColor = REPORT_COLORS[s.reportIdx % REPORT_COLORS.length];
    const rBg = REPORT_BG_COLORS[s.reportIdx % REPORT_BG_COLORS.length];
    const rBorder = REPORT_BORDER_COLORS[s.reportIdx % REPORT_BORDER_COLORS.length];
    const fileLabel = reports.length > 1 ? ' <span style="font-weight:400;opacity:.7;font-size:.7rem">[' + s.fileName.substring(0, 18) + ']</span>' : '';
    html += '<span class="zone-tag" style="background:' + rBg + ';border-color:' + rBorder + ';color:' + rColor + '">';
    html += '<span class="tag-dot" style="background:' + rColor + '"></span>';
    html += '<span style="color:var(--text)">' + s.name + '</span>' + fileLabel;
    html += ' <span class="tag-remove" onclick="event.stopPropagation();removeZoneSelection(' + i + ')">&times;</span></span>';
  });
  tagsEl.innerHTML = html;
}

function removeZoneSelection(idx) {
  const removed = zoneSelections.splice(idx, 1)[0];
  // Un-highlight card if visible
  const card = document.querySelector('.zone-card[data-sel-key="' + removed.key + '"]');
  if (card) card.classList.remove('selected');
  updateZoneCompareBar();
}

function clearZoneSelection() {
  zoneSelections = [];
  document.querySelectorAll('.zone-card.selected').forEach(c => c.classList.remove('selected'));
  updateZoneCompareBar();
  // If compare panel is visible, go back to grid
  const cp = document.getElementById('zoneComparePanel');
  if (cp.style.display !== 'none') {
    cp.style.display = 'none';
    document.getElementById('zoneCardGrid').style.display = '';
  }
}

function showZoneComparison() {
  if (zoneSelections.length < 2) return;
  const isKo = currentLang === 'ko';

  // Gather zone data
  const items = zoneSelections.map(s => {
    const rColor = REPORT_COLORS[s.reportIdx % REPORT_COLORS.length];
    return {
      zone: reports[s.reportIdx].zoneDetail[s.zoneIdx],
      label: s.name,
      fileLabel: reports.length > 1 ? s.fileName.substring(0, 22) : '',
      reportIdx: s.reportIdx,
      color: rColor
    };
  });

  const panel = document.getElementById('zoneComparePanel');
  document.getElementById('zoneCardGrid').style.display = 'none';
  document.getElementById('zoneDetailPanel').style.display = 'none';
  const tut2 = document.getElementById('zoneTutorial');
  if (tut2) tut2.style.display = 'none';
  panel.style.display = 'block';

  // Build comparison table
  function row(label, getter, unit, explain) {
    let html = '<tr><td title="' + (explain || '') + '" style="white-space:nowrap">' + label + '</td>';
    const values = items.map(d => getter(d.zone));
    const nums = values.filter(v => typeof v === 'number' && !isNaN(v));
    const maxV = nums.length ? Math.max(...nums) : null;
    const minV = nums.length ? Math.min(...nums) : null;
    values.forEach(v => {
      let cls = '';
      if (typeof v === 'number' && !isNaN(v) && maxV !== minV && nums.length > 1) {
        if (v === maxV) cls = ' style="color:#dc2626;font-weight:700"';
        else if (v === minV) cls = ' style="color:#2563eb;font-weight:700"';
      }
      const display = (typeof v === 'number' && !isNaN(v)) ? fmtNum(v, 2) : (v || '\u2014');
      html += '<td' + cls + '>' + display + (unit && typeof v === 'number' ? ' <span style="font-size:.75rem;color:var(--text-secondary)">' + unit + '</span>' : '') + '</td>';
    });
    html += '</tr>';
    return html;
  }

  const aU = unitLabel('area');
  let html = '<div style="margin-bottom:12px">';
  html += '<button class="btn-outline" onclick="backFromZoneCompare()" style="font-size:.85rem;padding:6px 16px">' + (isKo ? '← 존 목록으로' : '← Back to Zone List') + '</button>';
  html += '</div>';

  html += '<div class="card">';
  html += '<div class="card-title"><span class="icon">&#128202;</span> ' + (isKo ? '존 자유 비교' : 'Zone Comparison') + ' (' + items.length + (isKo ? '개 존)' : ' zones)') + '</div>';
  html += '<p style="font-size:.8rem;color:var(--text-secondary);margin-bottom:12px">' + (isKo ? '빨간색 = 가장 큰 값, 파란색 = 가장 작은 값' : 'Red = highest, Blue = lowest') + '</p>';

  html += '<div class="table-wrap"><table class="data-table">';
  html += '<tr><th>' + (isKo ? '항목' : 'Property') + '</th>';
  items.forEach(d => {
    const dot = reports.length > 1 ? '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:' + d.color + ';margin-right:5px;vertical-align:middle"></span>' : '';
    const sub = d.fileLabel ? '<br><span style="font-size:.7rem;font-weight:400;color:var(--text-secondary)">' + d.fileLabel + '</span>' : '';
    html += '<th style="min-width:120px;border-top:3px solid ' + d.color + '">' + dot + d.label + sub + '</th>';
  });
  html += '</tr>';

  // Basic Info
  html += '<tr><td colspan="' + (items.length + 1) + '" style="background:#f0f7ff;font-weight:700;font-size:.85rem">' + (isKo ? '📋 기본 정보' : '📋 Basic Info') + '</td></tr>';
  html += row(isKo ? '바닥 면적' : 'Floor Area', z => convertVal(z.area || 0, 'area'), aU);
  html += row(isKo ? '체적' : 'Volume', z => currentUnit === 'si' ? (z.volume || 0) * 0.0283168 : z.volume || 0, currentUnit === 'si' ? 'm³' : 'ft³');
  html += row(isKo ? '공조' : 'Conditioned', z => z.conditioned, '');
  html += row(isKo ? '배율' : 'Multiplier', z => z.multipliers, 'x');

  // Envelope
  html += '<tr><td colspan="' + (items.length + 1) + '" style="background:#f0f7ff;font-weight:700;font-size:.85rem">' + (isKo ? '🏠 외피' : '🏠 Envelope') + '</td></tr>';
  html += row(isKo ? '외벽 총 면적' : 'Gross Wall Area', z => convertVal(z.grossWallArea || 0, 'area'), aU);
  html += row(isKo ? '창호 면적' : 'Window Area', z => convertVal(z.windowArea || 0, 'area'), aU);
  html += row('WWR (%)', z => z.grossWallArea > 0 ? (z.windowArea / z.grossWallArea * 100) : 0, '%');

  // Internal Loads
  html += '<tr><td colspan="' + (items.length + 1) + '" style="background:#f0f7ff;font-weight:700;font-size:.85rem">' + (isKo ? '💡 내부 부하' : '💡 Internal Loads') + '</td></tr>';
  html += row(isKo ? '재실 인원' : 'Occupants', z => z.people?.count || 0, isKo ? '명' : '');
  html += row(isKo ? '조명 밀도' : 'Lighting', z => z.lightingDensity || z.lights?.density || 0, 'Btu/h·ft²');
  html += row(isKo ? '장비 밀도' : 'Equipment', z => z.plugDensity || z.equipment?.density || 0, 'Btu/h·ft²');

  // HVAC
  html += '<tr><td colspan="' + (items.length + 1) + '" style="background:#f0f7ff;font-weight:700;font-size:.85rem">' + (isKo ? '❄ HVAC 설계' : '❄ HVAC Sizing') + '</td></tr>';
  html += row(isKo ? '냉방 설계부하' : 'Cooling Load', z => z.sizing?.cooling?.designLoad || 0, 'Btu/h');
  html += row(isKo ? '냉방 풍량' : 'Cooling Airflow', z => z.sizing?.cooling?.designAirFlow || 0, 'ft³/min');
  html += row(isKo ? '난방 설계부하' : 'Heating Load', z => z.sizing?.heating?.designLoad || 0, 'Btu/h');
  html += row(isKo ? '난방 풍량' : 'Heating Airflow', z => z.sizing?.heating?.designAirFlow || 0, 'ft³/min');

  // Infiltration
  html += '<tr><td colspan="' + (items.length + 1) + '" style="background:#f0f7ff;font-weight:700;font-size:.85rem">' + (isKo ? '🌬 침기' : '🌬 Infiltration') + '</td></tr>';
  html += row(isKo ? '유량' : 'Flow Rate', z => z.infiltration?.flowRate || 0, 'm³/s');
  html += row('ACH', z => z.infiltration?.ach || 0, '');

  html += '</table></div></div>';
  panel.innerHTML = html;
  const panelY = panel.getBoundingClientRect().top + window.scrollY - 80;
  window.scrollTo({ top: panelY, behavior: 'smooth' });
}

function backFromZoneCompare() {
  document.getElementById('zoneComparePanel').style.display = 'none';
  document.getElementById('zoneCardGrid').style.display = '';
  filterZones();
}

function renderZoneExplorer(keepSearch) {
  const r = reports[activeReportIdx];
  if (!r || !r.zoneDetail || r.zoneDetail.length === 0) {
    document.getElementById('zoneCardGrid').innerHTML = '<p style="color:var(--text-secondary);padding:20px">No zone data available.</p>';
    return;
  }

  // Find max area for bar chart scaling
  const maxArea = Math.max(...r.zoneDetail.map(z => z.area || 0), 1);
  const isKo = currentLang === 'ko';

  // Update search placeholder
  const searchInput = document.getElementById('zoneSearchInput');
  if (searchInput) searchInput.placeholder = isKo ? '\uC874 \uAC80\uC0C9...' : 'Search zones...';

  const checkSvg = '<svg viewBox="0 0 12 12"><polyline points="2,6 5,9.5 10,2.5"></polyline></svg>';
  const rIdx = activeReportIdx;
  let html = '';
  r.zoneDetail.forEach((z, i) => {
    const isCond = z.conditioned === 'Yes';
    const areaVal = convertVal(z.area || 0, 'area');
    const wwRatio = z.grossWallArea > 0 ? ((z.windowArea / z.grossWallArea) * 100).toFixed(0) : 0;
    const selKey = rIdx + ':' + i;
    const isSel = zoneSelections.some(s => s.key === selKey);

    html += '<div class="zone-card' + (isSel ? ' selected' : '') + '" data-zone-name="' + z.name + '" data-sel-key="' + selKey + '" onclick="showZoneDetail(' + i + ')">';
    html += '<span class="zone-badge ' + (isCond ? 'cond' : 'uncond') + '">' + (isCond ? t('zoneConditioned') : t('zoneUnconditioned')) + '</span>';
    html += '<div class="zone-check" onclick="event.stopPropagation();toggleZoneSelect(' + rIdx + ',' + i + ',this.parentElement)" title="' + (isKo ? '비교 선택' : 'Select for comparison') + '">' + checkSvg + '</div>';
    html += '<div class="zone-name">' + z.name + '</div>';
    html += '<div class="zone-meta">';
    html += (isKo ? '\uBA74\uC801' : 'Area') + ': <b>' + fmtNum(areaVal) + '</b> ' + unitLabel('area') + '<br>';
    if (z.people.count > 0) html += (isKo ? '\uC778\uC6D0' : 'People') + ': <b>' + fmtNum(z.people.count, 0) + '</b>' + (isKo ? '\uBA85' : '') + '<br>';
    if (wwRatio > 0) html += (isKo ? '\uCC3D\uBA74\uC801\uBE44' : 'WWR') + ': <b>' + wwRatio + '%</b>';
    html += '</div>';
    const pct = z.area > 0 ? (z.area / maxArea * 100) : 0;
    html += '<div class="zone-bar"><div class="zone-bar-fill" style="width:' + pct + '%;background:' + (isCond ? 'var(--primary)' : 'var(--text-secondary)') + '"></div></div>';
    html += '</div>';
  });

  document.getElementById('zoneCardGrid').innerHTML = html;
  document.getElementById('zoneDetailPanel').style.display = 'none';
  document.getElementById('zoneComparePanel').style.display = 'none';
  document.getElementById('zoneCardGrid').style.display = '';

  // Report banner for multi-file mode
  const banner = document.getElementById('zoneReportBanner');
  if (reports.length > 1) {
    const labels = getReportLabels();
    const color = REPORT_COLORS[rIdx % REPORT_COLORS.length];
    const bg = REPORT_BG_COLORS[rIdx % REPORT_BG_COLORS.length];
    const border = REPORT_BORDER_COLORS[rIdx % REPORT_BORDER_COLORS.length];
    let bHtml = '<div class="zone-report-banner" style="background:' + bg + ';border:1px solid ' + border + ';flex-direction:column;align-items:stretch;gap:6px">';
    // Row 1: Current report
    bHtml += '<div style="display:flex;align-items:center;gap:8px">';
    bHtml += '<span class="report-dot" style="background:' + color + '"></span>';
    bHtml += '<span style="color:' + color + '">' + (isKo ? '현재 보고서:' : 'Current:') + ' <b>' + labels[rIdx] + '</b></span>';
    const otherSel = zoneSelections.filter(s => s.reportIdx !== rIdx).length;
    if (otherSel > 0) {
      bHtml += '<span style="margin-left:auto;font-size:.75rem;color:var(--text-secondary);font-weight:400">';
      bHtml += (isKo ? '다른 보고서에서 ' + otherSel + '개 선택됨' : otherSel + ' from other reports');
      bHtml += '</span>';
    }
    bHtml += '</div>';
    // Row 2: Other reports
    bHtml += '<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;padding-left:18px;border-top:1px dashed ' + border + ';padding-top:6px">';
    bHtml += '<span style="font-size:.75rem;color:var(--text-secondary);font-weight:400">' + (isKo ? '전환 →' : 'Switch →') + '</span>';
    reports.forEach((rep, ri) => {
      if (ri === rIdx) return;
      const c2 = REPORT_COLORS[ri % REPORT_COLORS.length];
      const bg2 = REPORT_BG_COLORS[ri % REPORT_BG_COLORS.length];
      const bd2 = REPORT_BORDER_COLORS[ri % REPORT_BORDER_COLORS.length];
      bHtml += '<span class="switch-link" style="color:' + c2 + ';background:' + bg2 + ';border:1px solid ' + bd2 + ';padding:3px 10px;border-radius:14px;text-decoration:none;font-size:.78rem" onclick="setActiveReport(' + ri + ')">';
      bHtml += '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:' + c2 + ';margin-right:4px;vertical-align:middle"></span>';
      bHtml += labels[ri] + '</span>';
    });
    bHtml += '</div>';
    bHtml += '</div>';
    banner.innerHTML = bHtml;
    banner.style.display = 'block';
  } else {
    banner.style.display = 'none';
  }

  // Zone comparison tutorial (dismissable)
  renderZoneTutorial();

  updateZoneCompareBar();
}

function renderZoneTutorial() {
  const container = document.getElementById('zoneTutorial');
  if (!container) return;
  // Check if user has dismissed it
  if (localStorage.getItem('zoneTutorialDismissed') === '1') {
    container.style.display = 'none';
    return;
  }
  const isKo = currentLang === 'ko';
  container.style.display = 'block';
  container.innerHTML =
    '<div style="border-radius:14px;border:1px solid #93c5fd;background:linear-gradient(135deg,#eff6ff,#f0f7ff);padding:20px 24px;margin-bottom:16px;position:relative;animation:fadeIn .4s">' +
    '<button onclick="dismissZoneTutorial()" style="position:absolute;top:10px;right:14px;background:none;border:none;font-size:1.2rem;color:#94a3b8;cursor:pointer;padding:4px;line-height:1" title="' + (isKo ? '닫기' : 'Close') + '">&times;</button>' +
    '<div style="font-weight:700;font-size:1rem;color:#1e40af;margin-bottom:12px">&#128218; ' + (isKo ? '존 비교 사용 가이드' : 'Zone Comparison Guide') + '</div>' +
    '<div style="display:flex;flex-wrap:wrap;gap:16px">' +
    // Step 1
    '<div style="flex:1;min-width:180px;background:white;border-radius:10px;padding:14px;border:1px solid #dbeafe">' +
    '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">' +
    '<span style="display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;background:#3b82f6;color:white;font-weight:700;font-size:.85rem">1</span>' +
    '<span style="font-weight:600;color:#1e3a5f;font-size:.9rem">' + (isKo ? '존 선택' : 'Select Zones') + '</span>' +
    '</div>' +
    '<p style="font-size:.82rem;color:#475569;margin:0;line-height:1.5">' +
    (isKo
      ? '각 존 카드의 <b style="color:#3b82f6">우측 하단 체크박스 &#9745;</b>를 클릭하여 비교할 존을 선택하세요. 이름이 달라도, 다른 보고서의 존이라도 비교 가능합니다.'
      : 'Click the <b style="color:#3b82f6">checkbox &#9745;</b> on the bottom-right of each zone card to select it. You can compare zones with different names, even from different reports.') +
    '</p>' +
    '</div>' +
    // Step 2
    '<div style="flex:1;min-width:180px;background:white;border-radius:10px;padding:14px;border:1px solid #dbeafe">' +
    '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">' +
    '<span style="display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;background:#3b82f6;color:white;font-weight:700;font-size:.85rem">2</span>' +
    '<span style="font-weight:600;color:#1e3a5f;font-size:.9rem">' + (isKo ? '2개 이상 선택' : 'Pick 2+ Zones') + '</span>' +
    '</div>' +
    '<p style="font-size:.82rem;color:#475569;margin:0;line-height:1.5">' +
    (isKo
      ? '하단에 <b style="color:#1e40af">비교 선택 바</b>가 나타납니다. 선택한 존의 이름과 보고서가 태그로 표시됩니다.'
      : 'A <b style="color:#1e40af">comparison bar</b> will appear at the bottom showing your selected zone tags.') +
    '</p>' +
    '</div>' +
    // Step 3
    '<div style="flex:1;min-width:180px;background:white;border-radius:10px;padding:14px;border:1px solid #dbeafe">' +
    '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">' +
    '<span style="display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;background:#3b82f6;color:white;font-weight:700;font-size:.85rem">3</span>' +
    '<span style="font-weight:600;color:#1e3a5f;font-size:.9rem">' + (isKo ? '비교하기 클릭' : 'Click Compare') + '</span>' +
    '</div>' +
    '<p style="font-size:.82rem;color:#475569;margin:0;line-height:1.5">' +
    (isKo
      ? '<b style="color:#3b82f6">비교하기</b> 버튼을 누르면 면적, 외피, 부하 등을 나란히 비교할 수 있는 상세 테이블이 나타납니다.'
      : 'Click <b style="color:#3b82f6">Compare</b> and a detailed side-by-side table appears for area, envelope, loads, and more.') +
    '</p>' +
    '</div>' +
    '</div>' +
    // Tip
    '<div style="margin-top:12px;padding:8px 14px;background:#dbeafe;border-radius:8px;font-size:.8rem;color:#1e40af;display:flex;align-items:center;gap:8px">' +
    '<span style="font-size:1rem">&#128161;</span>' +
    (isKo
      ? '<span><b>팁:</b> 존 카드를 직접 클릭하면 해당 존의 <b>상세 정보</b>를 볼 수 있습니다. 체크박스만 눌러야 비교 선택이 됩니다.</span>'
      : '<span><b>Tip:</b> Click the card itself to view <b>detailed zone info</b>. Use the checkbox to select for comparison.</span>') +
    '</div>' +
    '</div>';
}

function dismissZoneTutorial() {
  localStorage.setItem('zoneTutorialDismissed', '1');
  const container = document.getElementById('zoneTutorial');
  if (container) {
    container.style.opacity = '0';
    container.style.transition = 'opacity .3s';
    setTimeout(() => { container.style.display = 'none'; }, 300);
  }
}

function showZoneDetail(idx) {
  const r = reports[activeReportIdx];
  if (!r) return;
  const z = r.zoneDetail[idx];
  if (!z) return;
  const isKo = currentLang === 'ko';
  const panel = document.getElementById('zoneDetailPanel');

  // Hide card grid, compare panel, and tutorial; show detail
  document.getElementById('zoneCardGrid').style.display = 'none';
  document.getElementById('zoneComparePanel').style.display = 'none';
  const tut = document.getElementById('zoneTutorial');
  if (tut) tut.style.display = 'none';
  panel.style.display = 'block';

  const areaFt2 = z.area || 0;
  const areaM2 = areaFt2 * 0.092903;
  const volFt3 = z.volume || 0;
  const volM3 = volFt3 * 0.0283168;
  const isCond = z.conditioned === 'Yes';
  const wwRatio = z.grossWallArea > 0 ? ((z.windowArea / z.grossWallArea) * 100) : 0;

  // Helper to make info item
  function item(label, value, unit, explain) {
    return '<div class="zone-info-item"><div class="label">' + label + '</div><div class="value">' + value + (unit ? '<span class="unit">' + unit + '</span>' : '') + '</div>' + (explain ? '<div class="explain">' + explain + '</div>' : '') + '</div>';
  }

  let html = '';

  // Navigation buttons
  html += '<div style="margin-bottom:16px;display:flex;gap:8px;flex-wrap:wrap">';
  html += '<button class="btn-outline" onclick="backToZoneList()" style="font-size:.85rem;padding:6px 16px">' + t('zoneBack') + '</button>';
  if (cameFromZoneCompare) {
    html += '<button class="btn-outline" onclick="goBackToZoneCompare()" style="font-size:.85rem;padding:6px 16px;border-color:#8b5cf6;color:#8b5cf6">' + (isKo ? '존별 비교' : 'Zone Compare') + ' &#8594;</button>';
  }
  html += '<button class="btn-outline" onclick="goToZoneSummaryTable()" style="font-size:.85rem;padding:6px 16px;color:var(--text-secondary)">' + (isKo ? '&#128203; 존 요약 테이블 보기' : '&#128203; View Zone Summary Table') + '</button>';
  html += '</div>';

  // Zone header
  html += '<div class="zone-detail-section" style="background:linear-gradient(135deg,#eff6ff,#f8fafc)">';
  html += '<div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap"><h2 style="margin:0;font-size:1.3rem">' + z.name + '</h2>';
  html += '<span class="zone-badge ' + (isCond ? 'cond' : 'uncond') + '" style="position:static">' + (isCond ? t('zoneConditioned') : t('zoneUnconditioned')) + '</span></div>';
  html += '</div>';

  // Section: Basic Info
  html += '<div class="zone-detail-section">';
  html += '<h3>&#128207; ' + t('zoneBasicInfo') + '</h3>';
  html += '<div class="zone-detail-grid">';
  html += item(isKo ? '\uBC14\uB2E5 \uBA74\uC801' : 'Floor Area', fmtNum(convertVal(areaFt2, 'area')), unitLabel('area'),
    isKo ? '\uC774 \uACF5\uAC04\uC758 \uBC14\uB2E5 \uD06C\uAE30\uC785\uB2C8\uB2E4' : 'The floor size of this space');
  html += item(isKo ? '\uCCB4\uC801' : 'Volume', currentUnit === 'si' ? fmtNum(volM3) : fmtNum(volFt3), currentUnit === 'si' ? 'm\u00B3' : 'ft\u00B3',
    isKo ? '\uACF5\uAC04\uC758 \uC804\uCCB4 \uBD80\uD53C (\uB0C9\uB09C\uBC29 \uC6A9\uB7C9 \uACB0\uC815\uC5D0 \uC911\uC694)' : 'Total volume — affects HVAC capacity');
  if (z.ceilingHeight > 0) html += item(isKo ? '\uCCA8\uC7A5 \uB192\uC774' : 'Ceiling Height', currentUnit === 'si' ? fmtNum(z.ceilingHeight * 0.3048) : fmtNum(z.ceilingHeight), currentUnit === 'si' ? 'm' : 'ft', '');
  html += item(isKo ? '\uBC30\uC728' : 'Multiplier', fmtNum(z.multipliers, 0), 'x',
    isKo ? '\uB3D9\uC77C\uD55C \uACF5\uAC04\uC774 \uC5EC\uB7EC \uAC1C \uC788\uC73C\uBA74 1\uBCF4\uB2E4 \uD07D\uB2C8\uB2E4' : 'If >1, this zone represents multiple identical spaces');
  html += '</div></div>';

  // Section: Envelope
  html += '<div class="zone-detail-section">';
  html += '<h3>&#127969; ' + t('zoneEnvelope') + '</h3>';
  html += '<div class="zone-detail-grid">';
  html += item(isKo ? '\uC678\uBCBD \uCD1D \uBA74\uC801' : 'Gross Wall Area', fmtNum(convertVal(z.grossWallArea || 0, 'area')), unitLabel('area'),
    isKo ? '\uC678\uBD80\uC5D0 \uB178\uCD9C\uB41C \uBCBD\uCCB4 \uC804\uCCB4 \uBA74\uC801' : 'Total exterior wall area exposed outside');
  html += item(isKo ? '\uCC3D\uD638 \uBA74\uC801' : 'Window Area', fmtNum(convertVal(z.windowArea || 0, 'area')), unitLabel('area'),
    isKo ? '\uC720\uB9AC\uCC3D \uCD1D \uBA74\uC801' : 'Total glazing area');
  html += item(isKo ? '\uCC3D\uBA74\uC801\uBE44 (WWR)' : 'Window-Wall Ratio', fmtNum(wwRatio, 0), '%',
    wwRatio > 40
      ? (isKo ? '\u26A0 40% \uC774\uC0C1 \u2014 \uB0C9\uB09C\uBC29 \uBD80\uD558\uAC00 \uD06C\uBA70 \uACE0\uC131\uB2A5 \uC720\uB9AC \uAD8C\uC7A5' : '\u26A0 Above 40% — high cooling/heating load, consider high-perf glazing')
      : (isKo ? '\uC801\uC808\uD55C \uBE44\uC728\uC785\uB2C8\uB2E4' : 'Reasonable ratio'));
  if (z.undergroundWallArea > 0) html += item(isKo ? '\uC9C0\uD558 \uBCBD\uCCB4' : 'Underground Wall', fmtNum(convertVal(z.undergroundWallArea, 'area')), unitLabel('area'), '');
  html += '</div></div>';

  // Section: Internal Loads
  html += '<div class="zone-detail-section">';
  html += '<h3>&#128161; ' + t('zoneInternalLoad') + '</h3>';
  html += '<div class="zone-detail-grid">';
  const pplCount = z.people.count || 0;
  const areaPerPerson = z.areaPerPerson || (pplCount > 0 && areaFt2 > 0 ? areaFt2 / pplCount : 0);
  html += item(isKo ? '\uC7AC\uC2E4 \uC778\uC6D0' : 'Occupants', fmtNum(pplCount, 1), isKo ? '\uBA85' : 'people',
    areaPerPerson > 0 ? (isKo ? '1\uC778\uB2F9 \uC57D ' + fmtNum(currentUnit === 'si' ? areaPerPerson * 0.092903 : areaPerPerson) + ' ' + unitLabel('area') : 'About ' + fmtNum(currentUnit === 'si' ? areaPerPerson * 0.092903 : areaPerPerson) + ' ' + unitLabel('area') + '/person') : '');

  const lightDensity = z.lightingDensity || (z.lights.density || 0);
  const lightW = lightDensity * 0.293071; // Btu/h-ft2 to W/ft2, then * 10.764 for W/m2
  const lightWm2 = lightDensity * 0.293071 * 10.764;
  html += item(isKo ? '\uC870\uBA85 \uBC00\uB3C4' : 'Lighting Density', currentUnit === 'si' ? fmtNum(lightWm2) + ' <span class="unit">W/m\u00B2</span>' : fmtNum(lightDensity) + ' <span class="unit">Btu/h\u00B7ft\u00B2</span>', '',
    isKo ? '\uD3C9\uBC94\uD55C \uBC14\uB2E5 \uBA74\uC801\uB2F9 \uC870\uBA85 \uC5D0\uB108\uC9C0' : 'Lighting power per unit floor area');

  const plugDensity = z.plugDensity || (z.equipment.density || 0);
  const plugWm2 = plugDensity * 0.293071 * 10.764;
  html += item(isKo ? '\uC7A5\uBE44 \uBC00\uB3C4' : 'Equipment Density', currentUnit === 'si' ? fmtNum(plugWm2) + ' <span class="unit">W/m\u00B2</span>' : fmtNum(plugDensity) + ' <span class="unit">Btu/h\u00B7ft\u00B2</span>', '',
    isKo ? 'PC, \uBCF5\uD569\uAE30 \uB4F1 \uC0AC\uBB34\uAE30\uAE30 \uC804\uB825' : 'Computers, copiers, appliances');

  if (z.totalLoadDensity > 0) {
    const totalWm2 = z.totalLoadDensity * 0.293071 * 10.764;
    html += item(isKo ? '\uCD1D \uB0B4\uBD80\uBD80\uD558' : 'Total Internal Load', currentUnit === 'si' ? fmtNum(totalWm2) + ' <span class="unit">W/m\u00B2</span>' : fmtNum(z.totalLoadDensity) + ' <span class="unit">Btu/h\u00B7ft\u00B2</span>', '',
      isKo ? '\uC870\uBA85+\uC7A5\uBE44 \uD569\uACC4 \u2014 \uB192\uC744\uC218\uB85D \uB0C9\uBC29\uBD80\uD558 \uC99D\uAC00' : 'Lighting + Equipment total — higher means more cooling needed');
  }
  html += '</div></div>';

  // Section: HVAC Sizing
  if (z.sizing.cooling || z.sizing.heating) {
    html += '<div class="zone-detail-section">';
    html += '<h3>&#10052; ' + t('zoneSizingInfo') + '</h3>';
    html += '<div class="zone-detail-grid">';
    if (z.sizing.cooling) {
      const cl = z.sizing.cooling;
      html += item(isKo ? '\uB0C9\uBC29 \uC124\uACC4\uBD80\uD558' : 'Cooling Design Load', fmtNum(cl.designLoad), 'Btu/h',
        isKo ? '\uC774 \uACF5\uAC04\uC744 \uB0C9\uBC29\uD558\uB294\uB370 \uD544\uC694\uD55C \uCD5C\uB300 \uC5D0\uB108\uC9C0' : 'Maximum energy needed to cool this space');
      html += item(isKo ? '\uB0C9\uBC29 \uD48D\uB7C9' : 'Cooling Air Flow', fmtNum(cl.designAirFlow), 'ft\u00B3/min',
        isKo ? '\uD53C\uD06C \uC2DC \uD544\uC694 \uC1A1\uD48D\uB7C9' : 'Air volume at peak cooling');
      html += item(isKo ? '\uB0C9\uBC29 \uD53C\uD06C' : 'Cooling Peak', cl.peakDate, '',
        isKo ? '\uB0C9\uBC29\uC774 \uAC00\uC7A5 \uD544\uC694\uD55C \uC2DC\uC810' : 'When cooling demand is highest');
    }
    if (z.sizing.heating) {
      const ht = z.sizing.heating;
      html += item(isKo ? '\uB09C\uBC29 \uC124\uACC4\uBD80\uD558' : 'Heating Design Load', fmtNum(ht.designLoad), 'Btu/h',
        isKo ? '\uC774 \uACF5\uAC04\uC744 \uB09C\uBC29\uD558\uB294\uB370 \uD544\uC694\uD55C \uCD5C\uB300 \uC5D0\uB108\uC9C0' : 'Maximum energy needed to heat this space');
      html += item(isKo ? '\uB09C\uBC29 \uD48D\uB7C9' : 'Heating Air Flow', fmtNum(ht.designAirFlow), 'ft\u00B3/min', '');
      html += item(isKo ? '\uB09C\uBC29 \uD53C\uD06C' : 'Heating Peak', ht.peakDate, '',
        isKo ? '\uB09C\uBC29\uC774 \uAC00\uC7A5 \uD544\uC694\uD55C \uC2DC\uC810' : 'When heating demand is highest');
    }
    html += '</div></div>';
  }

  // Section: Infiltration
  if (z.infiltration.flowRate > 0 || z.infiltration.ach > 0) {
    html += '<div class="zone-detail-section">';
    html += '<h3>&#127744; ' + t('zoneInfiltrationInfo') + '</h3>';
    html += '<div class="zone-detail-grid">';
    if (z.infiltration.flowRate > 0)
      html += item(isKo ? '\uCE68\uAE30 \uD48D\uB7C9' : 'Infiltration Rate', fmtNum(z.infiltration.flowRate), 'ft\u00B3/min',
        isKo ? '\uC678\uBD80\uC5D0\uC11C \uD2C8\uC0AC\uC774\uB85C \uB4E4\uC5B4\uC624\uB294 \uACF5\uAE30\uB7C9 \u2014 \uB0AE\uC744\uC218\uB85D \uB2E8\uC5F4 \uC131\uB2A5 \uC88B\uC74C' : 'Air leaking in from outside — lower is better');
    if (z.infiltration.ach > 0)
      html += item(isKo ? '\uD658\uAE30\uD69F\uC218 (ACH)' : 'Air Changes/Hour', fmtNum(z.infiltration.ach, 2), 'ACH',
        z.infiltration.ach > 1
          ? (isKo ? '\u26A0 \uB192\uC74C \u2014 \uCC3D\uD638/\uBB38 \uBC00\uD3D0\uC131 \uAC1C\uC120 \uD544\uC694' : '\u26A0 High — consider improving window/door sealing')
          : (isKo ? '\uC591\uD638\uD55C \uC218\uC900\uC785\uB2C8\uB2E4' : 'Good level'));
    html += '</div></div>';
  }

  panel.innerHTML = html;
}

function renderInsights() {
  const r = reports[activeReportIdx];
  if (!r) return;
  const list = document.getElementById('insightList');
  list.innerHTML = '';

  const total = sumValues(r.annualEndUse);
  const heating = r.annualEndUse['Heating'] || 0;
  const cooling = r.annualEndUse['Cooling'] || 0;
  const fans = r.annualEndUse['Fans'] || 0;
  const area = r.buildingArea['Total Building Area'] || 0;
  const eui = area > 0 ? total / area : 0;

  const insights = [];

  if (total > 0) {
    const heatPct = (heating / total * 100).toFixed(1);
    const coolPct = (cooling / total * 100).toFixed(1);
    const fanPct = (fans / total * 100).toFixed(1);

    if (heatPct > 50) insights.push({ type: 'warning', text: t('insightHeatingDominant').replace('{pct}', heatPct) });
    if (coolPct > 30) insights.push({ type: 'warning', text: t('insightCoolingDominant').replace('{pct}', coolPct) });
    if (fanPct > 10) insights.push({ type: '', text: t('insightFanHigh').replace('{pct}', fanPct) });
  }

  const heatNotMet = r.comfortSummary['Time Setpoint Not Met During Occupied Heating'] || 0;
  const coolNotMet = r.comfortSummary['Time Setpoint Not Met During Occupied Cooling'] || 0;
  if (heatNotMet > 300) insights.push({ type: 'danger', text: t('insightSetpointHeat').replace('{hours}', fmtNum(heatNotMet, 0)) });
  if (coolNotMet > 300) insights.push({ type: 'danger', text: t('insightSetpointCool').replace('{hours}', fmtNum(coolNotMet, 0)) });

  if (eui > 0) {
    const euiDisplay = fmtNum(convertVal(eui, 'eui')) + ' ' + unitLabel('eui');
    if (eui > 100) insights.push({ type: 'warning', text: t('insightHighEUI').replace('{eui}', euiDisplay) });
    else insights.push({ type: 'success', text: t('insightLowEUI').replace('{eui}', euiDisplay) });
  }

  // Warmup convergence
  if (r.warmupConvergence.zones.length > 0) {
    if (r.warmupConvergence.allPassed) {
      insights.push({ type: 'success', text: currentLang === 'ko' ? '시뮬레이션 수렴 검증 통과 — 결과를 신뢰할 수 있습니다.' : 'Simulation warmup convergence passed — results are reliable.' });
    } else {
      insights.push({ type: 'danger', text: currentLang === 'ko' ? '일부 존에서 시뮬레이션 수렴이 실패했습니다 — 결과의 정확도를 확인하세요.' : 'Some zones failed warmup convergence — verify result accuracy.' });
    }
  }

  // Peak load dominant factor from AirLoop
  for (const [sysName, sys] of Object.entries(r.airLoopLoadSummary)) {
    if (sys.cooling && sys.cooling.components) {
      const sorted = sys.cooling.components.filter(c => c.name !== 'Grand Total' && c.pctGrandTotal > 0).sort((a,b) => b.pctGrandTotal - a.pctGrandTotal);
      if (sorted.length > 0 && sorted[0].pctGrandTotal > 30) {
        const top = sorted[0];
        insights.push({ type: 'warning', text: currentLang === 'ko'
          ? '냉방 피크 부하의 ' + top.pctGrandTotal.toFixed(0) + '%가 "' + top.name + '" 때문입니다 — 해당 부위 개선이 가장 효과적입니다.'
          : top.pctGrandTotal.toFixed(0) + '% of cooling peak load is from "' + top.name + '" — improving this area would be most effective.'
        });
      }
    }
    if (sys.heating && sys.heating.components) {
      const sorted = sys.heating.components.filter(c => c.name !== 'Grand Total' && c.pctGrandTotal > 0).sort((a,b) => b.pctGrandTotal - a.pctGrandTotal);
      if (sorted.length > 0 && sorted[0].pctGrandTotal > 30) {
        const top = sorted[0];
        insights.push({ type: 'warning', text: currentLang === 'ko'
          ? '난방 피크 부하의 ' + top.pctGrandTotal.toFixed(0) + '%가 "' + top.name + '" 때문입니다 — 해당 부위의 단열 개선을 검토하세요.'
          : top.pctGrandTotal.toFixed(0) + '% of heating peak load is from "' + top.name + '" — consider improving insulation in this area.'
        });
      }
    }
  }

  if (insights.length === 0) {
    insights.push({ type: 'success', text: t('insightNoIssues') });
  }

  insights.forEach(ins => {
    const li = document.createElement('li');
    li.className = ins.type;
    li.textContent = ins.text;
    list.appendChild(li);
  });
}

// =========================================================
// API / DEVELOPER TAB
// =========================================================
let currentApiSub = 'energy';

function switchApiSub(name) {
  currentApiSub = name;
  document.querySelectorAll('.api-sub-content').forEach(el => el.style.display = 'none');
  document.querySelectorAll('.api-subtab').forEach(el => el.classList.remove('active'));
  const panel = document.getElementById('apiSub-' + name);
  if (panel) panel.style.display = 'block';
  const btn = document.getElementById('apiSub' + name.charAt(0).toUpperCase() + name.slice(1));
  if (btn) btn.classList.add('active');
}

function renderApiTab() {
  const r = reports[activeReportIdx];
  if (!r) return;

  // Energy Report (existing)
  const apiData = buildApiData(r);
  document.getElementById('apiDataPre').textContent = JSON.stringify(apiData, null, 2);

  // Peak Load Analysis
  const peakLoadData = buildPeakLoadData(r);
  document.getElementById('peakLoadPre').textContent = JSON.stringify(peakLoadData, null, 2);

  // HVAC Sizing
  const hvacData = buildHvacData(r);
  document.getElementById('hvacPre').textContent = JSON.stringify(hvacData, null, 2);

  // Simulation Info
  const simInfoData = buildSimInfoData(r);
  document.getElementById('simInfoPre').textContent = JSON.stringify(simInfoData, null, 2);

  // Warmup badge
  const badge = document.getElementById('warmupBadge');
  const wp = r.warmupConvergence;
  if (wp.zones.length > 0) {
    const passCount = wp.zones.filter(z => z.maxTempPass && z.minTempPass && z.heatingLoadPass && z.coolingLoadPass).length;
    const isKo = currentLang === 'ko';
    if (wp.allPassed) {
      badge.innerHTML = '<span class="warmup-badge pass">&#10003; ' + (isKo ? '모든 존 수렴 통과 (' + passCount + '/' + wp.zones.length + ')' : 'All zones converged (' + passCount + '/' + wp.zones.length + ')') + '</span>';
    } else {
      badge.innerHTML = '<span class="warmup-badge fail">&#10007; ' + (isKo ? '수렴 실패 존 있음 (' + passCount + '/' + wp.zones.length + ' 통과)' : 'Some zones failed convergence (' + passCount + '/' + wp.zones.length + ' passed)') + '</span>';
    }
  } else {
    badge.innerHTML = '';
  }
}

function buildApiData(r) {
  const totalSite = r.siteSourceEnergy['Total Site Energy']?.totalEnergy || sumValues(r.annualEndUse);
  const area = r.buildingArea['Total Building Area'] || 0;

  return {
    _schema: 'building-energy-report/v1',
    _generated: new Date().toISOString(),
    _units: currentUnit === 'si' ? 'SI (metric)' : 'IP (imperial)',
    metadata: {
      building: r.metadata.building,
      location: r.metadata.environment,
      program: r.metadata.program,
      simulationTimestamp: r.metadata.simTimestamp,
      simulationHours: r.metadata.simHours,
      fileName: r.fileName,
    },
    buildingArea: {
      total: { value: convertVal(r.buildingArea['Total Building Area'] || 0, 'area'), unit: unitLabel('area') },
      conditioned: { value: convertVal(r.buildingArea['Net Conditioned Building Area'] || 0, 'area'), unit: unitLabel('area') },
    },
    annualEnergy: {
      totalSiteEnergy: { value: convertVal(totalSite, 'energy'), unit: unitLabel('energy') },
      totalSourceEnergy: { value: convertVal(r.siteSourceEnergy['Total Source Energy']?.totalEnergy || 0, 'energy'), unit: unitLabel('energy') },
      eui: { value: area > 0 ? convertVal(totalSite / area, 'eui') : 0, unit: unitLabel('eui') },
    },
    endUseBreakdown: Object.fromEntries(
      Object.entries(r.annualEndUse).filter(([k,v]) => v > 0).map(([k,v]) => [k, { value: convertVal(v, 'energy'), unit: unitLabel('energy'), percentage: (v / totalSite * 100).toFixed(1) + '%' }])
    ),
    fuelBreakdown: Object.fromEntries(
      Object.entries(r.annualFuelUse).filter(([k,v]) => v > 0).map(([k,v]) => [k, { value: convertVal(v, 'energy'), unit: unitLabel('energy') }])
    ),
    monthlyData: Object.fromEntries(
      Object.entries(r.monthlyConsumption).map(([fuel, endUses]) => {
        const unitType = fuel === 'Electricity' ? 'elecConsumption' : 'gasConsumption';
        return [fuel, {
          unit: unitLabel(unitType),
          endUses: Object.fromEntries(
            Object.entries(endUses).map(([eu, data]) => [eu, {
              monthly: data.monthly.map(v => convertVal(v || 0, unitType)),
              total: convertVal(data.total || data.monthly.reduce((a,b) => a + (b||0), 0), unitType)
            }])
          )
        }];
      })
    ),
    monthlyPeakDemand: Object.fromEntries(
      Object.entries(r.monthlyPeakDemand).map(([fuel, endUses]) => {
        const unitType = fuel === 'Electricity' ? 'peakElec' : 'peakGas';
        return [fuel, {
          unit: unitLabel(unitType),
          endUses: Object.fromEntries(
            Object.entries(endUses).map(([eu, data]) => [eu, {
              monthly: data.monthly.map(v => convertVal(v || 0, unitType)),
            }])
          )
        }];
      })
    ),
    comfort: r.comfortSummary,
    zones: r.zoneSummary,
  };
}

// =========================================================
// API DATA BUILDERS - Separate schemas
// =========================================================
function buildPeakLoadData(r) {
  return {
    _schema: 'peak-load-analysis/v1',
    _generated: new Date().toISOString(),
    _units: currentUnit === 'si' ? 'SI (metric)' : 'IP (imperial)',
    metadata: {
      building: r.metadata.building,
      fileName: r.fileName,
    },
    airLoopSystems: Object.fromEntries(
      Object.entries(r.airLoopLoadSummary).map(([sysName, sys]) => {
        const buildSide = (side) => {
          const result = {};
          if (side.components) {
            result.components = side.components.filter(c => c.name !== 'Grand Total').map(c => ({
              name: c.name,
              total: c.total,
              pctGrandTotal: c.pctGrandTotal,
              totalPerArea: c.totalPerArea,
            }));
            const grand = side.components.find(c => c.name === 'Grand Total');
            if (grand) result.grandTotal = grand.total;
          }
          if (side.peakConditions) result.peakConditions = side.peakConditions;
          if (side.engineeringChecks) result.engineeringChecks = side.engineeringChecks;
          if (side.zonesIncluded) result.zonesIncluded = side.zonesIncluded;
          return result;
        };
        return [sysName, { cooling: buildSide(sys.cooling), heating: buildSide(sys.heating) }];
      })
    ),
  };
}

function buildHvacData(r) {
  return {
    _schema: 'hvac-sizing/v1',
    _generated: new Date().toISOString(),
    _units: currentUnit === 'si' ? 'SI (metric)' : 'IP (imperial)',
    metadata: {
      building: r.metadata.building,
      fileName: r.fileName,
    },
    zoneSizing: r.initSummary.zoneSizing,
    systemSizing: r.initSummary.systemSizing,
    componentSizing: r.initSummary.componentSizing,
  };
}

function buildSimInfoData(r) {
  return {
    _schema: 'simulation-metadata/v1',
    _generated: new Date().toISOString(),
    metadata: {
      building: r.metadata.building,
      program: r.metadata.program,
      simulationTimestamp: r.metadata.simTimestamp,
      fileName: r.fileName,
    },
    energyPlusVersion: r.initSummary.version,
    timestepsPerHour: r.initSummary.timestepsPerHour,
    minutesPerTimestep: r.initSummary.minutesPerTimestep,
    location: r.initSummary.location,
    buildingInfo: r.initSummary.buildingInfo,
    warmupConvergence: {
      allPassed: r.warmupConvergence.allPassed,
      totalZones: r.warmupConvergence.zones.length,
      passedZones: r.warmupConvergence.zones.filter(z => z.maxTempPass && z.minTempPass && z.heatingLoadPass && z.coolingLoadPass).length,
      zones: r.warmupConvergence.zones,
    },
  };
}

// =========================================================
// EXPORTS
// =========================================================
function exportPeakLoadJSON() {
  if (reports.length === 0) return;
  const data = buildPeakLoadData(reports[activeReportIdx]);
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  downloadBlob(blob, 'abs-peak-load-analysis.json');
}

function exportHvacJSON() {
  if (reports.length === 0) return;
  const data = buildHvacData(reports[activeReportIdx]);
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  downloadBlob(blob, 'abs-hvac-sizing-data.json');
}

function exportSimInfoJSON() {
  if (reports.length === 0) return;
  const data = buildSimInfoData(reports[activeReportIdx]);
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  downloadBlob(blob, 'abs-simulation-metadata.json');
}

function exportJSON() {
  if (reports.length === 0) return;
  const allData = reports.length === 1
    ? buildApiData(reports[0])
    : reports.map(r => buildApiData(r));

  const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
  downloadBlob(blob, 'abs-energy-data.json');
}

function exportCSV() {
  if (reports.length === 0) return;
  const r = reports[activeReportIdx];
  let csv = 'Fuel,End Use,Month,Value,Unit\n';

  for (const [fuel, endUses] of Object.entries(r.monthlyConsumption)) {
    const unitType = fuel === 'Electricity' ? 'elecConsumption' : 'gasConsumption';
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    for (const [eu, data] of Object.entries(endUses)) {
      data.monthly.forEach((v, i) => {
        csv += '"' + fuel + '","' + eu + '","' + months[i] + '",' + convertVal(v||0, unitType).toFixed(4) + ',"' + unitLabel(unitType) + '"\n';
      });
    }
  }

  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8' });
  downloadBlob(blob, 'abs-monthly-data.csv');
}

function copyApiData(preId) {
  const id = preId || 'apiDataPre';
  const pre = document.getElementById(id);
  if (pre) {
    navigator.clipboard.writeText(pre.textContent).then(() => {
      const panel = pre.closest('.api-panel');
      const btn = panel ? panel.querySelector('.copy-btn') : null;
      if (btn) { btn.textContent = 'Copied!'; setTimeout(() => btn.textContent = 'Copy', 1500); }
    });
  }
}

function downloadBlob(blob, name) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = name;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// =========================================================
// LANGUAGE & UNIT
// =========================================================
function setLang(lang) {
  currentLang = lang;
  document.querySelectorAll('#langToggle .btn').forEach(b => b.classList.toggle('active', b.dataset.lang === lang));
  document.documentElement.lang = lang;
  applyI18n();
  renderAll();
}

function setUnit(unit) {
  currentUnit = unit;
  document.querySelectorAll('#unitToggle .btn').forEach(b => b.classList.toggle('active', b.dataset.unit === unit));
  renderAll();
}

function applyI18n() {
  document.getElementById('appTitle').textContent = t('appTitle');
  document.getElementById('dropTitle').textContent = t('dropTitle');
  document.getElementById('dropSubtitle').textContent = t('dropSubtitle');
  document.getElementById('tabOverview').textContent = t('tabOverview');
  document.getElementById('tabMonthly').textContent = t('tabMonthly');
  document.getElementById('tabCompare').textContent = t('tabCompare');
  document.getElementById('cmpSubEnergy').textContent = t('cmpEnergy');
  document.getElementById('cmpSubZone').textContent = t('cmpZone');
  document.getElementById('tabDetails').textContent = t('tabDetails');
  document.getElementById('tabZones').textContent = t('tabZones');
  document.getElementById('tabInsights').textContent = t('tabInsights');
  document.getElementById('tabApi').textContent = t('tabApi');
  document.getElementById('zoneExplorerTitle').textContent = t('zoneExplorerTitle');
  document.getElementById('zoneExplorerDesc').textContent = t('zoneExplorerDesc');
  document.getElementById('emptyTitle').textContent = t('emptyTitle');
  document.getElementById('emptyDesc').textContent = t('emptyDesc');
  const fuelHint = document.getElementById('fuelBarHint');
  if (fuelHint) fuelHint.innerHTML = t('fuelBarHint');
  document.getElementById('monthlyBackBtn').innerHTML = '&#8592; ' + t('tabOverview');
  document.getElementById('monthlyBackCompareBtn').innerHTML = t('tabCompare') + ' &#8594;';
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.dataset.i18n;
    el.textContent = t(key);
  });
}

// =========================================================
// TAB SWITCHING
// =========================================================
function switchTab(tabName) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tabName));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === 'tab-' + tabName));
  if (tabName !== 'monthly') cameFromCompare = false;
  if (tabName === 'monthly') renderMonthlyTab();
  if (tabName === 'compare') renderCompareTab();
  if (tabName === 'zones') renderZoneExplorer();
  /* Close section nav panel on tab switch, then refresh */
  sectionNavOpen = false;
  const navPanel = document.getElementById('sectionNavPanel');
  if (navPanel) navPanel.classList.remove('open');
  const navToggle = document.getElementById('sectionNavToggle');
  if (navToggle) navToggle.innerHTML = '&#9776;';
  setTimeout(renderSectionNav, 50);
}

function goToMonthlyFuel(fuelKey) {
  // Set the fuel selector and switch to monthly tab
  cameFromCompare = false;
  const sel = document.getElementById('monthlyFuelSelect');
  // Ensure options are populated first
  switchTab('monthly');
  // Now set the correct fuel
  if (sel) {
    const opts = [...sel.options].map(o => o.value);
    if (opts.includes(fuelKey)) {
      sel.value = fuelKey;
      renderMonthlyTab();
    }
  }
}

// =========================================================
// UTILS
// =========================================================
function sumValues(obj) {
  return Object.values(obj).reduce((s, v) => s + (typeof v === 'number' ? v : 0), 0);
}

function destroyChart(name) {
  if (charts[name]) { charts[name].destroy(); charts[name] = null; }
}

function buildCustomLegend(chart, containerId) {
  const container = document.getElementById(containerId);
  if (!container || !chart) return;
  container.innerHTML = '';
  const checkSvg = '<svg viewBox="0 0 12 12"><polyline points="2,6 5,9.5 10,2.5"></polyline></svg>';
  chart.data.datasets.forEach((ds, i) => {
    if (!ds.label) return; // Skip datasets without labels
    const item = document.createElement('div');
    item.className = 'chart-legend-item';
    // Get color: prefer borderColor for line charts, backgroundColor for bar charts
    let color = ds.borderColor || ds.backgroundColor || '#94a3b8';
    if (Array.isArray(color)) color = color[0];
    // Strip alpha from backgroundColor if it ends with transparency
    if (color.length === 9 && color.startsWith('#')) color = color.substring(0, 7);
    item.style.color = color;
    item.innerHTML = '<div class="legend-checkbox">' + checkSvg + '</div><span class="legend-label">' + ds.label + '</span>';
    item.addEventListener('click', () => {
      const meta = chart.getDatasetMeta(i);
      meta.hidden = meta.hidden === null ? !chart.data.datasets[i].hidden : null;
      item.classList.toggle('hidden', !!meta.hidden);
      chart.update();
    });
    container.appendChild(item);
  });
}

// Initial i18n
applyI18n();

// Scroll-to-top button visibility + section nav
window.addEventListener('scroll', () => {
  const btn = document.getElementById('scrollTopBtn');
  if (btn) btn.classList.toggle('visible', window.scrollY > 300);
  updateSectionNavActive();
});

// =========================================================
// FLOATING SECTION NAVIGATION
// =========================================================
let sectionNavOpen = false;
const SECTION_NAV_CONFIG = {
  monthly: [
    { id: 'monthlyStackedCard', icon: '📊', ko: '용도별 에너지', en: 'Energy by End Use' },
    { id: 'monthlyPeakCard', icon: '📈', ko: '피크 수요', en: 'Peak Demand' },
    { id: 'monthlyTableCard', icon: '📋', ko: '데이터 테이블', en: 'Data Table' },
    { id: 'dataContextCard', icon: '💡', ko: '데이터 이해', en: 'Understanding' }
  ],
  compare: [
    { id: 'compareChartCard', icon: '📊', ko: '보고서 비교', en: 'Report Comparison' },
    { id: 'compareTableCard', icon: '📋', ko: '비교 테이블', en: 'Comparison Table' }
  ],
  details: [
    { id: 'buildingInfoCard', icon: '🏢', ko: '건물 정보', en: 'Building Info' },
    { id: 'endUseDetailCard', icon: '🔧', ko: '연료별 상세', en: 'Fuel Detail' },
    { id: 'zoneSummaryCard', icon: '🏠', ko: '존 요약', en: 'Zone Summary' },
    { id: 'comfortSummaryCard', icon: '🌡', ko: '쾌적 요약', en: 'Comfort Summary' }
  ]
};

function getCurrentTabSections() {
  const activeTab = document.querySelector('.tab-btn.active');
  if (!activeTab) return null;
  const tabName = activeTab.dataset.tab;
  if (tabName === 'compare') {
    const zoneSub = document.getElementById('cmpSub-zone');
    if (zoneSub && zoneSub.style.display !== 'none') {
      /* Zone comparison sub-tab: show the zone compare detail card */
      const detailCard = document.getElementById('zoneCompareDetailCard');
      const zoneName = document.getElementById('zoneCompareSelect')?.value || '';
      if (detailCard && zoneName) {
        return [
          { id: 'zoneCompareDetailCard', icon: '📊', ko: zoneName + ' — 존 비교', en: zoneName + ' — Zone Compare' }
        ];
      }
      return null;
    }
    return SECTION_NAV_CONFIG.compare;
  }
  return SECTION_NAV_CONFIG[tabName] || null;
}

function renderSectionNav() {
  const sections = getCurrentTabSections();
  const nav = document.getElementById('sectionNav');
  const panel = document.getElementById('sectionNavPanel');
  if (!sections || !nav || !panel) {
    if (nav) nav.classList.remove('visible');
    return;
  }
  nav.classList.add('visible');
  const isKo = currentLang === 'ko';
  let html = '';
  sections.forEach(s => {
    html += '<button class="section-nav-item" data-section="' + s.id + '" onclick="scrollToSection(\'' + s.id + '\')">';
    html += '<span class="nav-dot"></span>';
    html += '<span>' + s.icon + ' ' + (isKo ? s.ko : s.en) + '</span>';
    html += '</button>';
  });
  panel.innerHTML = html;
  updateSectionNavActive();
}

function toggleSectionNav() {
  sectionNavOpen = !sectionNavOpen;
  const panel = document.getElementById('sectionNavPanel');
  const toggle = document.getElementById('sectionNavToggle');
  if (panel) panel.classList.toggle('open', sectionNavOpen);
  if (toggle) toggle.innerHTML = sectionNavOpen ? '&#10005;' : '&#9776;';
}

function scrollToSection(id) {
  const el = document.getElementById(id);
  if (el) {
    const headerH = 60; // approximate header height
    const offset = 20;  // extra breathing room
    const y = el.getBoundingClientRect().top + window.scrollY - headerH - offset;
    window.scrollTo({ top: y, behavior: 'smooth' });
    // Highlight briefly
    el.style.transition = 'box-shadow .3s';
    el.style.boxShadow = '0 0 0 3px rgba(59,130,246,.3)';
    setTimeout(() => { el.style.boxShadow = ''; }, 1500);
  }
}

function updateSectionNavActive() {
  const sections = getCurrentTabSections();
  if (!sections) return;
  const items = document.querySelectorAll('.section-nav-item');
  let currentId = null;
  const threshold = 100; // pixels from top of viewport
  for (let i = sections.length - 1; i >= 0; i--) {
    const el = document.getElementById(sections[i].id);
    if (el && el.getBoundingClientRect().top <= threshold) {
      currentId = sections[i].id;
      break;
    }
  }
  items.forEach(item => {
    item.classList.toggle('active', item.dataset.section === currentId);
  });
}
</script>

<div class="section-nav" id="sectionNav">
  <div class="section-nav-panel" id="sectionNavPanel"></div>
  <button class="section-nav-toggle" id="sectionNavToggle" onclick="toggleSectionNav()" title="Section navigation">&#9776;</button>
</div>
<button class="scroll-top-btn" id="scrollTopBtn" onclick="window.scrollTo({top:0,behavior:'smooth'})" title="Scroll to top">&#8593;</button>
</body>
</html>
